<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>卓凌云的博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="卓凌云,web前端博客">
<meta property="og:type" content="website">
<meta property="og:title" content="卓凌云的博客">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="卓凌云的博客">
<meta property="og:description" content="卓凌云,web前端博客">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="卓凌云的博客">
<meta name="twitter:description" content="卓凌云,web前端博客">
  
    <link rel="alternative" href="/atom.xml" title="卓凌云的博客" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css">
  

</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">卓凌云的博客</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">make progress every day</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-20170206" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/12/08/20170206/" class="article-date">
  <time datetime="2016-12-07T16:00:00.000Z" itemprop="datePublished">2016-12-08</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/java/">java</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/12/08/20170206/">基于openstf minicap实现的屏幕投影客户端</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>上个文章介绍了stf项目，最后制作出来发现性能太差，研究了下性能瓶颈主要有两个：</p>
<ol>
<li>node服务器通过socket推出的数据在浏览器端回调函数中解析占用资源，因为频率太高；</li>
<li>浏览器端canvas太多绘制太频繁；<br>以开秒表为例，基本5台设备，一秒绘制一次，都不流畅，而且cpu内存占用都近100%。为此我也特地去提过<a href="https://github.com/openstf/stf/issues/497" target="_blank" rel="external">issue</a>，似乎也是表明b/s模式性能有限，只有尝试c/s模式。</li>
</ol>
<p>考虑到之前学过java swing。另外minicap项目是继续linux的，java跨平台编写客户端很方便，所以就用java来编写。最终项目和效果我已经放到<a href="https://github.com/larryzhuo/JavaMinicap" target="_blank" rel="external">github</a>上了。性能有了大幅度提升，21台设备100ms刷新一次，cpu只占用50%，内存只占用20%。</p>
<h3 id="minicap"><a href="#minicap" class="headerlink" title="minicap"></a>minicap</h3><p><a href="https://github.com/openstf/minicap" target="_blank" rel="external">minicap</a>是openstf组织开源的另外一个项目，是用于stf项目获取屏幕截图的一个ndk库<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">adb forward tcp:1313 localabstract:minicap</div><div class="line">adb shell LD_LIBRARY_PATH=/data/<span class="built_in">local</span>/tmp /data/<span class="built_in">local</span>/tmp/minicap -P 1080x1920@1080x1920/0 -t</div></pre></td></tr></table></figure></p>
<p>abd forward命令将手机中的minicap生成的数据映射到电脑端的tcp 1313接口。java的socket就是基于Tcp协议的，所以创建socket客户端监听1313端口就可以获取到minicap输出的屏幕数据。<br>这种数据的协议，minicap也定出来了，就不多说了，贴下我的java解析代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.awt.image.BufferedImage;</div><div class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</div><div class="line"><span class="keyword">import</span> java.io.File;</div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"><span class="keyword">import</span> java.io.InputStream;</div><div class="line"><span class="keyword">import</span> java.net.Socket;</div><div class="line"></div><div class="line"><span class="keyword">import</span> javax.imageio.ImageIO;</div><div class="line"></div><div class="line"><span class="keyword">import</span> main.MainFrame;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SelfParse</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</div><div class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX_FRAME = <span class="number">50000</span>;</div><div class="line">	<span class="keyword">private</span> BufferedImage bi1;</div><div class="line">	<span class="keyword">private</span> String serial;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">int</span> port;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">SelfParse</span><span class="params">(String serial, <span class="keyword">int</span> port)</span></span>&#123;			<span class="comment">//startConnect函数一直没有结束，所以SelfParse实例一直为null</span></div><div class="line">		<span class="keyword">this</span>.bi1 = <span class="keyword">new</span> BufferedImage(MainFrame.AREA_WIDTH, MainFrame.AREA_HEIGHT, BufferedImage.TYPE_INT_RGB);</div><div class="line">		<span class="keyword">this</span>.serial = serial;</div><div class="line">		<span class="keyword">this</span>.port = port;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;			<span class="comment">//startConnect一直执行不完，所以需要单独一个线程来处理；否则会阻塞主线程</span></div><div class="line">		<span class="comment">// TODO Auto-generated method stub</span></div><div class="line">		startConnect();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 拷贝数组</div><div class="line">	 * 返回下次该插入的index</div><div class="line">	 * <span class="doctag">@param</span> sour</div><div class="line">	 * <span class="doctag">@param</span> dest</div><div class="line">	 * <span class="doctag">@param</span> sourSt　原数组开始index</div><div class="line">	 * <span class="doctag">@param</span> destSt 目标数组开始index</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">copyByteArray</span><span class="params">(<span class="keyword">byte</span>[] sour, <span class="keyword">byte</span>[] dest, <span class="keyword">int</span> sourSt, <span class="keyword">int</span> sourEn, <span class="keyword">int</span> destSt)</span></span>&#123;</div><div class="line">		<span class="keyword">int</span> k=<span class="number">0</span>;</div><div class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i=sourSt; i&lt;=sourEn; i++)&#123;</div><div class="line">			<span class="keyword">if</span>(destSt+k &gt;= dest.length) <span class="keyword">continue</span>;</div><div class="line">			dest[destSt+k] = sour[i];</div><div class="line">			k++;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> destSt+k;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startConnect</span><span class="params">()</span></span>&#123;</div><div class="line">		Socket socket;</div><div class="line">		<span class="keyword">int</span> actualFrameSize = <span class="number">0</span>;					<span class="comment">//记录每个ｆｒａｍｅ的实际大小</span></div><div class="line">		<span class="keyword">byte</span>[] frameArr = <span class="keyword">new</span> <span class="keyword">byte</span>[MAX_FRAME];</div><div class="line">		<span class="keyword">boolean</span> HEAD_ONCE_FLAG = <span class="keyword">true</span>;</div><div class="line">		</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			<span class="comment">//create a local forward，把minicap中的数据转发到pc机1313接口</span></div><div class="line">			Util.runCommand(Util.ADB+<span class="string">" -s "</span>+<span class="keyword">this</span>.serial+<span class="string">" forward tcp:"</span>+<span class="keyword">this</span>.port+<span class="string">" localabstract:minicap"</span>);</div><div class="line">			<span class="comment">//start minicap</span></div><div class="line">			Util.runCommand(Util.ADB+<span class="string">" -s "</span>+<span class="keyword">this</span>.serial+<span class="string">" shell LD_LIBRARY_PATH=/data/local/tmp /data/local/tmp/minicap -P 1080x1920@"</span>+MainFrame.AREA_WIDTH+<span class="string">"x"</span>+MainFrame.AREA_HEIGHT+<span class="string">"/0"</span>);</div><div class="line">			</div><div class="line">			<span class="comment">//创建socket连接</span></div><div class="line">			socket = <span class="keyword">new</span> Socket(<span class="string">"127.0.0.1"</span>, <span class="keyword">this</span>.port);</div><div class="line">			System.out.println(<span class="keyword">this</span>.port+<span class="string">"端口连接成功"</span>);</div><div class="line">			InputStream is = socket.getInputStream();</div><div class="line">			<span class="keyword">byte</span>[] bytes = <span class="keyword">new</span> <span class="keyword">byte</span>[Util.FRAME_SIZE];</div><div class="line">			<span class="keyword">byte</span>[] fourbts = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">4</span>];</div><div class="line">			<span class="keyword">int</span> hasread = <span class="number">0</span>, destSt = <span class="number">0</span>;</div><div class="line">			<span class="keyword">while</span>((hasread = is.read(bytes)) &gt; <span class="number">0</span>)&#123;</div><div class="line">				<span class="keyword">if</span>(HEAD_ONCE_FLAG)&#123;		<span class="comment">//第一次只接收header,bytes[24]为空</span></div><div class="line">					HEAD_ONCE_FLAG = <span class="keyword">false</span>;</div><div class="line">				&#125; <span class="keyword">else</span> &#123;			<span class="comment">//不是第一次发送，就不含有ｈｅａｄｅｒ，头四个字节直接表示Frame size</span></div><div class="line">					<span class="keyword">if</span>(destSt &lt;= <span class="number">0</span>)&#123;</div><div class="line">						fourbts[<span class="number">0</span>] = bytes[<span class="number">3</span>];</div><div class="line">						fourbts[<span class="number">1</span>] = bytes[<span class="number">2</span>];</div><div class="line">						fourbts[<span class="number">2</span>] = bytes[<span class="number">1</span>];</div><div class="line">						fourbts[<span class="number">3</span>] = bytes[<span class="number">0</span>];</div><div class="line">						actualFrameSize = Util.bytes2int(fourbts);</div><div class="line">						<span class="keyword">if</span>(actualFrameSize &gt; MAX_FRAME || actualFrameSize &lt;= <span class="number">0</span>)</div><div class="line">							<span class="keyword">continue</span>;</div><div class="line">						destSt = <span class="keyword">this</span>.copyByteArray(bytes, frameArr, <span class="number">4</span>, hasread-<span class="number">1</span>, <span class="number">0</span>);</div><div class="line">						</div><div class="line">					&#125; <span class="keyword">else</span> &#123;</div><div class="line">						destSt = <span class="keyword">this</span>.copyByteArray(bytes, frameArr, <span class="number">0</span>, hasread-<span class="number">1</span>, destSt);</div><div class="line">						<span class="keyword">if</span>(destSt &gt;= actualFrameSize)&#123;		<span class="comment">//已经记录完成一帧</span></div><div class="line">							ByteArrayInputStream bais = <span class="keyword">new</span> ByteArrayInputStream(frameArr, <span class="number">0</span>, actualFrameSize-<span class="number">1</span>);      </div><div class="line">							<span class="keyword">this</span>.bi1 =ImageIO.read(bais);</div><div class="line">							bais.close();</div><div class="line">							destSt = <span class="number">0</span>;</div><div class="line">						&#125;</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">			<span class="comment">// TODO Auto-generated catch block</span></div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">public</span> BufferedImage <span class="title">getFrame</span><span class="params">()</span></span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.bi1;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>minicap发送数据分为如下部分:</p>
<ol>
<li>header部分socket连接成功之后只发送一次，包含24byte。</li>
<li>以后每次发送frame数据。每个frame包含4byte的头部信息，表示frame size。<br>4byte总共32位，minicap用c++编写，使用的是uint。所以最大会有2^32个byte大小的frame。这在java中只有用long来存储，但是这显然太消耗内存。为了提升性能，最后1080x1920的屏幕肯定要压缩，这里最终选择压缩到180x320。观察下180x320这种大小下frame size大概在10000byte左右。所以完全可以用int来表示，这里最终每个frame的size大小变量actualFrameSize就是int类型。<br>对应的存储帧数据的byte[] frameArr也可以设置一个长度为50000，这样保证了完全足够存储下每个frame数据。<br>最终在每帧数据结束时(destSt &gt;= actualFrameSize)生成bufferImage输出，就得到了屏幕数据。</li>
</ol>
<p>另外起一个读取线程，可以控制读取bufferImage的频率</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/12/08/20170206/" data-id="ciyvlrhpi002qocvrjjb7lt6m" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/">java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/minicap/">minicap</a></li></ul>

    </footer>
  </div>
  
</article>




  
    <article id="post-20161208" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/12/08/20161208/" class="article-date">
  <time datetime="2016-12-07T16:00:00.000Z" itemprop="datePublished">2016-12-08</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/node/">node</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/12/08/20161208/">stf源码解读</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="stf源码解读"><a href="#stf源码解读" class="headerlink" title="stf源码解读"></a>stf源码解读</h3><p>stf（smartphone test farm）是一个开源的远程调试工具，这个项目使用到了很多组件如屏幕信息的minicap，屏幕触控的minitouch，消息传递的zeromq等等，非常复杂。简要记录下自己二次开发的过程，值得注意的是整个项目主要就是两个开发者，而且开放了一批周边插件，很厉害。<br>这个项目是B/S模式，浏览器端使用的是angular1+jade编写，服务器端采用的node，构建工具使用的是webpack+gulp。安装环境要求是linux或者mac，我第一次配置感觉还挺复杂，可以看下<a href="https://testerhome.com/topics/2988" target="_blank" rel="external">这篇文章</a>。我们的需求是将#/controls页面中的Devices tab的内容换成屏幕数据的直接展示，这其中遇到了机器bios连接数和多个canvas绘制的性能问题。可以看下我在github上面提的两个issue：</p>
<ol>
<li><a href="https://github.com/openstf/stf/issues/489" target="_blank" rel="external">Not enough host controller resources for new device #489</a></li>
<li><a href="https://github.com/openstf/stf/issues/497" target="_blank" rel="external">A performance issue after i change some code #497</a><br>解决方式我后面会阐述，先看下最终的效果图<br><img src="http://ww1.sinaimg.cn/mw690/a5e2541bgw1fafycurub8j21kw0vywwx.jpg"><br><img src="http://ww4.sinaimg.cn/mw690/a5e2541bgw1fafycvajzkj21kw0vy7jy.jpg"><br><img src="http://ww1.sinaimg.cn/mw690/a5e2541bgw1fafycu3csnj21kw0vy1bi.jpg"><br>功能繁多，我以我如何实现需求进行说明。</li>
</ol>
<h3 id="前端代码"><a href="#前端代码" class="headerlink" title="前端代码"></a>前端代码</h3><p>所有的前端代码在stf/res目录下，后端代码都在stf/lib目录下。我们能快速找到入口js文件res/app/app.js。但是却没有找到入口页面，为什么呢。因为首页是服务器端输出的。在lib/units/app/index.js中可以看到一个典型的express node服务器的代码<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">app.set(<span class="string">'view engine'</span>, <span class="string">'pug'</span>)</div><div class="line">app.set(<span class="string">'views'</span>, pathutil.resource(<span class="string">'app/views'</span>))      <span class="comment">//设置views变量，指定视图存放的目录</span></div><div class="line">app.set(<span class="string">'strict routing'</span>, <span class="literal">true</span>)</div><div class="line">app.set(<span class="string">'case sensitive routing'</span>, <span class="literal">true</span>)</div><div class="line">app.set(<span class="string">'trust proxy'</span>, <span class="literal">true</span>)</div><div class="line"><span class="comment">/**/</span></div><div class="line">app.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</div><div class="line">    res.render(<span class="string">'index'</span>)</div><div class="line">&#125;)</div></pre></td></tr></table></figure></p>
<p>设置了模板引擎是pug(jade改名而来)，设置模板存放位置在app/views,设置默认情况下render index（也就是app/views/index.pug）。入口找到了，接下来就看路由设置，熟悉过angular1的人应该都知道路由的定义是要用到$routeProvider的。我们要修改的页面路由是<a href="http://localhost:7100/#!/devices。" target="_blank" rel="external">http://localhost:7100/#!/devices。</a> 然而在app.js中我们看到了这段路由定义<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"> .config(<span class="function"><span class="keyword">function</span>(<span class="params">$routeProvider, $locationProvider</span>) </span>&#123;</div><div class="line">  $locationProvider.hashPrefix(<span class="string">'!'</span>)</div><div class="line">  $routeProvider</div><div class="line">    .otherwise(&#123;</div><div class="line">      <span class="attr">redirectTo</span>: <span class="string">'/devices'</span></div><div class="line">    &#125;)</div><div class="line">&#125;)</div></pre></td></tr></table></figure></p>
<p>这里并没有如我所想的$routeProvider.when(‘devices’)。其实这个配置被分到了每个模块之中，比如定义devices路由的在app/device-list/index.js中。相应的也看到了这个路由对象的template和controller<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">.config([<span class="string">'$routeProvider'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">$routeProvider</span>) </span>&#123;</div><div class="line">  $routeProvider</div><div class="line">    .when(<span class="string">'/devices'</span>, &#123;</div><div class="line">      <span class="attr">template</span>: <span class="built_in">require</span>(<span class="string">'./device-list.pug'</span>),</div><div class="line">      <span class="attr">controller</span>: <span class="string">'DeviceListCtrl'</span></div><div class="line">    &#125;)</div><div class="line">&#125;])</div></pre></td></tr></table></figure></p>
<p>前端代码的架构大概就是这样，分出了很多模块，每个模块中包含了路由配置，模板文件，controller文件，service文件等等。</p>
<h3 id="后端代码"><a href="#后端代码" class="headerlink" title="后端代码"></a>后端代码</h3><p>前面说了，后端代码都在stf/lib目录下，一般启动stf服务器用的是node bin/stf local。顺着bin/stf文件很轻易找到cli.js。这个文件很重要，使用command.js定义了大量的node命令，这些命令又调用util/procutil.js创建大量进程。我们先看local参数，它的代码太长就不列出来了，可以看出它新建了如下进程，其中app值得app一侧消息处理的进程；dev指是device一侧消息的处理进程：<br>1.’triproxy’, ‘app001’<br>2.’triproxy’, ‘dev001’<br>3.’processor’, ‘proc001’<br>4.’processor’, ‘proc002’<br>5.’reaper’, ‘reaper001’<br>6.’provider’<br>7.auth<br>8.’app’<br>9.’api’<br>10.’websocket’<br>11.’storage’<br>12.’storage-plugin-apk’<br>13.’poorxy’<br>看到这里我就蒙了，还要在github上找了这张结构图，顺着结构图看才能看明白<br><img src="http://ww4.sinaimg.cn/mw690/a5e2541bgw1fajhxkjr4hj20lo0rmdi0.jpg"></p>
<p>以这个场景为例：browser中路由#/control页面中显示手机屏幕画面，滑动屏幕画面，真实设备的画面也随之改变。<br>1.找到该页面对应的模板是app/control-panes/device-control/device-control.pug。<br>2.找到屏幕显示部分是一个device-screen(device=’device’, control=’control’)的指令<br>3.在app/components/screen/screen-directive.js定义了device-screen.可以看到它就是一个canvas。另外在这个指令中使用了websocket连接到服务器端的socket<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> ws = <span class="keyword">new</span> WebSocket(device.display.url)</div><div class="line">ws.binaryType = <span class="string">'blob'</span></div><div class="line"><span class="comment">/****/</span></div><div class="line">ws.onmessage = (<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="comment">/**/</span></div><div class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">messageListener</span>(<span class="params">message</span>) </span>&#123;</div><div class="line">        screen.rotation = device.display.rotation</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (message.data <span class="keyword">instanceof</span> Blob) &#123;</div><div class="line">          <span class="keyword">if</span> (shouldUpdateScreen()) &#123;</div><div class="line">            <span class="keyword">if</span> (scope.displayError) &#123;</div><div class="line">              scope.$apply(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">                scope.displayError = <span class="literal">false</span></div><div class="line">              &#125;)</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">var</span> blob = <span class="keyword">new</span> Blob([message.data], &#123;</div><div class="line">              <span class="attr">type</span>: <span class="string">'image/jpeg'</span></div><div class="line">            &#125;)</div><div class="line"></div><div class="line">            <span class="keyword">var</span> img = imagePool.next()</div><div class="line"></div><div class="line">            img.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">              updateImageArea(<span class="keyword">this</span>)</div><div class="line"></div><div class="line">              g.drawImage(img, <span class="number">0</span>, <span class="number">0</span>, img.width, img.height)</div><div class="line"></div><div class="line">              <span class="comment">// Try to forcefully clean everything to get rid of memory</span></div><div class="line">              <span class="comment">// leaks. Note that despite this effort, Chrome will still</span></div><div class="line">              <span class="comment">// leak huge amounts of memory when the developer tools are</span></div><div class="line">              <span class="comment">// open, probably to save the resources for inspection. When</span></div><div class="line">              <span class="comment">// the developer tools are closed no memory is leaked.</span></div><div class="line">              img.onload = img.onerror = <span class="literal">null</span></div><div class="line">              img.src = BLANK_IMG</div><div class="line">              img = <span class="literal">null</span></div><div class="line">              blob = <span class="literal">null</span></div><div class="line"></div><div class="line">              URL.revokeObjectURL(url)</div><div class="line">              url = <span class="literal">null</span></div><div class="line">            &#125;</div><div class="line"></div><div class="line">            img.onerror = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">              <span class="comment">// Happily ignore. I suppose this shouldn't happen, but</span></div><div class="line">              <span class="comment">// sometimes it does, presumably when we're loading images</span></div><div class="line">              <span class="comment">// too quickly.</span></div><div class="line"></div><div class="line">              <span class="comment">// Do the same cleanup here as in onload.</span></div><div class="line">              img.onload = img.onerror = <span class="literal">null</span></div><div class="line">              img.src = BLANK_IMG</div><div class="line">              img = <span class="literal">null</span></div><div class="line">              blob = <span class="literal">null</span></div><div class="line"></div><div class="line">              URL.revokeObjectURL(url)</div><div class="line">              url = <span class="literal">null</span></div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">var</span> url = URL.createObjectURL(blob)</div><div class="line">            img.src = url</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (<span class="regexp">/^start /</span>.test(message.data)) &#123;</div><div class="line">          applyQuirks(<span class="built_in">JSON</span>.parse(message.data.substr(<span class="string">'start '</span>.length)))</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (message.data === <span class="string">'secure_on'</span>) &#123;</div><div class="line">          scope.$apply(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">            scope.displayError = <span class="string">'secure'</span></div><div class="line">          &#125;)</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>实际连接多台设备的时候显示每个device.display.url是不同的，其实是每台设备对应对应一个线程，这样是有道理的，多个不同的port有利于突破浏览器的同域下请求数量的限制，提高数据传输量。在onmessage也能看到大量的内存优化，提高垃圾回收效率，传输的blob数据就是屏幕数据，使用windowURL类创建bloburl，然后使用canvas drawImage绘制在画布。</p>
<p>那服务器端怎么建立起websocket服务器端呢？<br>直接看到cli.js启动的provider进程，这个代码在lib/units/provider/index.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> client = adb.createClient(&#123;</div><div class="line">  <span class="attr">host</span>: options.adbHost</div><div class="line">, <span class="attr">port</span>: options.adbPort</div><div class="line">&#125;)</div><div class="line"><span class="comment">/**********/</span></div><div class="line">client.trackDevices().then(<span class="function"><span class="keyword">function</span>(<span class="params">tracker</span>) </span>&#123;</div><div class="line">  <span class="comment">/**********/</span></div><div class="line">  tracker.on(<span class="string">'add'</span>, filterDevice(<span class="function"><span class="keyword">function</span>(<span class="params">device</span>) </span>&#123;</div><div class="line">    <span class="comment">/**********/</span></div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">spawn</span>(<span class="params"></span>) </span>&#123;</div><div class="line">      <span class="comment">/**********/</span></div><div class="line">      <span class="keyword">var</span> allocatedPorts = ports.splice(<span class="number">0</span>, <span class="number">4</span>)</div><div class="line">      <span class="keyword">var</span> proc = options.fork(device, allocatedPorts.slice())</div><div class="line">      <span class="keyword">var</span> resolver = <span class="built_in">Promise</span>.defer()</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  tracker.on(<span class="string">'change'</span>, filterDevice(<span class="function"><span class="keyword">function</span>(<span class="params">device</span>) </span>&#123;</div><div class="line">    flippedTracker.emit(device.id, <span class="string">'change'</span>, device)</div><div class="line">  &#125;))</div><div class="line"></div><div class="line">  tracker.on(<span class="string">'remove'</span>, filterDevice(<span class="function"><span class="keyword">function</span>(<span class="params">device</span>) </span>&#123;</div><div class="line">    flippedTracker.emit(device.id, <span class="string">'remove'</span>, device)</div><div class="line">  &#125;))</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><a href="https://github.com/openstf/adbkit" target="_blank" rel="external">adbkit</a>是openstf开源的一个adb的nodejs client。client.trackDevices这个api就可以监听设备的plug和unplug消息。所以这里新设备插入之后会fork出一个新的进程，而这个命令的定义就在cli.js中的’device <serial>‘。这个进程代码就在lib/units/device/index.js。这个文件夹下包含了大量的代码，与屏幕数据相关的代码就在/deivce/screen/stream.js。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">createServer</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="comment">/**************/</span></div><div class="line">  <span class="keyword">var</span> wss = <span class="keyword">new</span> WebSocket.Server(&#123;</div><div class="line">    <span class="attr">port</span>: screenOptions.publicPort</div><div class="line">  , <span class="attr">perMessageDeflate</span>: <span class="literal">false</span></div><div class="line">  &#125;)</div><div class="line">&#125;</div><div class="line"><span class="keyword">return</span> createServer()</div><div class="line">  .then(<span class="function"><span class="keyword">function</span>(<span class="params">wss</span>) </span>&#123;</div><div class="line">    <span class="comment">/************/</span></div><div class="line">    wss.on(<span class="string">'connection'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">ws</span>) </span>&#123;</div><div class="line">      <span class="comment">/************/</span></div><div class="line">      <span class="function"><span class="keyword">function</span> <span class="title">wsFrameNotifier</span>(<span class="params">frame</span>) </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve, reject</span>) </span>&#123;</div><div class="line">          <span class="keyword">switch</span> (ws.readyState) &#123;</div><div class="line">          <span class="keyword">case</span> WebSocket.OPENING:</div><div class="line">            <span class="comment">// This should never happen.</span></div><div class="line">            <span class="keyword">return</span> reject(<span class="keyword">new</span> <span class="built_in">Error</span>(util.format(</div><div class="line">              <span class="string">'Unable to send frame to OPENING client "%s"'</span>, id)))</div><div class="line">          <span class="keyword">case</span> WebSocket.OPEN:</div><div class="line">            <span class="comment">// This is what SHOULD happen.</span></div><div class="line">            ws.send(frame, &#123;</div><div class="line">              <span class="attr">binary</span>: <span class="literal">true</span></div><div class="line">            &#125;, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</div><div class="line">              <span class="keyword">return</span> err ? reject(err) : resolve()</div><div class="line">            &#125;)</div><div class="line">            <span class="keyword">return</span></div><div class="line">          <span class="keyword">case</span> WebSocket.CLOSING:</div><div class="line">            <span class="comment">// Ok, a 'close' event should remove the client from the set</span></div><div class="line">            <span class="comment">// soon.</span></div><div class="line">            <span class="keyword">return</span></div><div class="line">          <span class="keyword">case</span> WebSocket.CLOSED:</div><div class="line">            <span class="comment">// This should never happen.</span></div><div class="line">            broadcastSet.remove(id)</div><div class="line">            <span class="keyword">return</span> reject(<span class="keyword">new</span> <span class="built_in">Error</span>(util.format(</div><div class="line">              <span class="string">'Unable to send frame to CLOSED client "%s"'</span>, id)))</div><div class="line">          &#125;</div><div class="line">        &#125;)</div><div class="line">      &#125;</div><div class="line">      ws.on(<span class="string">'message'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</div><div class="line">          <span class="keyword">var</span> match = <span class="regexp">/^(on|off|(size) ([0-9]+)x([0-9]+))$/</span>.exec(data)</div><div class="line">          <span class="keyword">if</span> (match) &#123;</div><div class="line">            <span class="keyword">switch</span> (match[<span class="number">2</span>] || match[<span class="number">1</span>]) &#123;</div><div class="line">            <span class="keyword">case</span> <span class="string">'on'</span>:</div><div class="line">              broadcastSet.insert(id, &#123;</div><div class="line">                <span class="attr">onStart</span>: wsStartNotifier</div><div class="line">              , <span class="attr">onFrame</span>: wsFrameNotifier</div><div class="line">              &#125;)</div><div class="line">              <span class="keyword">break</span></div><div class="line">            <span class="keyword">case</span> <span class="string">'off'</span>:</div><div class="line">              broadcastSet.remove(id)</div><div class="line">              <span class="keyword">break</span></div><div class="line">            <span class="keyword">case</span> <span class="string">'size'</span>:</div><div class="line">              frameProducer.updateProjection(</div><div class="line">                <span class="built_in">Number</span>(match[<span class="number">3</span>]), <span class="built_in">Number</span>(match[<span class="number">4</span>]))</div><div class="line">              <span class="keyword">break</span></div><div class="line">            &#125;</div><div class="line">          &#125;</div><div class="line">        &#125;)</div><div class="line">    &#125;</div><div class="line">  &#125;);</div></pre></td></tr></table></figure></serial></p>
<p>代码太多我就不全列举出来了，这里就是建立了WebSocketServer与前面device-screen中的连接一一对应。发送的on，size，off等消息与这里onmessage正好也对应。broadcastSet用于距离多个连接的数据。wsFrameNotifier中ws.send(frame)就是将数据推送到device-screen中，画面也就在canvas中显示出来了</p>
<p>上面解释了画面怎么显示出来，再来看看滑动画面是怎么传递消息的：<br>前端代码还是在screen-directive.js中，直接找到mouseMoveListener<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**********/</span></div><div class="line">control.touchMove(nextSeq(), <span class="number">0</span>, scaled.xP, scaled.yP, pressure)</div><div class="line"></div><div class="line"><span class="keyword">if</span> (addGhostFinger) &#123;</div><div class="line">  control.touchDown(nextSeq(), <span class="number">1</span>, <span class="number">1</span> - scaled.xP, <span class="number">1</span> - scaled.yP, pressure)</div><div class="line">&#125;</div><div class="line"><span class="keyword">else</span> <span class="keyword">if</span> (deleteGhostFinger) &#123;</div><div class="line">  control.touchUp(nextSeq(), <span class="number">1</span>)</div><div class="line">&#125;</div><div class="line"><span class="keyword">else</span> <span class="keyword">if</span> (fakePinch) &#123;</div><div class="line">  control.touchMove(nextSeq(), <span class="number">1</span>, <span class="number">1</span> - scaled.xP, <span class="number">1</span> - scaled.yP, pressure)</div><div class="line">&#125;</div><div class="line"></div><div class="line">control.touchCommit(nextSeq())</div></pre></td></tr></table></figure></p>
<p>这个地方的control是control-service:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*************/</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">sendOneWay</span>(<span class="params">action, data</span>) </span>&#123;</div><div class="line">  socket.emit(action, channel, data)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">sendTwoWay</span>(<span class="params">action, data</span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> tx = TransactionService.create(target)</div><div class="line">  socket.emit(action, channel, tx.channel, data)</div><div class="line">  <span class="keyword">return</span> tx.promise</div><div class="line">&#125;</div><div class="line"><span class="comment">/*************/</span></div><div class="line"><span class="keyword">this</span>.touchMove = <span class="function"><span class="keyword">function</span>(<span class="params">seq, contact, x, y, pressure</span>) </span>&#123;</div><div class="line">  sendOneWay(<span class="string">'input.touchMove'</span>, &#123;</div><div class="line">    <span class="attr">seq</span>: seq</div><div class="line">  , <span class="attr">contact</span>: contact</div><div class="line">  , <span class="attr">x</span>: x</div><div class="line">  , <span class="attr">y</span>: y</div><div class="line">  , <span class="attr">pressure</span>: pressure</div><div class="line">  &#125;)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里的socket是res/app/components/stf/socket/index.js中的socket-service。socket-service中使用socket.io。不同于screen-directive中使用的ws，这两种都是websocket通信的实现，ws模块更加贴近原生js语法。而socket.io则有自己的一套api，socket.emit就是客户端发送消息的api，而node端创建这个socketserver的代码则在lib/units/websocket/index.js中，可以很顺利的在socket.io的监听函数中找到touchMove信息监听。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> push = zmqutil.socket(<span class="string">'push'</span>)</div><div class="line"></div><div class="line"><span class="comment">/***********/</span></div><div class="line">.on(<span class="string">'input.touchMove'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">channel, data</span>) </span>&#123;</div><div class="line">  push.send([</div><div class="line">    channel</div><div class="line">  , wireutil.envelope(<span class="keyword">new</span> wire.TouchMoveMessage(</div><div class="line">      data.seq</div><div class="line">    , data.contact</div><div class="line">    , data.x</div><div class="line">    , data.y</div><div class="line">    , data.pressure</div><div class="line">    ))</div><div class="line">  ])</div><div class="line">&#125;)</div></pre></td></tr></table></figure></p>
<p>在这里可以看到push socket的消息发送,这已经使用到了zeromq了，有时间另外详细讲解，我们回头看上面贴出来的stf的架构图，现在顺着看下流程。websocket进程中的push将数据推送到triproxy进程的pull中。看下lib/units/triproxy/index.js中的相关代码。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">proxy</span>(<span class="params">to</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    to.send([].slice.call(<span class="built_in">arguments</span>))         <span class="comment">//pub分发消息</span></div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// App/device output</span></div><div class="line"><span class="keyword">var</span> pub = zmqutil.socket(<span class="string">'pub'</span>)     <span class="comment">//订阅模式</span></div><div class="line">pub.bindSync(options.endpoints.pub)       <span class="comment">//http://www.cnblogs.com/dvwei/p/3608119.html。pubber绑定一个接口，等待subber的connect</span></div><div class="line">log.info(<span class="string">'PUB socket bound on'</span>, options.endpoints.pub)</div><div class="line"></div><div class="line"><span class="comment">// Coordinator input/output</span></div><div class="line"><span class="keyword">var</span> dealer = zmqutil.socket(<span class="string">'dealer'</span>)     <span class="comment">//dealer是一种更高级的 请求/应答（client/server） 的socket type。它可以自由的收发消息，没有ZMQ_REP/ZMQ_REQ那样的限制。对于每一个连接，接收消息也是使用了公平队列，发送使用了循环队列（RR）。</span></div><div class="line">dealer.bindSync(options.endpoints.dealer)</div><div class="line">dealer.on(<span class="string">'message'</span>, proxy(pub))</div><div class="line">log.info(<span class="string">'DEALER socket bound on'</span>, options.endpoints.dealer)</div><div class="line"></div><div class="line"><span class="comment">// App/device input</span></div><div class="line"><span class="keyword">var</span> pull = zmqutil.socket(<span class="string">'pull'</span>)     <span class="comment">//管道模式</span></div><div class="line">pull.bindSync(options.endpoints.pull)</div><div class="line">pull.on(<span class="string">'message'</span>, proxy(dealer))</div><div class="line">log.info(<span class="string">'PULL socket bound on'</span>, options.endpoints.pull)</div></pre></td></tr></table></figure></p>
<p>pull socket收到消息之后又会调用proxy方法用dealer socket将消息传递出去，对应上图，这个消息被processor进程中的dealer处理了，看下lib/units/processor/index.js相关代码：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> appDealer = zmqutil.socket(<span class="string">'dealer'</span>)</div><div class="line"><span class="comment">/***************/</span></div><div class="line"><span class="keyword">var</span> devDealer = zmqutil.socket(<span class="string">'dealer'</span>)</div><div class="line"></div><div class="line">appDealer.on(<span class="string">'message'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">channel, data</span>) </span>&#123;</div><div class="line">  devDealer.send([channel, data])</div><div class="line">&#125;)</div><div class="line"></div><div class="line">devDealer.on(<span class="string">'message'</span>, wirerouter()</div><div class="line">  .on(<span class="string">''</span>)</div></pre></td></tr></table></figure></p>
<p>processor中包含appDealer和devDealer两种socket。考虑到这不是设备端的消息，另外在devDealer的处理中也并没有看到对touchMove消息的处理，所以这里touchMove的消息是appDealer socket接收，devDealer socket发送出去；看图可以发现消息又被triproxy进程处理，这次是其中的dealer socket处理消息，它又将消息从pub socket中转发出来。这时候又被provider进程和provider创建的一批device子进程处理这批消息。<br>可以在lib/units/device/touch/index.js中最终找到，这个消息的处理<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">router</div><div class="line">  <span class="comment">/*********/</span></div><div class="line">  .on(wire.TouchMoveMessage, <span class="function"><span class="keyword">function</span>(<span class="params">channel, message</span>) </span>&#123;</div><div class="line">    queue.push(message.seq, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">      touchConsumer.touchMove(message)</div><div class="line">    &#125;)</div><div class="line">  &#125;)</div></pre></td></tr></table></figure></p>
<p>简要的说了下我的理解，至于开头需求的实现，下一篇再讲</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/12/08/20161208/" data-id="ciyvlrhpg002oocvr39qnybx8" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/node/">node</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/stf/">stf</a></li></ul>

    </footer>
  </div>
  
</article>




  
    <article id="post-20161125" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/11/25/20161125/" class="article-date">
  <time datetime="2016-11-24T16:00:00.000Z" itemprop="datePublished">2016-11-25</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/js/">js</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/11/25/20161125/">私有变量与私有方法实现</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="js类中私有变量与私有方法的实现"><a href="#js类中私有变量与私有方法的实现" class="headerlink" title="js类中私有变量与私有方法的实现"></a>js类中私有变量与私有方法的实现</h3><p>今天详细了解了下这方面的，算是做个记录</p>
<h4 id="es5中实现"><a href="#es5中实现" class="headerlink" title="es5中实现"></a>es5中实现</h4><p>主要还是使用闭包实现，Object.defineProperty不能实现。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> People = (<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">	<span class="function"><span class="keyword">function</span> <span class="title">privateFunc</span>(<span class="params"></span>)</span>&#123;</div><div class="line">		<span class="built_in">console</span>.log(<span class="string">'privateFunc'</span>)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">var</span> privateVar = <span class="string">'privateVar'</span>;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">function</span> <span class="title">People</span>(<span class="params"></span>)</span>&#123;</div><div class="line">		<span class="keyword">this</span>.publicVar = <span class="string">'1'</span>;</div><div class="line">	&#125;</div><div class="line">	People.prototype.publicFunc = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">		privateFunc.call(<span class="keyword">this</span>);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> People;</div><div class="line">&#125;)()</div><div class="line"></div><div class="line"><span class="keyword">var</span> people = <span class="keyword">new</span> People();</div><div class="line"><span class="built_in">Object</span>.keys(people);		<span class="comment">//['publicVar']</span></div><div class="line">people.publicFunc();		<span class="comment">//'private test'</span></div></pre></td></tr></table></figure></p>
<h4 id="es6中实现"><a href="#es6中实现" class="headerlink" title="es6中实现"></a>es6中实现</h4><p>采用闭包+symbol实现<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> People = (<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">	<span class="keyword">var</span> s1 = <span class="built_in">Symbol</span>(<span class="string">'privatekey'</span>);</div><div class="line">	<span class="keyword">var</span> s2 = <span class="built_in">Symbol</span>(<span class="string">'privatekey'</span>)</div><div class="line"></div><div class="line">	<span class="class"><span class="keyword">class</span> <span class="title">People</span></span>&#123;</div><div class="line">		<span class="keyword">constructor</span>()&#123;</div><div class="line">			<span class="keyword">this</span>[s1] = <span class="function"><span class="params">()</span> =&gt;</span> &#123;<span class="built_in">console</span>.log(<span class="string">'privateFunc'</span>)&#125;;</div><div class="line">			<span class="keyword">this</span>[s2] = <span class="string">'privateVar'</span>;</div><div class="line">		&#125;</div><div class="line">		publicFunc()&#123;</div><div class="line">			<span class="built_in">console</span>.log(<span class="keyword">this</span>[s1]());</div><div class="line">			<span class="built_in">console</span>.log(<span class="keyword">this</span>[s2]);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> People;</div><div class="line">&#125;)()</div><div class="line"></div><div class="line"><span class="keyword">var</span> people = <span class="keyword">new</span> People();</div><div class="line"><span class="built_in">Object</span>.keys(people);		<span class="comment">//['publicVar']</span></div><div class="line">people.publicFunc();		<span class="comment">//'private test'</span></div></pre></td></tr></table></figure></p>
<p>symbol是es新添加的一种数据类型（之前有六种：null, undefined, 数字，字符串，布尔，对象），每次都能生成一个唯一不同的值。它有一个很重要的特点：它虽然不是私有属性，但是不会出现在for…in,for…of循环中，也不会被Object.keys()、Object.getOwnPropertyNames()返回。所以直接定义在this上并不会被枚举到。<br>但是这也不是万无一失，有两个api可以查询到symbol属性：Object.getOwnPropertySymbols和Reflect.ownKeys。但是这基本能满足需求了<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">people[<span class="built_in">Object</span>.getOwnPropertySymbols(people)[<span class="number">0</span>]]();		<span class="comment">//'privateFunc'</span></div><div class="line">people[<span class="built_in">Object</span>.getOwnPropertySymbols(people)[<span class="number">1</span>]];		<span class="comment">//'privateVar'</span></div></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/11/25/20161125/" data-id="ciyvlrhp6002hocvrbp9kihxm" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/symbol/">symbol</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/闭包/">闭包</a></li></ul>

    </footer>
  </div>
  
</article>




  
    <article id="post-20161124" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/11/24/20161124/" class="article-date">
  <time datetime="2016-11-23T16:00:00.000Z" itemprop="datePublished">2016-11-24</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/redux/">redux</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/11/24/20161124/">react-redux源码解析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>react-redux与redux密切相关，建议看看前一篇redux源码解析，上一篇中还有一个redux api bindActionCreators没说，也在这里讲解；当然它的使用并不限于这里。你可以直接使用redux而不使用react-redux，因为redux作为flux思想的一种实现，你还可以和Angular，Ember等其他框架使用。如果要使用就要先理解下<a href="https://medium.com/@dan_abramov/smart-and-dumb-components-7ca2f9a7c7d0#.tg1l2k34b" target="_blank" rel="external">容器组件(container components)和展示组件(presentational components)的区别</a>。react-redux只export了两个方法Provider和connect</p>
<p>官方文档在这里： <a href="http://redux.js.org/docs/basics/UsageWithReact.html" target="_blank" rel="external">http://redux.js.org/docs/basics/UsageWithReact.html</a></p>
<h4 id="provider"><a href="#provider" class="headerlink" title="provider"></a>provider</h4><p>provider源码很简单。基本就是直接将props中的store放到context中传递给子组件，所以在子组件中可以在this.context中获取到store。这是<a href="https://facebook.github.io/react/docs/context.html" target="_blank" rel="external">context的基本用法</a>。贴一下provider的代码。不解释了<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">Provider</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</div><div class="line">  getChildContext() &#123;     <span class="comment">//https://facebook.github.io/react/docs/context.html  context provider</span></div><div class="line">    <span class="keyword">return</span> &#123; <span class="attr">store</span>: <span class="keyword">this</span>.store &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">constructor</span>(props, context) &#123;</div><div class="line">    <span class="keyword">super</span>(props, context)</div><div class="line">    <span class="keyword">this</span>.store = props.store      <span class="comment">//Provider接受了store props</span></div><div class="line">  &#125;</div><div class="line"></div><div class="line">  render() &#123;</div><div class="line">    <span class="keyword">return</span> Children.only(<span class="keyword">this</span>.props.children)</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</div><div class="line">  Provider.prototype.componentWillReceiveProps = <span class="function"><span class="keyword">function</span> (<span class="params">nextProps</span>) </span>&#123;</div><div class="line">    <span class="keyword">const</span> &#123; store &#125; = <span class="keyword">this</span></div><div class="line">    <span class="keyword">const</span> &#123; <span class="attr">store</span>: nextStore &#125; = nextProps</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (store !== nextStore) &#123;</div><div class="line">      warnAboutReceivingStore()</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">Provider.propTypes = &#123;</div><div class="line">  <span class="attr">store</span>: storeShape.isRequired,</div><div class="line">  <span class="attr">children</span>: PropTypes.element.isRequired</div><div class="line">&#125;</div><div class="line">Provider.childContextTypes = &#123;    <span class="comment">//将store暴露给子组件</span></div><div class="line">  store: storeShape.isRequired</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="connect"><a href="#connect" class="headerlink" title="connect"></a>connect</h4><p>connect方法的意义在于从展示组件生成容器组件。展示组件只有dom和style，不带有数据和逻辑，它的数据和逻辑需要从容器组件中获取，这样使得展示组件更加可复用。容器组件就是一个React组件，它使用store.subscribe()读取redux state tree中的一部分作为props传递给展示组件render，一旦它subscribe的这一部分state改变也同时会引起props的改变重新render。官方推荐使用connect function，它做了很多防止不必要re-render的优化。<br>先看整体：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">connect</span>(<span class="params">mapStateToProps, mapDispatchToProps, mergeProps, options = &#123;&#125;</span>) </span>&#123;</div><div class="line">  <span class="keyword">const</span> shouldSubscribe = <span class="built_in">Boolean</span>(mapStateToProps)</div><div class="line">  <span class="keyword">const</span> mapState = mapStateToProps || defaultMapStateToProps</div><div class="line"></div><div class="line">  <span class="keyword">let</span> mapDispatch</div><div class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> mapDispatchToProps === <span class="string">'function'</span>) &#123;</div><div class="line">    mapDispatch = mapDispatchToProps</div><div class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!mapDispatchToProps) &#123;</div><div class="line">    mapDispatch = defaultMapDispatchToProps</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    mapDispatch = wrapActionCreators(mapDispatchToProps)</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">const</span> finalMergeProps = mergeProps || defaultMergeProps</div><div class="line">  <span class="keyword">const</span> &#123; pure = <span class="literal">true</span>, withRef = <span class="literal">false</span> &#125; = options</div><div class="line">  <span class="keyword">const</span> checkMergedEquals = pure &amp;&amp; finalMergeProps !== defaultMergeProps</div><div class="line"></div><div class="line">  <span class="comment">// Helps track hot reloading.</span></div><div class="line">  <span class="keyword">const</span> version = nextVersion++</div><div class="line"></div><div class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">wrapWithConnect</span>(<span class="params">WrappedComponent</span>) </span>&#123;</div><div class="line">  	<span class="comment">//************</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>入参有：<br>1.mapStateToProps: type是一个函数，参数为state和nextProp，返回值就是传入到Index组件中的props集合，既然有state，也就符合它的功能，将state tree的一部分映射到组件的props;</p>
<p>2.mapDispatchToProps: type可以是一个对象或者函数，以函数为例，它的作用是将action映射到容器组件props中，这样在组建内部就可以dispatch action来改变state tree，所以对state的读写相当于都有了;从上面代码也可以看出如果mapDispatchToProps不是function是对象。会运行redux的bindActionCreators方法：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">wrapActionCreators</span>(<span class="params">actionCreators</span>) </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="function"><span class="params">dispatch</span> =&gt;</span> bindActionCreators(actionCreators, dispatch)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>而在bindActionCreators方法中，可以看到，如果actionCreators是对象，会使用Object.keys获取所有key。然后遍历每个属性调用bindActionCreator。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">bindActionCreator</span>(<span class="params">actionCreator, dispatch</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">...args</span>) =&gt;</span> dispatch(actionCreator(...args))</div><div class="line">&#125;</div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">bindActionCreators</span>(<span class="params">actionCreators, dispatch</span>) </span>&#123;</div><div class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> actionCreators === <span class="string">'function'</span>) &#123;</div><div class="line">    <span class="keyword">return</span> bindActionCreator(actionCreators, dispatch)</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> actionCreators !== <span class="string">'object'</span> || actionCreators === <span class="literal">null</span>) &#123;</div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(</div><div class="line">      <span class="string">`bindActionCreators expected an object or a function, instead received <span class="subst">$&#123;actionCreators === <span class="literal">null</span> ? <span class="string">'null'</span> : <span class="keyword">typeof</span> actionCreators&#125;</span>. `</span> +</div><div class="line">      <span class="string">`Did you write "import ActionCreators from" instead of "import * as ActionCreators from"?`</span></div><div class="line">    )</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">var</span> keys = <span class="built_in">Object</span>.keys(actionCreators)</div><div class="line">  <span class="keyword">var</span> boundActionCreators = &#123;&#125;</div><div class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; keys.length; i++) &#123;</div><div class="line">    <span class="keyword">var</span> key = keys[i]</div><div class="line">    <span class="keyword">var</span> actionCreator = actionCreators[key]</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> actionCreator === <span class="string">'function'</span>) &#123;</div><div class="line">      boundActionCreators[key] = bindActionCreator(actionCreator, dispatch)</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> boundActionCreators</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>最后bindActionCreators返回值会是这种形式<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//以下面indexGetBanner为例</span></div><div class="line">&#123;</div><div class="line">	<span class="attr">indexGetBanner1</span>: <span class="function">(<span class="params">...args</span>) =&gt;</span> dispatch(indexGetBanner(..arg)),</div><div class="line">	<span class="attr">indexGetBanner2</span>: <span class="function">(<span class="params">...args</span>) =&gt;</span> dispatch(indexGetBanner(..arg)),</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>而wrapActionCreators得返回值就是这样<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">(dispatch) =&gt; &#123;</div><div class="line">	<span class="keyword">return</span> &#123;</div><div class="line">		<span class="attr">indexGetBanner1</span>: <span class="function">(<span class="params">...args</span>) =&gt;</span> dispatch(indexGetBanner(..arg)),</div><div class="line">		<span class="attr">indexGetBanner2</span>: <span class="function">(<span class="params">...args</span>) =&gt;</span> dispatch(indexGetBanner(..arg))</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这种返回值与直接mapDispatchToProps传递方法的形式一模一样，所以bindActionCreators仅仅是对对象格式的参数进行了转化</p>
<p>3.mergeProps: 后续看作用;</p>
<p>具体用法如下:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">Index.propTypes = &#123;</div><div class="line">    <span class="attr">needMall</span>: PropTypes.bool.isRequired,</div><div class="line">    <span class="attr">bannerList</span>: PropTypes.array.isRequired,</div><div class="line">    <span class="attr">indexGetBanner</span>: PropTypes.func.isRequired</div><div class="line">&#125;</div><div class="line"><span class="keyword">const</span> mapStateToProps = <span class="function">(<span class="params">state</span>) =&gt;</span> &#123;</div><div class="line">    <span class="keyword">return</span> &#123;</div><div class="line">        <span class="attr">needMall</span>: state.Index.needMall,</div><div class="line">        <span class="attr">bannerList</span>: state.Index.bannerList</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="keyword">const</span> mapDispatchToProps = <span class="function">(<span class="params">dispatch</span>) =&gt;</span> &#123;      <span class="comment">//为方法</span></div><div class="line">    <span class="keyword">return</span>&#123;</div><div class="line">        <span class="attr">indexGetBanner</span>: <span class="function"><span class="params">()</span> =&gt;</span> dispatch(indexGetBanner())</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="keyword">const</span> mapDispatchToProps = &#123;					<span class="comment">//为对象</span></div><div class="line">    indexGetBanner: <span class="function"><span class="params">()</span> =&gt;</span> indexGetBanner()</div><div class="line">&#125;</div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> connect(mapStateToProps, mapDispatchToProps)(Index)</div></pre></td></tr></table></figure></p>
<p>最终还是wrapWithConnect(WrappedComponent)返回了容器组件。接下来看这里面。在这里面我们看到了react的很多生命周期回调，如componentDidMount，componentWillUnmount，componentWillReceiveProps。作用如下</p>
<p>1.componentDidMount: 调用trySubscribe，也就是store.subscribe注册handleChange监听，之所以store暴露出来的subscribe我们没有用到，在这里就明白了，因为connect帮我们做了这些。</p>
<p>2.componentWillUnmount： 调用tryUnsubscribe，清除handleChange监听回调。调用clearCache重置各种标志位</p>
<p>3.componentWillReceiveProps：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> &#123; pure = <span class="literal">true</span>, withRef = <span class="literal">false</span> &#125; = options	<span class="comment">//pure标识是否开启优化</span></div><div class="line"><span class="comment">/*******/</span></div><div class="line">componentWillReceiveProps(nextProps) &#123;</div><div class="line">	<span class="keyword">if</span> (!pure || !shallowEqual(nextProps, <span class="keyword">this</span>.props)) &#123;</div><div class="line">	  <span class="keyword">this</span>.haveOwnPropsChanged = <span class="literal">true</span></div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">/*******/</span></div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">shallowEqual</span>(<span class="params">objA, objB</span>) </span>&#123;		<span class="comment">//判断两个对象是否相等 === 对于对象的比较是直接比较引用的地址</span></div><div class="line">  <span class="keyword">if</span> (objA === objB) &#123;</div><div class="line">    <span class="keyword">return</span> <span class="literal">true</span></div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">const</span> keysA = <span class="built_in">Object</span>.keys(objA)</div><div class="line">  <span class="keyword">const</span> keysB = <span class="built_in">Object</span>.keys(objB)</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (keysA.length !== keysB.length) &#123;</div><div class="line">    <span class="keyword">return</span> <span class="literal">false</span></div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// Test for A's keys different from B.</span></div><div class="line">  <span class="keyword">const</span> hasOwn = <span class="built_in">Object</span>.prototype.hasOwnProperty</div><div class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; keysA.length; i++) &#123;</div><div class="line">    <span class="keyword">if</span> (!hasOwn.call(objB, keysA[i]) ||</div><div class="line">        objA[keysA[i]] !== objB[keysA[i]]) &#123;</div><div class="line">      <span class="keyword">return</span> <span class="literal">false</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> <span class="literal">true</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在handleChange中setState，引起render方法的调用，这两个方法中使用了大量标识变量来减少re-render。计算this.stateProps, this.dispatchProps; 在updateMergedPropsIfNeeded中对修改过的props进行merge。最终<br>createElement(WrappedComponent, {<br>    …this.mergedProps,<br>    ref: ‘wrappedInstance’<br>})<br>基于展示组件创建了一个renderedElement并返回。</p>
<p>最终返回的组件是这样的hoistStatics(Connect, WrappedComponent)是将WrappedComponent中的元素拷贝到Connect</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/11/24/20161124/" data-id="ciyvlrhpe002locvrz88yq5dn" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/react/">react</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/react-redux/">react-redux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/redux/">redux</a></li></ul>

    </footer>
  </div>
  
</article>




  
    <article id="post-20161119" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/11/19/20161119/" class="article-date">
  <time datetime="2016-11-18T16:00:00.000Z" itemprop="datePublished">2016-11-19</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/redux/">redux</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/11/19/20161119/">redux源码解析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>react火了有一年多了，项目里面一直没去用，主要是有我自己的考虑：1.公司web前端就一个人，而react从上手难度，协同合作来看更适合大的团队，小的团队像我这样的，使用vue更加容易上手和掌控。2.react+redux+react-router+redux-dev-tool+webpack+immutablejs全家桶学习曲线算是很高。最近项目不多，时间空闲就酝酿着对之前的一个项目用react+redux重构一次。这里先讲一下redux的源码。<br>关于redux的api使用推荐看一下阮老师的<a href="http://www.ruanyifeng.com/blog/2016/09/redux_tutorial_part_one_basic_usages.html" target="_blank" rel="external">三篇文章</a>，讲的很明白，我就不多说了</p>
<h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><p>学习新技术之前我们应该首先找到最规范的boilerplate，这个最规范的自然就是源码中的examples了，这里我以redux源码中的real-world为例（因为这个example最复杂综合）； redux源代码很少，所以没看之前还是很有信心的,在src/index.js中redux暴露出如下api:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//***</span></div><div class="line"><span class="keyword">export</span> &#123;</div><div class="line">  createStore,</div><div class="line">  combineReducers,</div><div class="line">  bindActionCreators,</div><div class="line">  applyMiddleware,</div><div class="line">  compose</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>先从createStore看起，createStore的调用被封装store/configureStore.js文件下，这里又区分了configureStore.dev.js和configure.prod.js文件。主要区别就是redux-dev-tool加入和reducer模块hotload两个功能的区别。考虑到dev功能更加齐全，就以dev的代码为例：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> &#123; createStore, applyMiddleware, compose &#125; <span class="keyword">from</span> <span class="string">'redux'</span></div><div class="line"><span class="keyword">import</span> thunk <span class="keyword">from</span> <span class="string">'redux-thunk'</span></div><div class="line"><span class="keyword">import</span> createLogger <span class="keyword">from</span> <span class="string">'redux-logger'</span></div><div class="line"><span class="keyword">import</span> api <span class="keyword">from</span> <span class="string">'../middleware/api'</span></div><div class="line"><span class="keyword">import</span> rootReducer <span class="keyword">from</span> <span class="string">'../reducers'</span></div><div class="line"><span class="keyword">import</span> DevTools <span class="keyword">from</span> <span class="string">'../containers/DevTools'</span></div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">configureStore</span>(<span class="params">preloadedState</span>) </span>&#123;</div><div class="line">  <span class="keyword">const</span> store = createStore(</div><div class="line">    rootReducer,</div><div class="line">    preloadedState,</div><div class="line">    compose(</div><div class="line">      applyMiddleware(thunk, api, createLogger()),</div><div class="line">      DevTools.instrument()</div><div class="line">    )</div><div class="line">  )</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (<span class="built_in">module</span>.hot) &#123;</div><div class="line">    <span class="comment">// Enable Webpack hot module replacement for reducers</span></div><div class="line">    <span class="built_in">module</span>.hot.accept(<span class="string">'../reducers'</span>, () =&gt; &#123;</div><div class="line">      <span class="keyword">const</span> nextRootReducer = <span class="built_in">require</span>(<span class="string">'../reducers'</span>).default</div><div class="line">      store.replaceReducer(nextRootReducer)</div><div class="line">    &#125;)</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> store</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>createStore核心代码如下<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">createStore</span>(<span class="params">reducer, preloadedState, enhancer</span>) </span>&#123;</div><div class="line">	<span class="comment">//*****</span></div><div class="line"> 	<span class="keyword">if</span> (<span class="keyword">typeof</span> enhancer !== <span class="string">'undefined'</span>) &#123;</div><div class="line">	   <span class="keyword">if</span> (<span class="keyword">typeof</span> enhancer !== <span class="string">'function'</span>) &#123;</div><div class="line">	     <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Expected the enhancer to be a function.'</span>)</div><div class="line">	   &#125;</div><div class="line"></div><div class="line">	   <span class="keyword">return</span> enhancer(createStore)(reducer, preloadedState)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">  	<span class="function"><span class="keyword">function</span> <span class="title">dispatch</span>(<span class="params">action</span>) </span>&#123;</div><div class="line">	    <span class="keyword">if</span> (!isPlainObject(action)) &#123;</div><div class="line">	      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(</div><div class="line">	        <span class="string">'Actions must be plain objects. '</span> +</div><div class="line">	        <span class="string">'Use custom middleware for async actions.'</span></div><div class="line">	      )</div><div class="line">	    &#125;</div><div class="line"></div><div class="line">	    <span class="keyword">if</span> (<span class="keyword">typeof</span> action.type === <span class="string">'undefined'</span>) &#123;</div><div class="line">	      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(</div><div class="line">	        <span class="string">'Actions may not have an undefined "type" property. '</span> +</div><div class="line">	        <span class="string">'Have you misspelled a constant?'</span></div><div class="line">	      )</div><div class="line">	    &#125;</div><div class="line"></div><div class="line">	    <span class="keyword">if</span> (isDispatching) &#123;</div><div class="line">	      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Reducers may not dispatch actions.'</span>)</div><div class="line">	    &#125;</div><div class="line"></div><div class="line">	    <span class="keyword">try</span> &#123;</div><div class="line">	      isDispatching = <span class="literal">true</span></div><div class="line">	      currentState = currentReducer(currentState, action)</div><div class="line">	    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">	      isDispatching = <span class="literal">false</span></div><div class="line">	    &#125;</div><div class="line"></div><div class="line">	    <span class="keyword">var</span> listeners = currentListeners = nextListeners</div><div class="line">	    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; listeners.length; i++) &#123;</div><div class="line">	      listeners[i]()</div><div class="line">	    &#125;</div><div class="line"></div><div class="line">	    <span class="keyword">return</span> action</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//*****</span></div><div class="line">    <span class="comment">// When a store is created, an "INIT" action is dispatched so that every</span></div><div class="line">	<span class="comment">// reducer returns their initial state. This effectively populates</span></div><div class="line">	<span class="comment">// the initial state tree.</span></div><div class="line">	dispatch(&#123; <span class="attr">type</span>: ActionTypes.INIT &#125;)</div><div class="line"></div><div class="line">	<span class="keyword">return</span> &#123;</div><div class="line">	   dispatch,</div><div class="line">	   subscribe,</div><div class="line">	   getState,</div><div class="line">	   replaceReducer,</div><div class="line">	   [$$observable]: observable</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<p>enhancer不为空就会执行enhancer函数并返回它的值；如果为空最终会返回一个默认值包含了dispatch,subscibe等api等等。<br>这里enhancer正好对应<br>compose(<br>  applyMiddleware(thunk, api, createLogger()),<br>  DevTools.instrument()<br>)</p>
<p>下一步就看applyMiddleware了，这个api是添加中间件。比如redux-thunk中间件就是为了解决异步action的问题而产生的，比如ajax请求(为什么要异步要返回函数这个阮老师的博客讲过了)：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//同步action</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">receivePosts</span>(<span class="params">postTitle, json</span>)</span>&#123;</div><div class="line">	<span class="keyword">return</span> &#123;</div><div class="line">		<span class="attr">type</span>: FETCH_SUCCESS,</div><div class="line">		<span class="attr">title</span>: postTitle,</div><div class="line">		<span class="attr">data</span>: json</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">//同步action激发方法，dispatch参数为对象</span></div><div class="line">dispatch(receivePosts(<span class="string">'加载成功'</span>, json))</div><div class="line"></div><div class="line"><span class="comment">//异步action</span></div><div class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">indexGetBanner</span>(<span class="params">status</span>)</span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="function">(<span class="params">dispath, getState</span>) =&gt;</span> &#123;</div><div class="line">        <span class="keyword">return</span> fetch(HOST+<span class="string">'SAAS_H5_ListBanner'</span>, &#123;</div><div class="line">            <span class="attr">method</span>: <span class="string">'POST'</span>,</div><div class="line">            <span class="attr">headers</span>: &#123;</div><div class="line">				<span class="string">'sid'</span>: <span class="string">'AA8yXxJNfRiWtKy4omdwqCuxyZpSsh2a4vdUkFC5/ww='</span></div><div class="line">			&#125;</div><div class="line">        &#125;).then(<span class="function"><span class="params">response</span> =&gt;</span> response.json())</div><div class="line">        .then(<span class="function"><span class="params">json</span> =&gt;</span> &#123;</div><div class="line">            dispatch(&#123;</div><div class="line">                <span class="attr">type</span>: GET_BANNER,</div><div class="line">                <span class="attr">bannerList</span>: json.body.bannerList</div><div class="line">            &#125;)</div><div class="line">        &#125;)</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">//异步action激发方法，dispatch参数为匿名函数 (dispatch, getState) =&gt; &#123;...&#125;</span></div><div class="line">dispatch(indexGetBanner())</div></pre></td></tr></table></figure></p>
<p>而在createStore中dispatch的源码我们也看到，一开始使用isPlainObject进行了检验，所以这里为了使dispatch能够接受函数作为参数。我们就要使用到中间件。对dispatch进行改造和包装。</p>
<p>applyMiddleware源代码如下:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">applyMiddleware</span>(<span class="params">...middlewares</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">createStore</span>) =&gt;</span> (reducer, preloadedState, enhancer) =&gt; &#123;</div><div class="line">    <span class="keyword">var</span> store = createStore(reducer, preloadedState, enhancer)</div><div class="line">    <span class="keyword">var</span> dispatch = store.dispatch</div><div class="line">    <span class="keyword">var</span> chain = []</div><div class="line"></div><div class="line">    <span class="keyword">var</span> middlewareAPI = &#123;</div><div class="line">      <span class="attr">getState</span>: store.getState,</div><div class="line">      <span class="attr">dispatch</span>: <span class="function">(<span class="params">action</span>) =&gt;</span> dispatch(action)</div><div class="line">    &#125;</div><div class="line">    chain = middlewares.map(<span class="function"><span class="params">middleware</span> =&gt;</span> middleware(middlewareAPI))</div><div class="line">    dispatch = compose(...chain)(store.dispatch)</div><div class="line"></div><div class="line">    <span class="keyword">return</span> &#123;</div><div class="line">      ...store,</div><div class="line">      dispatch</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>redux-thunk和demo中自定义的api中间件源码如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">thunkMiddleware</span>(<span class="params">&#123; dispatch, getState &#125;</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="function"><span class="params">next</span> =&gt;</span> action =&gt;</div><div class="line">    <span class="keyword">typeof</span> action === <span class="string">'function'</span> ?</div><div class="line">      action(dispatch, getState) :</div><div class="line">      next(action);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = thunkMiddleware</div><div class="line"></div><div class="line"><span class="comment">//api</span></div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> store =&gt; <span class="function"><span class="params">next</span> =&gt;</span> action =&gt; &#123;</div><div class="line">	<span class="comment">//***</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以发现所有的中间件都是三层函数。在applyMiddleware中，chain = middlewares.map(middleware =&gt; middleware(middlewareAPI))这段代码执行了最外层的函数。middlewareAPI中的getState，dispatch参数也和thunkMiddleware函数的参数相契合。</p>
<p>这个时候的chain实际上是类似于这样的函数数组<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">[</div><div class="line">	<span class="function"><span class="params">next</span> =&gt;</span> action =&gt; &#123;</div><div class="line"></div><div class="line">	&#125;,</div><div class="line">	next =&gt; <span class="function"><span class="params">action</span> =&gt;</span> &#123;</div><div class="line"></div><div class="line">	&#125;</div><div class="line">]</div></pre></td></tr></table></figure></p>
<p>再看下一行compose函数的执行。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">compose</span>(<span class="params">...funcs</span>) </span>&#123;</div><div class="line">  <span class="keyword">if</span> (funcs.length === <span class="number">0</span>) &#123;</div><div class="line">    <span class="keyword">return</span> <span class="function"><span class="params">arg</span> =&gt;</span> arg</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (funcs.length === <span class="number">1</span>) &#123;</div><div class="line">    <span class="keyword">return</span> funcs[<span class="number">0</span>]</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">const</span> last = funcs[funcs.length - <span class="number">1</span>]</div><div class="line">  <span class="keyword">const</span> rest = funcs.slice(<span class="number">0</span>, <span class="number">-1</span>)</div><div class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">...args</span>) =&gt;</span> rest.reduceRight(<span class="function">(<span class="params">composed, f</span>) =&gt;</span> f(composed), last(...args))</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>reduceRight和reduce的区别在于运算的操作是从右侧开始的，<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>].reduce(<span class="function"><span class="keyword">function</span>(<span class="params">pre, cur, index, arr</span>)</span>&#123; <span class="built_in">console</span>.log(pre+<span class="string">'----------'</span>+cur); <span class="keyword">return</span> pre+cur;&#125;, <span class="number">10</span>)</div><div class="line"><span class="number">10</span>---------<span class="number">-1</span></div><div class="line"><span class="number">11</span>---------<span class="number">-2</span></div><div class="line"><span class="number">13</span>---------<span class="number">-3</span></div><div class="line"></div><div class="line">[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>].reduceRight(<span class="function"><span class="keyword">function</span>(<span class="params">pre, cur, index, arr</span>)</span>&#123; <span class="built_in">console</span>.log(pre+<span class="string">'----------'</span>+cur); <span class="keyword">return</span> pre+cur;&#125;, <span class="number">10</span>)</div><div class="line"><span class="number">10</span>---------<span class="number">-3</span></div><div class="line"><span class="number">17</span>---------<span class="number">-2</span></div><div class="line"><span class="number">21</span>---------<span class="number">-1</span></div></pre></td></tr></table></figure></p>
<p>compose方法return出来的就放方法串行执行： 比如入参funcs是[func1, func2, func3, func4]<br>最终返回值是：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span>(<span class="params">...args</span>)</span>&#123;</div><div class="line">    <span class="keyword">return</span> func1(func2(func3(func4(...args))))       <span class="comment">//执行顺序就是f4,f3,f2,f1</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>对应上面chain的结构，最终的返回值也就是<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span>(<span class="params">...args</span>)</span>&#123;</div><div class="line">	<span class="keyword">var</span> r1 = (<span class="function"><span class="keyword">function</span> <span class="title">f4</span>(<span class="params">next</span>)</span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">f4action</span>(<span class="params">action</span>)</span>&#123;</div><div class="line"></div><div class="line">		&#125;</div><div class="line">	&#125;)(args);</div><div class="line"></div><div class="line">	<span class="keyword">var</span> r2 = (<span class="function"><span class="keyword">function</span> <span class="title">f3</span>(<span class="params">next</span>)</span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">f3action</span>(<span class="params">action</span>)</span>&#123;</div><div class="line"></div><div class="line">		&#125;</div><div class="line">	&#125;)(r1);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这个方法返回之后立即被执行了，参数就是store.dispatch。这是原来的没有被改变过的dispatch；想一下r1实际就是返回 参数为action的匿名方法。这个函数唯一被改变的就是其中的next已经被替换为store.dispatch。这个函数又作为下一个中间件的next，替换掉下一个匿名action函数中的next函数，所以最终新生成的dispatch函数应该这样的：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">f1action</span>(<span class="params">action</span>)</span>&#123;</div><div class="line">	<span class="comment">//f1action逻辑...</span></div><div class="line"></div><div class="line">	<span class="comment">//next调用被替换为如下</span></div><div class="line">	(f2action(action)&#123;</div><div class="line">		<span class="comment">//f2action逻辑...</span></div><div class="line"></div><div class="line">		<span class="comment">//next调用被替换为如下</span></div><div class="line">		(f3action(action)&#123;</div><div class="line">			<span class="comment">//f3action逻辑...</span></div><div class="line"></div><div class="line">			<span class="comment">//最后一个中间件，next被替换为store.dispatch</span></div><div class="line">			store.dispatch();</div><div class="line">		&#125;)()</div><div class="line"></div><div class="line">	&#125;)(...params)</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以十分清楚的看到，新的dispatch添加入了每个中间件的逻辑。这就是中间件的原理。写完这些之后我看了下关于<a href="http://redux.js.org/docs/advanced/Middleware.html" target="_blank" rel="external">middleware的介绍</a>，确实是这个思路；强烈建议看下这个文章，正向思考，一步一步解释了为什么applyMiddleware代码会是这种样子。</p>
<p>所以异步action最后调用dispatch，参数是一个function。而这个function作为action一直被传递到最里层。一般第一个middleware是thunk，由于使用reduceRight，它正好位于最里层。action =&gt;<br>typeof action === ‘function’ ? action(dispatch, getState) : next(action); 这样异步action返回的方法正好被执行了，dispatch,getState参数也正好对上了。</p>
<p>中间件的分析写到这里了，看完之后真的觉得这种链式执行很巧妙，redux还有一个api bindActionCreators留在下一篇react-redux讲解，这个与其中的connectapi有关</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/11/19/20161119/" data-id="ciyvlrhp1002bocvrqn1i59r2" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/redux/">redux</a></li></ul>

    </footer>
  </div>
  
</article>




  
    <article id="post-20161108" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/11/08/20161108/" class="article-date">
  <time datetime="2016-11-07T16:00:00.000Z" itemprop="datePublished">2016-11-08</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/js/">js</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/11/08/20161108/">cookie详细理解</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="为什么要提cookie"><a href="#为什么要提cookie" class="headerlink" title="为什么要提cookie"></a>为什么要提cookie</h3><p>在很多人看来，提及cookie必定要说session，但是我这里说的不是session，而是想从web前端的角度详细说明下cookie；cookie的设置服务器端和客户端都可以做，这里先看服务器端，以我较为熟悉的jsp为例：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//创建Cookie对象</span></div><div class="line">Cookie cookie = <span class="keyword">new</span> Cookie(<span class="string">"key"</span>, <span class="string">"value"</span>);</div><div class="line"><span class="comment">//设置cookie有效期</span></div><div class="line">cookie.setMaxAge(<span class="number">60</span>*<span class="number">60</span>*<span class="number">24</span>);</div><div class="line"><span class="comment">//设置cookie域名</span></div><div class="line">cookie.setDomain(<span class="string">"testsaas-1014-100001.m.izhuazhua.com"</span>);</div><div class="line"><span class="comment">//设置cookie的路径。默认为当且页面目录下的所有url，还有目录的所有子目录</span></div><div class="line">cookie.setPath(<span class="string">"/"</span>);</div><div class="line"><span class="comment">//设置cookie是否加密传输</span></div><div class="line">cookie.setSecure(<span class="keyword">true</span>);</div><div class="line"><span class="comment">//将cookie添加到响应头，这样浏览器端会自动将cookie写入</span></div><div class="line">response.addCookie(cookie);</div></pre></td></tr></table></figure></p>
<p>与此对应的客户端的cookie对应的操作方法，我们也可以在mdn查到：<br>实际浏览器中的api只有一个document.cookie：<br>它是一个可读写的属性，所以客户端完全可以依据这个属性封装一套cookie操作的api，这里我摘取一段jquery.cookie.js的源码：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div></pre></td><td class="code"><pre><div class="line">(<span class="function"><span class="keyword">function</span> (<span class="params">factory</span>) </span>&#123;</div><div class="line">	<span class="keyword">if</span> (<span class="keyword">typeof</span> define === <span class="string">'function'</span> &amp;&amp; define.amd) &#123;</div><div class="line">		<span class="comment">// AMD. Register as anonymous module.</span></div><div class="line">		define([<span class="string">'jquery'</span>], factory);</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="comment">// Browser globals.</span></div><div class="line">		factory(jQuery);</div><div class="line">	&#125;</div><div class="line">&#125;(<span class="function"><span class="keyword">function</span> (<span class="params">$</span>) </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">var</span> pluses = <span class="regexp">/\+/g</span>;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">function</span> <span class="title">encode</span>(<span class="params">s</span>) </span>&#123;</div><div class="line">		<span class="keyword">return</span> config.raw ? s : <span class="built_in">encodeURIComponent</span>(s);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">function</span> <span class="title">decode</span>(<span class="params">s</span>) </span>&#123;</div><div class="line">		<span class="keyword">return</span> config.raw ? s : <span class="built_in">decodeURIComponent</span>(s);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">function</span> <span class="title">stringifyCookieValue</span>(<span class="params">value</span>) </span>&#123;</div><div class="line">		<span class="keyword">return</span> encode(config.json ? <span class="built_in">JSON</span>.stringify(value) : <span class="built_in">String</span>(value));</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">function</span> <span class="title">parseCookieValue</span>(<span class="params">s</span>) </span>&#123;</div><div class="line">		<span class="keyword">if</span> (s.indexOf(<span class="string">'"'</span>) === <span class="number">0</span>) &#123;</div><div class="line">			<span class="comment">// This is a quoted cookie as according to RFC2068, unescape...</span></div><div class="line">			s = s.slice(<span class="number">1</span>, <span class="number">-1</span>).replace(<span class="regexp">/\\"/g</span>, <span class="string">'"'</span>).replace(<span class="regexp">/\\\\/g</span>, <span class="string">'\\'</span>);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			<span class="comment">// Replace server-side written pluses with spaces.</span></div><div class="line">			<span class="comment">// If we can't decode the cookie, ignore it, it's unusable.</span></div><div class="line">			s = <span class="built_in">decodeURIComponent</span>(s.replace(pluses, <span class="string">' '</span>));</div><div class="line">		&#125; <span class="keyword">catch</span>(e) &#123;</div><div class="line">			<span class="keyword">return</span>;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			<span class="comment">// If we can't parse the cookie, ignore it, it's unusable.</span></div><div class="line">			<span class="keyword">return</span> config.json ? <span class="built_in">JSON</span>.parse(s) : s;</div><div class="line">		&#125; <span class="keyword">catch</span>(e) &#123;&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">function</span> <span class="title">read</span>(<span class="params">s, converter</span>) </span>&#123;</div><div class="line">		<span class="keyword">var</span> value = config.raw ? s : parseCookieValue(s);</div><div class="line">		<span class="keyword">return</span> $.isFunction(converter) ? converter(value) : value;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">var</span> config = $.cookie = <span class="function"><span class="keyword">function</span> (<span class="params">key, value, options</span>) </span>&#123;</div><div class="line"></div><div class="line">		<span class="comment">// Write</span></div><div class="line">		<span class="keyword">if</span> (value !== <span class="literal">undefined</span> &amp;&amp; !$.isFunction(value)) &#123;</div><div class="line">			options = $.extend(&#123;&#125;, config.defaults, options);</div><div class="line"></div><div class="line">			<span class="keyword">if</span> (<span class="keyword">typeof</span> options.expires === <span class="string">'number'</span>) &#123;</div><div class="line">				<span class="keyword">var</span> days = options.expires, t = options.expires = <span class="keyword">new</span> <span class="built_in">Date</span>();</div><div class="line">				t.setDate(t.getDate() + days);</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">return</span> (<span class="built_in">document</span>.cookie = [</div><div class="line">				encode(key), <span class="string">'='</span>, stringifyCookieValue(value),</div><div class="line">				options.expires ? <span class="string">'; expires='</span> + options.expires.toUTCString() : <span class="string">''</span>, <span class="comment">// use expires attribute, max-age is not supported by IE</span></div><div class="line">				options.path    ? <span class="string">'; path='</span> + options.path : <span class="string">''</span>,</div><div class="line">				options.domain  ? <span class="string">'; domain='</span> + options.domain : <span class="string">''</span>,</div><div class="line">				options.secure  ? <span class="string">'; secure'</span> : <span class="string">''</span></div><div class="line">			].join(<span class="string">''</span>));</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// Read</span></div><div class="line"></div><div class="line">		<span class="keyword">var</span> result = key ? <span class="literal">undefined</span> : &#123;&#125;;</div><div class="line"></div><div class="line">		<span class="comment">// To prevent the for loop in the first place assign an empty array</span></div><div class="line">		<span class="comment">// in case there are no cookies at all. Also prevents odd result when</span></div><div class="line">		<span class="comment">// calling $.cookie().</span></div><div class="line">		<span class="keyword">var</span> cookies = <span class="built_in">document</span>.cookie ? <span class="built_in">document</span>.cookie.split(<span class="string">'; '</span>) : [];</div><div class="line"></div><div class="line">		<span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, l = cookies.length; i &lt; l; i++) &#123;</div><div class="line">			<span class="keyword">var</span> parts = cookies[i].split(<span class="string">'='</span>);</div><div class="line">			<span class="keyword">var</span> name = decode(parts.shift());</div><div class="line">			<span class="keyword">var</span> cookie = parts.join(<span class="string">'='</span>);</div><div class="line"></div><div class="line">			<span class="keyword">if</span> (key &amp;&amp; key === name) &#123;</div><div class="line">				<span class="comment">// If second argument (value) is a function it's a converter...</span></div><div class="line">				result = read(cookie, value);</div><div class="line">				<span class="keyword">break</span>;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="comment">// Prevent storing a cookie that we couldn't decode.</span></div><div class="line">			<span class="keyword">if</span> (!key &amp;&amp; (cookie = read(cookie)) !== <span class="literal">undefined</span>) &#123;</div><div class="line">				result[name] = cookie;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">return</span> result;</div><div class="line">	&#125;;</div><div class="line"></div><div class="line">	config.defaults = &#123;&#125;;</div><div class="line"></div><div class="line">	$.removeCookie = <span class="function"><span class="keyword">function</span> (<span class="params">key, options</span>) </span>&#123;</div><div class="line">		<span class="keyword">if</span> ($.cookie(key) !== <span class="literal">undefined</span>) &#123;</div><div class="line">			<span class="comment">// Must not alter options, thus extending a fresh object...</span></div><div class="line">			$.cookie(key, <span class="string">''</span>, $.extend(&#123;&#125;, options, &#123; <span class="attr">expires</span>: <span class="number">-1</span> &#125;));</div><div class="line">			<span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">	&#125;;</div><div class="line"></div><div class="line">&#125;));</div></pre></td></tr></table></figure></p>
<p>这里详细介绍下三个属性<br>1.max-age和expires: 这两个属性类似，与页面缓存的机制类似；max-age是较新的属性，max-age以时间段为单位，比expires的优势就在于解决了服务器端和客户端时间不同步的问题。由于document.cookie中没有直接的删除api。所以一般删除cookie使用的是max-age=0或者负数或者expires设置为一个过去的时间。</p>
<p>2.path: 用于设置cookie的相对路径，举个例子<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//当前页面为http://testsaas-1014-100001.m.izhuazhua.com/appMarket/dist/home.jsp。cookie domain为testsaas-1014-100001.m.izhuazhua.com</span></div><div class="line"><span class="built_in">document</span>.cookie=<span class="string">"testpath="</span>+<span class="built_in">encodeURIComponent</span>(<span class="string">'path value'</span>)+<span class="string">"; path=/appMarket/"</span>;	<span class="comment">//在http://testsaas-1014-100001.m.izhuazhua.com/index.jsp#/index页面中就读取不到该cookie</span></div><div class="line"></div><div class="line"><span class="comment">//当前页面为http://testsaas-1014-100001.m.izhuazhua.com/appMarket/dist/home.jsp。cookie domain为testsaas-1014-100001.m.izhuazhua.com</span></div><div class="line"><span class="built_in">document</span>.cookie=<span class="string">"testpath1="</span>+<span class="built_in">encodeURIComponent</span>(<span class="string">'path1 value'</span>)+<span class="string">"; path=/"</span>;		<span class="comment">//在http://testsaas-1014-100001.m.izhuazhua.com/index.jsp#/index页面中能读取到该cookie</span></div></pre></td></tr></table></figure></p>
<p>上面的例子说明了如下问题：<br>1.如果不设置domain。cookie默认设置在当前最子级域名下；<br>2.域名相同的情况下，path的设置没有限制（即可以在任何页面设置任何path，也就是说可以在子页面中设置path为根目录，也可以在根目录下设置path在子目录下）。<br>3.当且页面目录下的所有url，还有目录的所有子目录可以访问到当前path的cookie。但是path如果设置为子目录。父目录中读取不到。<br>在这个地方我是有一次遇到问题，有深切体会。</p>
<p>3.domain：用于设置cookie在哪个域名下<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//当前页面http://testsaas-1014-100001.m.izhuazhua.com/index.jsp#/index</span></div><div class="line"><span class="built_in">document</span>.cookie=<span class="string">"testdomain="</span>+<span class="built_in">encodeURIComponent</span>(<span class="string">'domain value'</span>)+<span class="string">"; domain=m.izhuazhua.com"</span>;</div><div class="line"></div><div class="line"><span class="comment">//当前页面http://testsaas-1014-100001.m.izhuazhua.com/index.jsp#/index</span></div><div class="line"><span class="built_in">document</span>.cookie=<span class="string">"testdomain1="</span>+<span class="built_in">encodeURIComponent</span>(<span class="string">'domain1 value'</span>)+<span class="string">"; domain=testsaas-1014-100001.m.izhuazhua.com"</span>;</div><div class="line"></div><div class="line"><span class="comment">//切换到页面http://testsaas-1000-100001.m.izhuazhua.com/index.jsp#/index		只能看到testdomain cookie</span></div></pre></td></tr></table></figure></p>
<p>总结与设想类似。子域名下的永远能访问到父域名下的cookie。但是跨域的读取不到。<br>这个我们的项目也是有实际的使用场景。做宠物商城，以1014这个为宠物店标识，不同的宠物店三级域名是不一样的。这个时候就要将一个公用的cookie设置到二级以上的域名</p>
<p>4.secure: 用于设置cookie加密传输<br>这个没实际用过，拉上mdn的一句话，理解起来其实也很简单</p>
<blockquote>
<p>;secure Cookie to only be transmitted over secure protocol as https. Before Chrome 52, this flag could appear with cookies from http domains.</p>
</blockquote>
<p>另外还有一点：jsapi似乎并不能读取这些属性。document.cookie永远返回这种格式</p>
<blockquote>
<p>“sname=zhuo; JSESSIONID=aaa6225A_CoOdfocn49Gv; sid=AA8yXxJNfRhAVUPHs%2F%2F3Jd6s9IGzGKgq6HPYTGawjDA%3D; testdomain=domain%20value”</p>
</blockquote>
<p>只有使用chrome devtools查看这些详细属性</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/11/08/20161108/" data-id="ciyvlrhoy0029ocvrhdqqe5p3" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cookie/">cookie</a></li></ul>

    </footer>
  </div>
  
</article>




  
    <article id="post-20161104" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/11/04/20161104/" class="article-date">
  <time datetime="2016-11-03T16:00:00.000Z" itemprop="datePublished">2016-11-04</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/css/">css</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/11/04/20161104/">rem适配进一步理解</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="项目背景"><a href="#项目背景" class="headerlink" title="项目背景"></a>项目背景</h3><p>最近又做了个<a href="http://testsaas-1014-100001.m.izhuazhua.com/lindu/dist/home.html" target="_blank" rel="external">企业官网的项目</a>;基本都是些静态界面，对于这种看起来没什么难度的项目，这个时候就要追求点有难度的，才能学习到东西。所以摒弃了常规的一个一个html写的方式，vue组件化+响应式布局才有点意思，正好之前也做过一个自己公司的响应式的<a href="http://www.izhuazhua.com" target="_blank" rel="external">官网</a>，这次更加加深了理解。</p>
<h3 id="架构想法"><a href="#架构想法" class="headerlink" title="架构想法"></a>架构想法</h3><p>基本的想法都已经确定过了，css配合media query引入，js则根据screen.width动态处理逻辑。这个有鉴于张鑫旭的<a href="http://www.zhangxinxu.com/wordpress/2016/06/pseudo-response-layout-base-on-screen-width/" target="_blank" rel="external">基于screen.width的伪响应式开发</a>,这篇文章也解释了使用screen.width可以明确地区分不同的js逻辑，而不会耦合在一起。如果为了实现动态拉伸窗口切换样式的需求，可以监听window.resize事件，但是实际这没有什么必要，因为用户不会无聊到不断改变浏览器窗口大小。</p>
<p>对于在不同屏幕下的适配问题，首选自然是rem。以往我们公司采用的却不是这种方式。<br>1.设计师给750宽的图，我们也设定页面宽度为750。<br>2.动态调整viewport的值，代码如下：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="handlebars"><span class="xml"></span></span></div><div class="line">	<span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="css"></span></div><div class="line">			<span class="selector-tag">html</span>,<span class="selector-tag">body</span>&#123;<span class="attribute">margin</span>:<span class="number">0</span>;&#125;</div><div class="line">		<span class="tag">&lt;/<span class="name">style</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"></span></div><div class="line">			<span class="keyword">var</span> w = <span class="built_in">document</span>.documentElement.getBoundingClientRect().width;</div><div class="line">			<span class="keyword">var</span> meta = <span class="built_in">document</span>.createElement(<span class="string">'meta'</span>);</div><div class="line">			meta.name=<span class="string">"viewport"</span>;</div><div class="line">			meta.content=<span class="string">"initial-scale="</span> + w/<span class="number">750</span> + <span class="string">",maximum-scale="</span> + w/<span class="number">750</span> + <span class="string">",user-scalable=no"</span>;</div><div class="line">			<span class="keyword">var</span> head = <span class="built_in">document</span>.querySelector(<span class="string">'head'</span>);</div><div class="line">			head.appendChild(meta);</div><div class="line">		<span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>想法很简单，取物理像素（比如iphone6设备像素750px，物理像素375px，devicePixelRatio为2；这些就不解释了）除750。得到百分比。这样在不同的屏幕上永远固定页面宽度为750像素。其实这里有几个问题：<br>1.使用getBoundingClientRect()，而不使用screen.width。因为在实际测试发现：有些机型screen.width取得是设备像素，有些取的又是物理像素，兼容性很差；这个在张鑫旭的<a href="http://www.zhangxinxu.com/wordpress/2012/08/window-devicepixelratio/" target="_blank" rel="external">设备像素比devicePixelRatio简单介绍</a>里面也有体现。<br>这个时候查看淘宝聚划算（这个网站就是一个典型的rem网站）的源码发现如下代码：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">~<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">	<span class="function"><span class="keyword">function</span> <span class="title">e</span>(<span class="params"></span>)</span>&#123;</div><div class="line">		r.innerText=<span class="string">"html&#123;font-size:"</span>+(a.style.fontSize=a.getBoundingClientRect().width/o*d+<span class="string">"px"</span>)+<span class="string">" !important;&#125;"</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">var</span> t=navigator.userAgent,</div><div class="line">	n=(t.match(<span class="regexp">/(iPhone|iPad|iPod)/</span>),t.match(<span class="regexp">/Android/i</span>),<span class="built_in">window</span>),</div><div class="line">	i=<span class="built_in">document</span>,</div><div class="line">	a=i.documentElement,</div><div class="line">	o=(n.devicePixelRatio||<span class="number">1</span>,<span class="number">375</span>),</div><div class="line">	d=<span class="number">100</span>,</div><div class="line">	r=(i.head.querySelector(<span class="string">'[name="viewport"]'</span>),</div><div class="line">	i.createElement(<span class="string">"style"</span>));</div><div class="line">	r.innerText=<span class="string">"html&#123;font-size:100px !important&#125;"</span>,</div><div class="line">	i.head.appendChild(r),</div><div class="line">	e(),</div><div class="line">	n.addEventListener(<span class="string">"resize"</span>,e,!<span class="number">1</span>),</div><div class="line">	a.className+=t.match(<span class="regexp">/ucbrowser/i</span>)?<span class="string">" app-uc "</span>:<span class="string">""</span></div><div class="line">&#125;();</div></pre></td></tr></table></figure></p>
<p>可见getBoundingClientRect（）获取的基本上应该是物理像素，实际测试也证明了这个</p>
<p>2.必须得首先使用<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">进行初始化，否则getBoundingClientRect（）取值会不正确，所以先要初始化一次viewport，再动态计算出缩放比，添加一个新的viewport覆盖</p>
<p>3.这种方式直接缩放整个页面，得到的文字字体缩放效果其实是不对的。</p>
<h3 id="新的实践"><a href="#新的实践" class="headerlink" title="新的实践"></a>新的实践</h3><p>既然上面的策略有瑕疵，那就采用新的方式吧。看了下alloyteam的<a href="http://www.alloyteam.com/2016/03/mobile-web-adaptation-tool-rem/" target="_blank" rel="external">移动端适配利器-rem</a>; 基本这可能就是最佳的方案吧。一言不合上代码:<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;!doctype html&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="css"></span></div><div class="line">			<span class="selector-tag">html</span>,<span class="selector-tag">body</span>&#123;<span class="attribute">margin</span>:<span class="number">0</span>;&#125;</div><div class="line">		<span class="tag">&lt;/<span class="name">style</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"></span></div><div class="line">			<span class="comment">//设置html font-size</span></div><div class="line">			<span class="keyword">var</span> w = <span class="built_in">document</span>.documentElement.getBoundingClientRect().width, html = <span class="built_in">document</span>.querySelector(<span class="string">'html'</span>);</div><div class="line">			html.style.fontSize = devicePixelRatio*w/<span class="number">10</span>+<span class="string">'px'</span>;</div><div class="line">			<span class="comment">// 设置对应的缩小比，可以实现1px设备像素</span></div><div class="line">			<span class="keyword">var</span> meta = <span class="built_in">document</span>.createElement(<span class="string">'meta'</span>);</div><div class="line">			meta.name=<span class="string">"viewport"</span>;</div><div class="line">			meta.content=<span class="string">"initial-scale="</span>+<span class="number">1</span>/devicePixelRatio+<span class="string">",maximum-scale="</span>+<span class="number">1</span>/devicePixelRatio+<span class="string">",user-scalable=no"</span>;</div><div class="line">			<span class="keyword">var</span> head = <span class="built_in">document</span>.querySelector(<span class="string">'head'</span>);</div><div class="line">			head.appendChild(meta);</div><div class="line">		<span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="css"></span></div><div class="line">			<span class="selector-class">.div</span>&#123;</div><div class="line">				<span class="attribute">background-color</span>:black; <span class="attribute">width</span>:<span class="number">10rem</span>; <span class="attribute">height</span>:<span class="number">10rem</span>;</div><div class="line">			&#125;</div><div class="line">			<span class="selector-class">.font</span>&#123;</div><div class="line">				<span class="attribute">font-size</span>:<span class="number">1rem</span>;</div><div class="line">			&#125;</div><div class="line">			<span class="selector-class">.onepxline</span>&#123;</div><div class="line">				<span class="attribute">width</span>:<span class="number">5rem</span>; <span class="attribute">height</span>:<span class="number">1px</span>; <span class="attribute">margin</span>:<span class="number">1rem</span> <span class="number">0</span>;</div><div class="line">				<span class="attribute">background-color</span>: red;</div><div class="line">			&#125;</div><div class="line">		<span class="tag">&lt;/<span class="name">style</span>&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"div"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line"></div><div class="line">		<span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"font"</span>&gt;</span>测试字体大小<span class="tag">&lt;/<span class="name">span</span>&gt;</span></div><div class="line"></div><div class="line">		<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"onepxline"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="actionscript"></span></div><div class="line">			<span class="comment">// alert(document.documentElement.getBoundingClientRect().width+'-----------'+screen.width+'----------'+document.querySelector('.div').offsetWidth);</span></div><div class="line">		<span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>总结下来就是几点：<br>1.动态设置html的font-size：其实也就是动态设置1rem的值，当然这里也是有相关规律的，就是永远设置为设备像素/10;以iphone6为例，这里的font-size会被设置为750px/10 = 75px。这样就保证了10rem永远是整个屏幕的设备像素，刚好占满整个屏幕。</p>
<p>2.因为是按照设备像素设计和写的css所以，设置viewport缩放1/devicePixelRatio,刚好就是物理像素。</p>
<p>3.这样也就很好的解决了1px设备像素的问题和图片高清问题。</p>
<p>实际处理还有点小技巧，我们不可能总是去计算所有的rem，这样太累。幸好有css预处理器，比如saas，写个自定义函数自动转换px到rem。就可以完全按照设计图来写css了<br><figure class="highlight scss"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">@function px2rem(<span class="variable">$px</span>)&#123;</div><div class="line">	<span class="variable">$rem</span>: <span class="number">75px</span>;</div><div class="line">	@return <span class="variable">$px</span>/<span class="variable">$rem</span>;</div><div class="line">&#125;</div><div class="line"><span class="selector-tag">body</span>&#123;</div><div class="line">	<span class="attribute">font-size</span>: px2rem(<span class="number">10px</span>);		</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/11/04/20161104/" data-id="ciyvlrhp4002eocvrss154mko" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/rem/">rem</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/viewport/">viewport</a></li></ul>

    </footer>
  </div>
  
</article>




  
    <article id="post-20161102" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/11/02/20161102/" class="article-date">
  <time datetime="2016-11-01T16:00:00.000Z" itemprop="datePublished">2016-11-02</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/js/">js</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/11/02/20161102/">webpack热更新调试的几种方法</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="项目背景"><a href="#项目背景" class="headerlink" title="项目背景"></a>项目背景</h3><p>最近做的几个vue项目都使用的webpack构建，也了解了下webpack其中调试的方法，主要有以下几种：</p>
<ol>
<li>devtool configuration option</li>
<li>webpack-dev-server</li>
<li>webpack-dev-middleware<br>这里重点说下2和3的使用。</li>
</ol>
<h3 id="webpack-dev-server"><a href="#webpack-dev-server" class="headerlink" title="webpack-dev-server"></a>webpack-dev-server</h3><p>这是一个小型的node.js express服务器，它使用webpack-dev-middleware去处理webpack bundle。</p>
<blockquote>
<p>The server emits information about the compilation state to the client, which reacts to those events. You can choose between different modes, depending on your needs.</p>
</blockquote>
<p>它支持两种自动刷新方式</p>
<ol>
<li><p>iframe模式（使用iframe模式很简单，只要启动dev-server之后直接访问类似<a href="http://localhost:8080/webpack-dev-server/index.html路径就可以了。这是页面会被嵌入到iframe）。它有这几个特点" target="_blank" rel="external">http://localhost:8080/webpack-dev-server/index.html路径就可以了。这是页面会被嵌入到iframe）。它有这几个特点</a></p>
<blockquote>
<p>-.No configuration change needed.<br>-.Nice information bar on top of your app.<br>-.URL changes in the app are not reflected in the browser’s URL bar.</p>
</blockquote>
</li>
<li><p>inline模式<br>inline模式又分为命令行模式和node api模式</p>
</li>
</ol>
<h4 id="命令行模式"><a href="#命令行模式" class="headerlink" title="命令行模式"></a>命令行模式</h4><p>直接在package.json中的script字段中加入webpack命令。比如vue-cli中simple模板生成的就是这种格式<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="string">"scripts"</span>: &#123;</div><div class="line">  <span class="string">"dev"</span>: <span class="string">"webpack-dev-server --inline --hot --no-info --port 8081"</span>,</div><div class="line">  <span class="string">"build"</span>: <span class="string">"cross-env NODE_ENV=production webpack --progress --hide-modules"</span>,</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看出dev模式下，只需要加入–inline参数启动就可以了，需要Hot Module Replacement也就是直接加上–hot参数，十分简单方便。这种情况下，都会默认去执行webpack.config.js文件</p>
<h4 id="node-api模式"><a href="#node-api模式" class="headerlink" title="node api模式"></a>node api模式</h4><p>这种模式比cli方式要复杂。一言不合直接上已经实践的代码吧。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//package.json</span></div><div class="line"><span class="string">"scripts"</span>: &#123;</div><div class="line">  <span class="string">"dev:index"</span>: <span class="string">"node build/webpack.index.conf.js -d"</span>,</div><div class="line">  <span class="string">"build:index"</span>: <span class="string">"node build/webpack.index.conf.js -p"</span>,</div><div class="line">  <span class="string">"dev:producer"</span>: <span class="string">"node build/webpack.producer.conf.js -d"</span>,</div><div class="line">  <span class="string">"build:producer"</span>: <span class="string">"node build/webpack.producer.conf.js -p"</span></div><div class="line">&#125;,</div><div class="line"></div><div class="line"><span class="comment">//webpack.producer.conf.js</span></div><div class="line"><span class="keyword">var</span> webpack = <span class="built_in">require</span>(<span class="string">'webpack'</span>);</div><div class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</div><div class="line"><span class="keyword">var</span> WebpackDevServer = <span class="built_in">require</span>(<span class="string">'webpack-dev-server'</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> isprd = process.argv[<span class="number">2</span>] === <span class="string">'-p'</span>;</div><div class="line"></div><div class="line"><span class="keyword">var</span> config = &#123;</div><div class="line">  <span class="attr">entry</span>: &#123;</div><div class="line">    <span class="attr">app</span>: <span class="string">'./producerSrc/main.js'</span></div><div class="line">  &#125;,</div><div class="line">  <span class="attr">output</span>: &#123;</div><div class="line">    <span class="attr">publicPath</span>: <span class="string">'http://localhost:8080/static/'</span>,</div><div class="line">    <span class="attr">path</span>: path.resolve(__dirname, <span class="string">'../static'</span>),</div><div class="line">    <span class="attr">filename</span>: <span class="string">'producerBuild.js'</span></div><div class="line">  &#125;,</div><div class="line">  <span class="attr">module</span>: &#123;</div><div class="line">    <span class="attr">noParse</span>: <span class="regexp">/es6-promise\.js$/</span>,</div><div class="line">    <span class="attr">loaders</span>: [</div><div class="line">      &#123;</div><div class="line">        <span class="attr">test</span>: <span class="regexp">/\.vue$/</span>,</div><div class="line">        <span class="attr">loader</span>: <span class="string">'vue'</span></div><div class="line">      &#125;,</div><div class="line">      &#123;</div><div class="line">        <span class="attr">test</span>: <span class="regexp">/\.js$/</span>,</div><div class="line">        <span class="attr">exclude</span>: <span class="regexp">/node_modules|vue\/dist|vue-router\/|vue-loader\/|vue-hot-reload-api\//</span>,</div><div class="line">        <span class="attr">loader</span>: <span class="string">'babel'</span></div><div class="line">      &#125;,</div><div class="line">      &#123;</div><div class="line">        <span class="attr">test</span>: <span class="regexp">/\.(png|jpg)$/</span>,</div><div class="line">        <span class="attr">loader</span>: <span class="string">'url-loader?limit=8192'</span></div><div class="line">      &#125;</div><div class="line">    ]</div><div class="line">  &#125;,</div><div class="line">  <span class="attr">babel</span>: &#123;</div><div class="line">    <span class="attr">presets</span>: [<span class="string">'es2015'</span>],</div><div class="line">    <span class="attr">plugins</span>: [<span class="string">'transform-runtime'</span>]</div><div class="line">  &#125;,</div><div class="line">  <span class="attr">plugins</span>: [],</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">var</span> compiler;</div><div class="line"><span class="keyword">if</span> (isprd) &#123;</div><div class="line">  config.plugins.push(</div><div class="line">    <span class="keyword">new</span> webpack.DefinePlugin(&#123;</div><div class="line">      <span class="string">'process.env'</span>: &#123;</div><div class="line">        <span class="attr">NODE_ENV</span>: <span class="string">'"production"'</span></div><div class="line">      &#125;</div><div class="line">    &#125;),</div><div class="line">    <span class="keyword">new</span> webpack.optimize.UglifyJsPlugin(&#123;</div><div class="line">      <span class="attr">compress</span>: &#123;</div><div class="line">        <span class="attr">warnings</span>: <span class="literal">false</span></div><div class="line">      &#125;</div><div class="line">    &#125;),</div><div class="line">    <span class="keyword">new</span> webpack.optimize.OccurenceOrderPlugin()</div><div class="line">  );</div><div class="line">  compiler = webpack(config);</div><div class="line">  compiler.run(<span class="function"><span class="keyword">function</span>(<span class="params">err,stats</span>)</span>&#123;</div><div class="line">    <span class="keyword">if</span>(!err)</div><div class="line">      <span class="built_in">console</span>.log(<span class="string">"build success"</span>)</div><div class="line">  &#125;)</div><div class="line"></div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">  <span class="built_in">module</span>.exports.devtool = <span class="string">'#source-map'</span></div><div class="line">  config.entry.app = [<span class="string">"webpack-dev-server/client?http://localhost:8080/"</span>, <span class="string">"webpack/hot/dev-server"</span>].concat(config.entry.app);</div><div class="line">  config.plugins.push(</div><div class="line">    <span class="keyword">new</span> webpack.HotModuleReplacementPlugin()</div><div class="line">  );</div><div class="line">  compiler = webpack(config);</div><div class="line">  <span class="keyword">var</span> server = <span class="keyword">new</span> WebpackDevServer(compiler, &#123;</div><div class="line">    <span class="attr">hot</span>: <span class="literal">true</span>,</div><div class="line">    <span class="attr">noInfo</span>: <span class="literal">true</span>,</div><div class="line">    <span class="attr">filename</span>: config.output.filename,</div><div class="line">    <span class="attr">publicPath</span>: config.output.publicPath</div><div class="line">  &#125;);</div><div class="line">  server.listen(<span class="number">8080</span>, <span class="string">'127.0.0.1'</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'Listening at http://127.0.0.1:8080'</span>);</div><div class="line">  &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>首先要使用node api inline模式，需要将webpack-dev-server/client?<a href="http://localhost:8080/加入到所有的entry" target="_blank" rel="external">http://localhost:8080/加入到所有的entry</a> point。<br>要支持Hot Module Replacement，则需要</p>
<ol>
<li>在entry point中加入”webpack/hot/dev-server”</li>
<li>在plugin中加入new webpack.HotModuleReplacementPlugin()</li>
<li>在WebpackDevServer构造方法中设置hot:true<br>这里的publicPath一定要设置<a href="http://localhost:8080/static/，否则生成不了bundle.js文件" target="_blank" rel="external">http://localhost:8080/static/，否则生成不了bundle.js文件</a>.<br>另外也要注意到这里prd生成compiler之后还要调用一次run方法。</li>
</ol>
<h3 id="webpack-dev-middleware"><a href="#webpack-dev-middleware" class="headerlink" title="webpack-dev-middleware"></a>webpack-dev-middleware</h3><blockquote>
<p>The webpack-dev-middleware is a small middleware for a connect-based middleware stack. It uses webpack to compile assets in-memory and serve them. When a compilation is running every request to the served webpack assets is blocked until we have a stable bundle.</p>
</blockquote>
<p>webpack-dev-server就是使用它作为中间件，这里当然也可以单独剥离这个中间件出来使用。vue-cli的标准模板生成的代码使用的就是webpack-dev-middleware+express.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/11/02/20161102/" data-id="ciyvlrhop0025ocvrpewnmown" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/webpack/">webpack</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/webpack-dev-server/">webpack-dev-server</a></li></ul>

    </footer>
  </div>
  
</article>




  
    <article id="post-20161015" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/10/15/20161015/" class="article-date">
  <time datetime="2016-10-14T16:00:00.000Z" itemprop="datePublished">2016-10-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/js/">js</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/10/15/20161015/">vue+webpack单页应用及多页应用实现</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="项目背景"><a href="#项目背景" class="headerlink" title="项目背景"></a>项目背景</h3><p>最近做了两个vue的项目，一个是商城供货商端，做的是vue单页；另一个是商城用户端，做的是vue多页。事实上，现在的前端框架如angular，react，vue等的出现都是服务于web应用的，一般的实践也都是做spa。但是考虑到商城页面较多，图片较多，如果spa，可能占用内存过高，另外观察京东，淘宝web版本，也都是多页实现。所以还是选多页吧。<br>在这里忍不住要赞下vue。语法清晰简单；我之前也用过angular1，相比之下，vue的轻量化的组件化开发，模板渲染，单文件编写，丰富的生命周期hook，完善的文档；让人写起代码来都很爽，可以看作是吸收了angular和react的优点。如果是小的web应用或者是小的团队开发，我肯定优先选择vue。</p>
<h3 id="供货商端单页实现"><a href="#供货商端单页实现" class="headerlink" title="供货商端单页实现"></a>供货商端单页实现</h3><p>先看下目录结构和最终的效果图：</p>
<p><div><br><img src="http://ww1.sinaimg.cn/mw690/a5e2541bgw1f8svtku3nfj20a70l0q4b.jpg" style="font-size:0; width:33%"><br><img src="http://ww4.sinaimg.cn/mw690/a5e2541bgw1f8sw4kf7sdj20bv0dlgmc.jpg" style="font-size:0; width:33%"><br><img src="http://ww1.sinaimg.cn/mw690/a5e2541bgw1f8sw4x0qv6j20ce0kx0ua.jpg" style="font-size:0; width:33%"><br></div><br>项目链接:<a href="http://saas-1014-100001.m.izhuazhua.com/appProducer/producerIndex.jsp" target="_blank" rel="external">http://saas-1014-100001.m.izhuazhua.com/appProducer/producerIndex.jsp</a></p>
<p>webpack代码如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> webpack = <span class="built_in">require</span>(<span class="string">'webpack'</span>)</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = &#123;</div><div class="line">  <span class="attr">entry</span>: <span class="string">'./src/main.js'</span>,</div><div class="line">  <span class="attr">output</span>: &#123;</div><div class="line">    <span class="attr">path</span>: <span class="string">'./static'</span>,</div><div class="line">    <span class="attr">publicPath</span>: <span class="string">'/static/'</span>,</div><div class="line">    <span class="attr">filename</span>: <span class="string">'build.js'</span></div><div class="line">  &#125;,</div><div class="line">  <span class="attr">module</span>: &#123;</div><div class="line">    <span class="attr">noParse</span>: <span class="regexp">/es6-promise\.js$/</span>,</div><div class="line">    <span class="attr">loaders</span>: [</div><div class="line">      &#123;</div><div class="line">        <span class="attr">test</span>: <span class="regexp">/\.vue$/</span>,</div><div class="line">        <span class="attr">loader</span>: <span class="string">'vue'</span></div><div class="line">      &#125;,</div><div class="line">      &#123;</div><div class="line">        <span class="attr">test</span>: <span class="regexp">/\.js$/</span>,</div><div class="line">        <span class="attr">exclude</span>: <span class="regexp">/node_modules|vue\/dist|vue-router\/|vue-loader\/|vue-hot-reload-api\//</span>,</div><div class="line">        <span class="attr">loader</span>: <span class="string">'babel'</span></div><div class="line">      &#125;,</div><div class="line">      &#123;</div><div class="line">        <span class="attr">test</span>: <span class="regexp">/\.(png|jpg)$/</span>,</div><div class="line">        <span class="attr">loader</span>: <span class="string">'url-loader?limit=8192'</span></div><div class="line">      &#125;</div><div class="line">    ]</div><div class="line">  &#125;,</div><div class="line">  <span class="attr">babel</span>: &#123;</div><div class="line">    <span class="attr">presets</span>: [<span class="string">'es2015'</span>],</div><div class="line">    <span class="attr">plugins</span>: [<span class="string">'transform-runtime'</span>]</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">if</span> (process.env.NODE_ENV === <span class="string">'production'</span>) &#123;</div><div class="line">  <span class="built_in">module</span>.exports.plugins = [</div><div class="line">    <span class="keyword">new</span> webpack.DefinePlugin(&#123;</div><div class="line">      <span class="string">'process.env'</span>: &#123;</div><div class="line">        <span class="attr">NODE_ENV</span>: <span class="string">'"production"'</span></div><div class="line">      &#125;</div><div class="line">    &#125;),</div><div class="line">    <span class="keyword">new</span> webpack.optimize.UglifyJsPlugin(&#123;</div><div class="line">      <span class="attr">compress</span>: &#123;</div><div class="line">        <span class="attr">warnings</span>: <span class="literal">false</span></div><div class="line">      &#125;</div><div class="line">    &#125;),</div><div class="line">    <span class="keyword">new</span> webpack.optimize.OccurenceOrderPlugin()</div><div class="line">  ]</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">  <span class="built_in">module</span>.exports.devtool = <span class="string">'#source-map'</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>entry指定入口文件是src/main.js。生成的build.js文件到static目录下。loader中看下使用到了vue-loader来处理.vue结尾的文件。<a href="http://vue-loader.vuejs.org/en/start/spec.html" target="_blank" rel="external">A <em>.vue file is a custom file format that uses HTML-like syntax to describe a Vue component. Each </em>.vue file consists of three types of top-level language blocks: <template></template>, <script></script> and <style></style></a>。本次项目所有的component都是采用这种单文件.vue的形式编写的，这也是官方推荐的，简洁直观。<br>而vue-loader就是为解析vue文件的loader，它有如下几个<a href="http://vue-loader.vuejs.org/en/index.html" target="_blank" rel="external">功能</a>:</p>
<ul>
<li>ES2015 enabled by default;（自动支持es2015语法）</li>
<li>Allows using other Webpack loaders for each part of a Vue component, for example SASS for <style> and Jade for <template></template>;（能够支持saas语法和jade模板）</li>
<li>Treat static assets referenced in <style></style> and <template></template> as module dependencies and handle them with Webpack loaders;（将style和template作为模块）</li>
<li>Can simulate scoped CSS for each component;（能够支持组件内样式，其实就是使用了属性选择器。对于每个class生成一个唯一的attr值。.goods_item[_v-6a5a53f4] 然后以的方式添加样式）</li>
<li>Supports component hot-reloading during development.(开发阶段支持组件的热加载)</li>
</ul>
<p>我们看下入口文件main.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">'vue'</span></div><div class="line"><span class="keyword">import</span> Router <span class="keyword">from</span> <span class="string">'vue-router'</span></div><div class="line"><span class="keyword">import</span> App <span class="keyword">from</span> <span class="string">'./containers/App.vue'</span></div><div class="line"><span class="keyword">import</span> OrdersView <span class="keyword">from</span> <span class="string">'./components/Orders.vue'</span></div><div class="line"><span class="keyword">import</span> OrderView <span class="keyword">from</span> <span class="string">'./components/Order.vue'</span></div><div class="line"></div><div class="line"><span class="comment">// install router</span></div><div class="line">Vue.use(Router)</div><div class="line"></div><div class="line"><span class="comment">// routing</span></div><div class="line"><span class="keyword">var</span> router = <span class="keyword">new</span> Router()</div><div class="line"></div><div class="line">router.map(&#123;</div><div class="line">  <span class="string">'/orders'</span>: &#123;</div><div class="line">    <span class="attr">component</span>: <span class="function"><span class="keyword">function</span>(<span class="params">resolve</span>)</span>&#123;</div><div class="line">      <span class="built_in">require</span>([<span class="string">'./components/Orders.vue'</span>], resolve)</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  <span class="string">'/order/:id'</span>: &#123;</div><div class="line">    <span class="attr">component</span>: <span class="function"><span class="keyword">function</span>(<span class="params">resolve</span>)</span>&#123;</div><div class="line">      <span class="built_in">require</span>([<span class="string">'./components/Order.vue'</span>], resolve)</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;)</div><div class="line"></div><div class="line">router.redirect(&#123;</div><div class="line">  <span class="string">'*'</span>: <span class="string">'/orders'</span></div><div class="line">&#125;)</div><div class="line"></div><div class="line">router.start(App, <span class="string">'#app'</span>)</div></pre></td></tr></table></figure></p>
<p>这里在main.js中创建了一个路由器模块router,并且配置了路由信息。在App.vue组件中有router-view作为容器，匹配到的页面会渲染在其中。vue-router的详细介绍在<a href="http://router.vuejs.org/zh-cn/essentials/getting-started.html" target="_blank" rel="external">这里</a><br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"wrapper"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">router-view</span></span></div><div class="line">      <span class="attr">class</span>=<span class="string">"view"</span></div><div class="line">      <span class="attr">keep-alive</span>&gt;<span class="tag">&lt;/<span class="name">router-view</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>路由组件都很相似，vue-router就和angular的ui-router很接近。而且vue-router还提供了滚动位置的保持，省去了很多事情。总的来说vue单页应用其实上手很简单，而且vue官方还提供了脚手架工具vue-cli。连webpack的配置都可以自动完成。</p>
<h3 id="商城多页实现"><a href="#商城多页实现" class="headerlink" title="商城多页实现"></a>商城多页实现</h3><p>先看下目录结构和最终的效果图：</p>
<p><div><br><img src="http://ww4.sinaimg.cn/mw690/a5e2541bgw1f8wl0dkyr0j20b00qlwge.jpg" style="font-size:0; width:33%"><br><img src="http://ww4.sinaimg.cn/mw690/a5e2541bgw1f8wl0ca1mdj20ai0mbmym.jpg" style="font-size:0; width:33%"><br><img src="http://ww1.sinaimg.cn/mw690/a5e2541bgw1f8wl0dchp9j20dm0m8diz.jpg" style="font-size:0; width:33%"><br><img src="http://ww2.sinaimg.cn/mw690/a5e2541bgw1f8wl0dizrlj20dn0lymz5.jpg" style="font-size:0; width:33%"><br></div><br>项目链接：</p>
<ol>
<li><a href="http://saas-1014-100001.m.izhuazhua.com/appMarket/dist/home.jsp" target="_blank" rel="external">http://saas-1014-100001.m.izhuazhua.com/appMarket/dist/home.jsp</a></li>
<li><a href="http://saas-1014-100001.m.izhuazhua.com/appMarket/dist/orders.jsp" target="_blank" rel="external">http://saas-1014-100001.m.izhuazhua.com/appMarket/dist/orders.jsp</a></li>
</ol>
<p>多页下比较麻烦，首先webpack entry需要设置多个。这里设置的是container下的所有js作为入口js；在getEntry中使用到了node的glob模块，这个模块可以通过编写一个正则来匹配筛选文件。glob匹配文件的操作一般是异步的，但这里采用sync匹配。sync的返回值是一个文件的列表。module.exports.out的设置也因为测试环境很正式环境有所不同：</p>
<ul>
<li>development环境中采用的是HtmlWebpackPlugin生成多个页面。</li>
<li>production环境由于最终页面使用的是jsp而不是html,所以HtmlWebpackPlugin插件自然没有效果，采用自己编写plugin，在回调中通过stats.toJson().assetsByChunkName;可以获取到js chunk带上hash之后的filename，再通过node原生fs模块，对src/下的jsp文件处理，替换hash之后的js url。生成新的jsp文件到dist中。<br>这就是大概的思路。</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//webpack.config.js</span></div><div class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</div><div class="line"><span class="keyword">var</span> webpack = <span class="built_in">require</span>(<span class="string">'webpack'</span>);</div><div class="line"><span class="keyword">var</span> ExtractTextPlugin = <span class="built_in">require</span>(<span class="string">'extract-text-webpack-plugin'</span>); <span class="comment">// 将样式提取到单独的css文件中，而不是打包到js文件或使用style标签插入在head标签中</span></div><div class="line"><span class="keyword">var</span> HtmlWebpackPlugin = <span class="built_in">require</span>(<span class="string">'html-webpack-plugin'</span>); <span class="comment">// 生成自动引用js文件的HTML</span></div><div class="line"><span class="keyword">var</span> glob = <span class="built_in">require</span>(<span class="string">'glob'</span>);</div><div class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">// 根据项目具体需求，具体可以看上面的项目目录，输出正确的js和html路径</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">getEntry</span>(<span class="params">globPath</span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> entries = &#123;&#125;, basename, tmp, pathname;</div><div class="line">  glob.sync(globPath).forEach(<span class="function"><span class="keyword">function</span> (<span class="params">entry</span>) </span>&#123;</div><div class="line">    basename = path.basename(entry, path.extname(entry));</div><div class="line">    tmp = entry.split(<span class="string">'/'</span>).splice(<span class="number">-3</span>);</div><div class="line">    pathname = tmp.splice(<span class="number">0</span>, <span class="number">1</span>) + <span class="string">'/'</span> + basename; <span class="comment">// 正确输出js和html的路径</span></div><div class="line">    entries[pathname] = entry;</div><div class="line">  &#125;);</div><div class="line">  <span class="keyword">return</span> entries;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">var</span> entries = getEntry(<span class="string">'./src/containers/*.js'</span>); <span class="comment">// 获得入口js文件</span></div><div class="line"><span class="keyword">var</span> chunks = <span class="built_in">Object</span>.keys(entries);</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = &#123;</div><div class="line">  <span class="attr">entry</span>: entries,</div><div class="line"></div><div class="line">  <span class="attr">resolve</span>: &#123;</div><div class="line">    <span class="attr">extensions</span>: [<span class="string">''</span>, <span class="string">'.js'</span>, <span class="string">'.vue'</span>]</div><div class="line">  &#125;,</div><div class="line"></div><div class="line">  <span class="attr">module</span>: &#123;</div><div class="line">    <span class="attr">loaders</span>: [</div><div class="line">      <span class="comment">//&#123;</span></div><div class="line">      <span class="comment">//  test: /\.css$/,</span></div><div class="line">        <span class="comment">// 使用提取css文件的插件，能帮我们提取webpack中引用的和vue组件中使用的样式</span></div><div class="line">      <span class="comment">//  loader: ExtractTextPlugin.extract('style-loader', 'css-loader')</span></div><div class="line">      <span class="comment">//&#125;,</span></div><div class="line">      &#123;</div><div class="line">        <span class="attr">test</span>: <span class="regexp">/\.vue$/</span>,</div><div class="line">        <span class="attr">loader</span>: <span class="string">'vue'</span>     <span class="comment">//vue-loader</span></div><div class="line">      &#125;,</div><div class="line">      &#123;</div><div class="line">        <span class="attr">test</span>: <span class="regexp">/\.js$/</span>,</div><div class="line">        <span class="attr">loader</span>: <span class="string">'babel'</span>,</div><div class="line">        <span class="attr">exclude</span>: <span class="regexp">/node_modules|vue\/dist|vue-router\/|vue-loader\/|vue-hot-reload-api\//</span>,</div><div class="line">      &#125;,</div><div class="line">      &#123;</div><div class="line">        <span class="attr">test</span>: <span class="regexp">/\.(png|jpg|gif|svg)$/</span>,</div><div class="line">        <span class="attr">loader</span>: <span class="string">'url'</span>,</div><div class="line">        <span class="attr">query</span>: &#123;</div><div class="line">          <span class="attr">limit</span>: <span class="number">10000</span>,</div><div class="line">          <span class="attr">name</span>: <span class="string">'./imgs/[name].[ext]?[hash:7]'</span></div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    ]</div><div class="line">  &#125;,</div><div class="line"></div><div class="line">  <span class="comment">// vue: &#123;      //这里是对vue-loader的配置，http://vue-loader.vuejs.org/en/configurations/extract-css.html</span></div><div class="line">  <span class="comment">//   loaders: &#123;</span></div><div class="line">  <span class="comment">//     css: ExtractTextPlugin.extract('css'),</span></div><div class="line">  <span class="comment">//     // you can also include &lt;style lang="less"&gt; or other langauges</span></div><div class="line">  <span class="comment">//     less: ExtractTextPlugin.extract("css!less")</span></div><div class="line">  <span class="comment">//   &#125;</span></div><div class="line">  <span class="comment">// &#125;,</span></div><div class="line"></div><div class="line">  babel: &#123;</div><div class="line">    <span class="attr">presets</span>: [<span class="string">'es2015'</span>],</div><div class="line">    <span class="attr">plugins</span>: [<span class="string">'transform-runtime'</span>]</div><div class="line">  &#125;,</div><div class="line"></div><div class="line">  <span class="attr">plugins</span>: [</div><div class="line">    <span class="comment">// 提取公共模块</span></div><div class="line">    <span class="keyword">new</span> webpack.optimize.CommonsChunkPlugin(&#123;</div><div class="line">      <span class="attr">name</span>: <span class="string">'vendors'</span>, <span class="comment">// 公共模块的名称</span></div><div class="line">      chunks: chunks,  <span class="comment">// chunks是需要提取的模块</span></div><div class="line">      minChunks: chunks.length</div><div class="line">    &#125;)</div><div class="line">    <span class="comment">// 配置提取出的样式文件</span></div><div class="line">    <span class="comment">// new ExtractTextPlugin('css/style.css')</span></div><div class="line">  ]</div><div class="line">&#125;;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">var</span> prod = process.env.NODE_ENV === <span class="string">'prod'</span>;     <span class="comment">//run dev. prod为prodution</span></div><div class="line"><span class="built_in">console</span>.log(<span class="string">'process.env.NODE_ENV-------------------：'</span>+process.env.NODE_ENV);</div><div class="line"><span class="keyword">if</span> (prod) &#123;</div><div class="line">  <span class="comment">//chunkhash不支持热更新。但是和chunk本身有关； hash则每次编译都不一样，但是它支持热更新</span></div><div class="line">  <span class="built_in">module</span>.exports.output = &#123;</div><div class="line">    <span class="attr">path</span>: path.resolve(__dirname, <span class="string">'dist'</span>),            <span class="comment">// html,css,js,图片等资源文件的输出路径，将所有资源文件放在Public目录</span></div><div class="line">    filename: <span class="string">'js/[name].[chunkhash:8].js'</span>           <span class="comment">// 每个入口js文件的生成配置  js/[name].[hash].js</span></div><div class="line">  &#125;;</div><div class="line">  <span class="built_in">module</span>.exports.plugins = <span class="built_in">module</span>.exports.plugins.concat([</div><div class="line">    <span class="keyword">new</span> webpack.DefinePlugin(&#123;</div><div class="line">      <span class="string">'process.env'</span>: &#123;</div><div class="line">        <span class="attr">NODE_ENV</span>: <span class="string">'"production"'</span></div><div class="line">      &#125;</div><div class="line">    &#125;),</div><div class="line">    <span class="keyword">new</span> webpack.optimize.UglifyJsPlugin(&#123;</div><div class="line">      <span class="attr">compress</span>: &#123;</div><div class="line">        <span class="attr">warnings</span>: <span class="literal">false</span></div><div class="line">      &#125;</div><div class="line">    &#125;),</div><div class="line">    <span class="keyword">new</span> webpack.optimize.OccurenceOrderPlugin(),</div><div class="line">    <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">      <span class="keyword">this</span>.plugin(<span class="string">'done'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">stats</span>)</span>&#123;        <span class="comment">//可以获取hash之后的filename</span></div><div class="line">        <span class="comment">// console.log(stats.toJson().assetsByChunkName);</span></div><div class="line">        <span class="keyword">var</span> chunkhashname = stats.toJson().assetsByChunkName;</div><div class="line">        <span class="keyword">var</span> text, key, hashname, filename;</div><div class="line">        <span class="keyword">for</span>(key <span class="keyword">in</span> chunkhashname)&#123;</div><div class="line">          <span class="keyword">if</span>(key != <span class="string">'vendors'</span>)&#123;</div><div class="line">            text = fs.readFileSync(key+<span class="string">'.jsp'</span>).toString();</div><div class="line"></div><div class="line">            hashname = chunkhashname[key];</div><div class="line">            filename = hashname.match(<span class="regexp">/\S*\/([^.]*)/i</span>)[<span class="number">1</span>];</div><div class="line">            text = text.replace(<span class="string">'js/vendors.js'</span>, chunkhashname[<span class="string">'vendors'</span>]);     <span class="comment">//替换vendors</span></div><div class="line">            text = text.replace(hashname.split(<span class="string">'.'</span>)[<span class="number">0</span>]+<span class="string">'.js'</span>, hashname);</div><div class="line">            fs.writeFileSync(<span class="string">'dist/'</span>+filename+<span class="string">'.jsp'</span>, text, <span class="string">'utf-8'</span>);</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">        fs.writeFileSync(<span class="string">'dist/common.jsp'</span>, fs.readFileSync(<span class="string">'src/common.jsp'</span>).toString(), <span class="string">'utf-8'</span>);</div><div class="line">        fs.writeFileSync(<span class="string">'dist/checklogin.jsp'</span>, fs.readFileSync(<span class="string">'src/checklogin.jsp'</span>).toString(), <span class="string">'utf-8'</span>);</div><div class="line">      &#125;);</div><div class="line">    &#125;</div><div class="line">  ]);</div><div class="line"></div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">  <span class="built_in">module</span>.exports.output = &#123;</div><div class="line">    <span class="attr">path</span>: path.resolve(__dirname, <span class="string">'dist'</span>),            <span class="comment">// html,css,js,图片等资源文件的输出路径，将所有资源文件放在Public目录</span></div><div class="line">    filename: <span class="string">'js/[name].js'</span>           <span class="comment">// 每个入口js文件的生成配置  js/[name].[hash].js</span></div><div class="line">  &#125;;</div><div class="line">  <span class="built_in">module</span>.exports.devtool = <span class="string">'source-map'</span>;</div><div class="line"></div><div class="line">  <span class="keyword">var</span> pages = getEntry(<span class="string">'./src/*.html'</span>);</div><div class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> pathname <span class="keyword">in</span> pages) &#123;</div><div class="line">    <span class="keyword">if</span>(pathname.indexOf(<span class="string">'common'</span>)==<span class="number">-1</span>)&#123;</div><div class="line">      <span class="comment">// 配置生成的html文件。chunks限制插入html的chunk，可以直接打印chunks数组查看</span></div><div class="line">      <span class="keyword">var</span> conf = &#123;</div><div class="line">        <span class="attr">filename</span>: prod?  pathname + <span class="string">'.html'</span> : pathname + <span class="string">'.html'</span>,</div><div class="line">        <span class="attr">template</span>: pages[pathname],   <span class="comment">// 模板路径</span></div><div class="line">        inject: <span class="string">'body'</span>,              <span class="comment">// js插入位置</span></div><div class="line">        minify: &#123;</div><div class="line">          <span class="attr">removeComments</span>: <span class="literal">true</span>,</div><div class="line">          <span class="attr">collapseWhitespace</span>: <span class="literal">false</span></div><div class="line">        &#125;,</div><div class="line">        <span class="attr">chunks</span>: [<span class="string">'vendors'</span>, <span class="string">'src/'</span>+pathname.slice(<span class="number">2</span>)],</div><div class="line">        <span class="attr">hash</span>: <span class="literal">false</span></div><div class="line">      &#125;;</div><div class="line">      <span class="comment">// 需要生成几个html文件，就配置几个HtmlWebpackPlugin对象</span></div><div class="line">      <span class="built_in">module</span>.exports.plugins.push(<span class="keyword">new</span> HtmlWebpackPlugin(conf));</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">// src/containers/home.js</span></div><div class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">'vue'</span></div><div class="line"><span class="keyword">import</span> Home <span class="keyword">from</span> <span class="string">'../components/home.vue'</span></div><div class="line"><span class="keyword">import</span> LoginUtil <span class="keyword">from</span> <span class="string">'../utils/login.js'</span></div><div class="line"></div><div class="line"><span class="keyword">let</span> ut = <span class="keyword">new</span> LoginUtil();</div><div class="line">ut.checkLogin().then(<span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</div><div class="line">    <span class="keyword">new</span> Vue(&#123;</div><div class="line">        <span class="attr">el</span>: <span class="string">'body'</span>,</div><div class="line">        <span class="attr">components</span>: &#123; Home &#125;</div><div class="line">    &#125;)</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>整体就是这样，每个页面都有一个主component渲染页面，而这个主要的component又是由很多小的component组成。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/10/15/20161015/" data-id="ciyvlrhok0024ocvr6inzramm" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/vue/">vue</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/vue-router/">vue-router</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/webpack/">webpack</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/单页/">单页</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/多页/">多页</a></li></ul>

    </footer>
  </div>
  
</article>




  
    <article id="post-20161013" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/10/13/20161013/" class="article-date">
  <time datetime="2016-10-12T16:00:00.000Z" itemprop="datePublished">2016-10-13</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/js/">js</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/10/13/20161013/">iscroll源码解析及vue下拉刷新与上拉加载组件实现</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="项目背景"><a href="#项目背景" class="headerlink" title="项目背景"></a>项目背景</h3><p>最近刚刚用vue完成了一个商城项目，ui给的页面里有个如下图的经典滚动组件，带有下拉刷新和上拉加载的功能。我不禁虎躯一震，有点意思。<br><img src="http://ww1.sinaimg.cn/mw690/a5e2541bgw1f8qko2rki9j20dn0lymz5.jpg"><br>鉴于老板一直比较讨厌微信下拉露黑底的问题（其实我一直觉得这不是问题，京东也这样）。还是照例使用IScroll-lite作为滚动组件。</p>
<h3 id="iscroll-lite源码解析"><a href="#iscroll-lite源码解析" class="headerlink" title="iscroll-lite源码解析"></a>iscroll-lite源码解析</h3><p>iscroll-lite作为iscroll专为移动端所做的精简版，代码控制在1000行以内。<br>首先肯定考虑到从touchstart，touchmove，touchend事件回调入手<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="number">327</span>:   <span class="keyword">this</span>._init();</div><div class="line"></div><div class="line"><span class="number">352</span>:   _init: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">            <span class="keyword">this</span>._initEvents();</div><div class="line">        &#125;,</div><div class="line">    </div><div class="line"><span class="number">895</span>:   _initEvents: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">            <span class="keyword">var</span> eventType = remove ? utils.removeEvent : utils.addEvent,</div><div class="line">			target = <span class="keyword">this</span>.options.bindToWrapper ? <span class="keyword">this</span>.wrapper : <span class="built_in">window</span>;</div><div class="line">            .......</div><div class="line">            if ( utils.hasTouch &amp;&amp; !<span class="keyword">this</span>.options.disableTouch ) &#123;</div><div class="line">                eventType(<span class="keyword">this</span>.wrapper, <span class="string">'touchstart'</span>, <span class="keyword">this</span>);</div><div class="line">                eventType(target, <span class="string">'touchmove'</span>, <span class="keyword">this</span>);</div><div class="line">                eventType(target, <span class="string">'touchcancel'</span>, <span class="keyword">this</span>);</div><div class="line">                eventType(target, <span class="string">'touchend'</span>, <span class="keyword">this</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line"><span class="number">50</span>:     me.addEvent = <span class="function"><span class="keyword">function</span> (<span class="params">el, type, fn, capture</span>) </span>&#123;</div><div class="line">            el.addEventListener(type, fn, !!capture);</div><div class="line">        &#125;;</div><div class="line">        me.removeEvent = <span class="function"><span class="keyword">function</span> (<span class="params">el, type, fn, capture</span>) </span>&#123;</div><div class="line">            el.removeEventListener(type, fn, !!capture);</div><div class="line">        &#125;;</div></pre></td></tr></table></figure></p>
<p>我们可以清楚的看到在IScroll构造函数中调用prototype中的_init方法，完成事件的初始化，这里将this也就是当前对象this传递给addEventListener的第二个参数，那么比较下下面两种事件的注册方式：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// using funcion handle</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">clickHandler</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'clickHandler:'</span>, <span class="keyword">this</span>);         <span class="comment">//document</span></div><div class="line">&#125;</div><div class="line"><span class="built_in">document</span>.addEventListener(<span class="string">'click'</span>, clickHandler, <span class="literal">false</span>);</div><div class="line"></div><div class="line"><span class="comment">// using obj handle</span></div><div class="line"><span class="keyword">var</span> handleObj = &#123;</div><div class="line">    <span class="attr">handleEvent</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">"handleEvent obj:"</span>, <span class="keyword">this</span>);              <span class="comment">//handleObj</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="built_in">document</span>.addEventListener(<span class="string">'click'</span>, handleObj, <span class="literal">false</span>);</div></pre></td></tr></table></figure></p>
<p>可以看出使用function handler，this指向的是绑定事件的元素本身；使用object handler，this指向的是该对象。而IScroll使用的就是object handler，它将为IScroll.prototype添加了handleEvent方法，使得其更容易调用原型上的其他方法。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">handleEvent: <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</div><div class="line">	<span class="keyword">switch</span> ( e.type ) &#123;</div><div class="line">		<span class="keyword">case</span> <span class="string">'touchstart'</span>:</div><div class="line">		<span class="keyword">case</span> <span class="string">'pointerdown'</span>:</div><div class="line">		<span class="keyword">case</span> <span class="string">'MSPointerDown'</span>:</div><div class="line">		<span class="keyword">case</span> <span class="string">'mousedown'</span>:</div><div class="line">			<span class="comment">//add code</span></div><div class="line">			<span class="keyword">this</span>.options.touchstartCall();</div><div class="line">			<span class="keyword">this</span>._start(e);</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		<span class="keyword">case</span> <span class="string">'touchmove'</span>:</div><div class="line">		<span class="keyword">case</span> <span class="string">'pointermove'</span>:</div><div class="line">		<span class="keyword">case</span> <span class="string">'MSPointerMove'</span>:</div><div class="line">		<span class="keyword">case</span> <span class="string">'mousemove'</span>:</div><div class="line">			<span class="keyword">this</span>._move(e);</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		<span class="keyword">case</span> <span class="string">'touchend'</span>:</div><div class="line">		<span class="keyword">case</span> <span class="string">'pointerup'</span>:</div><div class="line">		<span class="keyword">case</span> <span class="string">'MSPointerUp'</span>:</div><div class="line">		<span class="keyword">case</span> <span class="string">'mouseup'</span>:</div><div class="line">		<span class="keyword">case</span> <span class="string">'touchcancel'</span>:</div><div class="line">		<span class="keyword">case</span> <span class="string">'pointercancel'</span>:</div><div class="line">		<span class="keyword">case</span> <span class="string">'MSPointerCancel'</span>:</div><div class="line">		<span class="keyword">case</span> <span class="string">'mousecancel'</span>:</div><div class="line">			<span class="comment">//add code</span></div><div class="line">			<span class="keyword">this</span>.options.touchendCall();				<span class="comment">//在_end函数中resetPosition之前调用touchendcall</span></div><div class="line">			<span class="keyword">this</span>._end(e);</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">           .........</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<h4 id="滑动加速度的实现"><a href="#滑动加速度的实现" class="headerlink" title="滑动加速度的实现"></a>滑动加速度的实现</h4><p>之后在_start回调函数中记录了startX，absStartX等等起始值。在_move回调中this._translate(newX, newY);进行页面css3位移，以垂直滚动的newY计算为例：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//522</span></div><div class="line">newY = <span class="keyword">this</span>.y + deltaY;         <span class="comment">//this.y是当前滚动y值</span></div><div class="line"><span class="comment">//467</span></div><div class="line"><span class="keyword">var</span> point = e.touches ? e.touches[<span class="number">0</span>] : e,   </div><div class="line"><span class="comment">//469</span></div><div class="line">deltaY = point.pageY - <span class="keyword">this</span>.pointY,     </div><div class="line"><span class="comment">//474</span></div><div class="line"><span class="keyword">this</span>.pointY	= point.pageY;</div></pre></td></tr></table></figure></p>
<p>可以看出当你快速滑动的时候，deltaY作为垂直方向的加速度，值也越大，页面也会滑动更迅速。这就是滑动加速的实现。</p>
<h4 id="bounce效果的实现"><a href="#bounce效果的实现" class="headerlink" title="bounce效果的实现"></a>bounce效果的实现</h4><p>还是以垂直滚动为例，其实还是newY的计算问题。看_move方法中的这段<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">  <span class="comment">//_move</span></div><div class="line">  <span class="keyword">if</span> ( newY &gt; <span class="number">0</span> || newY &lt; <span class="keyword">this</span>.maxScrollY ) &#123;</div><div class="line">      newY = <span class="keyword">this</span>.options.bounce ? <span class="keyword">this</span>.y + deltaY / <span class="number">3</span> : newY &gt; <span class="number">0</span> ? <span class="number">0</span> : <span class="keyword">this</span>.maxScrollY;</div><div class="line">  &#125;</div><div class="line">  <span class="comment">//_end</span></div><div class="line">  <span class="keyword">if</span> ( <span class="keyword">this</span>.resetPosition(<span class="keyword">this</span>.options.bounceTime) ) &#123;</div><div class="line">      <span class="keyword">return</span>;</div><div class="line">  &#125;</div><div class="line">  resetPosition&#123;</div><div class="line">      <span class="comment">//......</span></div><div class="line">      <span class="keyword">if</span> ( !<span class="keyword">this</span>.hasVerticalScroll || <span class="keyword">this</span>.y &gt; <span class="number">0</span> ) &#123;</div><div class="line">	y = <span class="number">0</span>;</div><div class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> ( <span class="keyword">this</span>.y &lt; <span class="keyword">this</span>.maxScrollY ) &#123;</div><div class="line">	y = <span class="keyword">this</span>.maxScrollY;</div><div class="line">&#125;</div><div class="line">      <span class="comment">//......</span></div><div class="line">      <span class="keyword">this</span>.scrollTo(x, y, time, <span class="keyword">this</span>.options.bounceEasing);</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>newY &gt; 0就是上滑超出边界，newY &lt; this.maxScrollY就是下滑超出边界。这时，this.options.bounce默认值为true，newY的值就以this.y + deltaY / 3减速增长。在_end中又调用resetPosition，resetPostion scrollTo正常的边界，这就是bounce的实现</p>
<h4 id="scrollTo滚动的实现"><a href="#scrollTo滚动的实现" class="headerlink" title="scrollTo滚动的实现"></a>scrollTo滚动的实现</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line"> <span class="comment">//iscroll-probe中代码</span></div><div class="line"> <span class="keyword">if</span> ( <span class="keyword">this</span>.options.probeType == <span class="number">3</span> ) &#123;</div><div class="line">     <span class="keyword">this</span>.options.useTransition = <span class="literal">false</span>;	</div><div class="line"> &#125;</div><div class="line"></div><div class="line"> scrollTo: <span class="function"><span class="keyword">function</span> (<span class="params">x, y, time, easing</span>) </span>&#123;</div><div class="line">	easing = easing || utils.ease.circular;</div><div class="line"></div><div class="line">	<span class="keyword">this</span>.isInTransition = <span class="keyword">this</span>.options.useTransition &amp;&amp; time &gt; <span class="number">0</span>;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> ( !time || (<span class="keyword">this</span>.options.useTransition &amp;&amp; easing.style) ) &#123;</div><div class="line">		<span class="keyword">this</span>._transitionTimingFunction(easing.style);</div><div class="line">		<span class="keyword">this</span>._transitionTime(time);</div><div class="line">		<span class="keyword">this</span>._translate(x, y);</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="keyword">this</span>._animate(x, y, time, easing.fn);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"> _animate: <span class="function"><span class="keyword">function</span> (<span class="params">destX, destY, duration, easingFn</span>) </span>&#123;</div><div class="line">	<span class="keyword">var</span> that = <span class="keyword">this</span>,</div><div class="line">		startX = <span class="keyword">this</span>.x,</div><div class="line">		startY = <span class="keyword">this</span>.y,</div><div class="line">		startTime = utils.getTime(),</div><div class="line">		destTime = startTime + duration;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">function</span> <span class="title">step</span> (<span class="params"></span>) </span>&#123;</div><div class="line">		<span class="keyword">var</span> now = utils.getTime(),</div><div class="line">			newX, newY,</div><div class="line">			easing;</div><div class="line">		<span class="keyword">if</span> ( now &gt;= destTime ) &#123;</div><div class="line">			that.isAnimating = <span class="literal">false</span>;</div><div class="line">			that._translate(destX, destY);</div><div class="line"></div><div class="line">			<span class="keyword">if</span> ( !that.resetPosition(that.options.bounceTime) ) &#123;</div><div class="line">				that._execEvent(<span class="string">'scrollEnd'</span>);</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">return</span>;</div><div class="line">		&#125;</div><div class="line">		now = ( now - startTime ) / duration;</div><div class="line">		easing = easingFn(now);</div><div class="line">		newX = ( destX - startX ) * easing + startX;</div><div class="line">		newY = ( destY - startY ) * easing + startY;</div><div class="line">		that._translate(newX, newY);</div><div class="line"></div><div class="line">		<span class="keyword">if</span>(that.isAnimating) &#123;</div><div class="line">			tempRfa = rAF(step);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> ( !!that.options.pullupH ) &#123;</div><div class="line">			that._execEvent(<span class="string">'scroll'</span>);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">this</span>.isAnimating = <span class="literal">true</span>;</div><div class="line">	step();</div><div class="line">&#125;,</div></pre></td></tr></table></figure>
<p>由于会下拉刷新和上拉加载更多会需要监听滚动事件，而iscroll-probe中需要监听滚动时将useTransition设置为false，导致滚动调用的一致都是_animate，_animate方法用到了requestAnimationFrame，也就是逐帧动画，每一帧绘制结束之后调用step函数，完成滚动的动画实现。</p>
<p><b>IScroll的主要代码分析大概就是这样，接下来到了vue刷新组件的实现</b></p>
<h3 id="vue滚动刷新插件的实现"><a href="#vue滚动刷新插件的实现" class="headerlink" title="vue滚动刷新插件的实现"></a>vue滚动刷新插件的实现</h3><p>先贴出项目github地址：<a href="https://github.com/uniquezhuo/vue-pull-to-refresh-and-load-more" target="_blank" rel="external">vue pullup refresh and pulldown loadmore component</a><br>这是可能出现的状态:<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">:id</span>=<span class="string">"wrapperId"</span> <span class="attr">class</span>=<span class="string">"wrapper"</span>&gt;</span></div><div class="line">  	<span class="tag">&lt;<span class="name">div</span> <span class="attr">:id</span>=<span class="string">"scrollId"</span> <span class="attr">class</span>=<span class="string">"scroll"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">v-if</span>=<span class="string">"needRefresh"</span> <span class="attr">class</span>=<span class="string">"pullup"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">v-show</span>=<span class="string">"pullupStatus==1"</span>&gt;</span>↓下拉刷新<span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">v-show</span>=<span class="string">"pullupStatus==2"</span>&gt;</span>↑释放立即刷新<span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">v-show</span>=<span class="string">"pullupStatus==3"</span>&gt;</span>加载中...<span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">v-show</span>=<span class="string">"pullupStatus==4"</span>&gt;</span>刷新成功<span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">v-show</span>=<span class="string">"pullupStatus==5"</span>&gt;</span>刷新失败，请重试<span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">slot</span>&gt;</span><span class="tag">&lt;/<span class="name">slot</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">v-if</span>=<span class="string">"needRefresh &amp;&amp; hasMoreData"</span> <span class="attr">class</span>=<span class="string">"pulldown"</span>&gt;</span></div><div class="line">        <span class="comment">&lt;!-- &lt;div v-show="pulldownStatus==1"&gt;上拉加载更多&lt;/div&gt; --&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">v-show</span>=<span class="string">"pulldownStatus==2"</span>&gt;</span>加载中...<span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">v-show</span>=<span class="string">"pulldownStatus==4"</span>&gt;</span>加载失败，请重试<span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">v-if</span>=<span class="string">"!hasMoreData &amp;&amp; moreTip"</span> <span class="attr">class</span>=<span class="string">"noData"</span>&gt;</span>没有更多数据了<span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>pullup和pulldown高度都限定为40。下拉刷新思路如下：</p>
<ol>
<li>用户下拉，页面要随之下拉。这里有个问题：iscroll小于一屏的时候没有bounce效果。所以这里要加上这段代码；</li>
<li>下拉高度&gt;2*pullupH,pulldownStatus从1变成2；</li>
<li>用户释放，如果pullupStatus==2，则这是激发刷新操作，pullupStatus赋值为3；反之如果pullupStatus==1，则不做任何操作；这里有个问题：在加载的过程中，应该滚动到y=pullupH的高度，只有接收到refresh-finish的broadcast的时候，才滚动到0。所以这里肯定要修改resetPosition的代码；</li>
</ol>
<h4 id="刷新相关重点代码"><a href="#刷新相关重点代码" class="headerlink" title="刷新相关重点代码"></a>刷新相关重点代码</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">   <span class="comment">//ZZScroll.vue</span></div><div class="line">   <span class="comment">//解决不满一页bounce效果代码</span></div><div class="line">   	<span class="comment">//add code 模拟小于一页弹性滑动</span></div><div class="line">moveOverScroll: <span class="function"><span class="keyword">function</span>(<span class="params">newY</span>)</span>&#123;</div><div class="line">	<span class="comment">//处理在swiper中纵向滑动的scroller在横向swipe时禁止滑动</span></div><div class="line">	<span class="keyword">if</span>(<span class="keyword">this</span>.directionLocked == <span class="string">'h'</span> &amp;&amp; <span class="keyword">this</span>.options.hswipeStopScroll &amp;&amp; <span class="keyword">this</span>.options.scrollY)&#123;</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//对于小于一页不能下拉刷新的问题，修改,计算滑动效果</span></div><div class="line">       <span class="keyword">if</span>(<span class="keyword">this</span>.options.pullupH &gt; <span class="number">0</span> &amp;&amp; <span class="keyword">this</span>.y &gt;= <span class="number">0</span>)&#123;</div><div class="line">		<span class="keyword">var</span> tempx = <span class="keyword">this</span>.pointY-<span class="keyword">this</span>.startPointY + <span class="keyword">this</span>.absStartY;</div><div class="line">		<span class="keyword">var</span> tempplH = <span class="keyword">this</span>.options.pullupH;</div><div class="line">		<span class="keyword">if</span>(tempx &gt; <span class="number">0</span>)&#123;												<span class="comment">//只在下拉过程有效，并且在touch move函数中</span></div><div class="line">			<span class="keyword">if</span>(tempx &gt; <span class="number">0</span> &amp;&amp; tempx &lt;= tempplH)&#123;</div><div class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span>(tempx &lt;= tempplH * <span class="number">2</span>)&#123;</div><div class="line">				tempx = tempplH + (tempx - tempplH) * <span class="number">0.5</span>;</div><div class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span>(tempx &gt; tempplH * <span class="number">2</span>)&#123;</div><div class="line">				tempx = tempplH + tempplH * <span class="number">0.5</span> + (tempx - tempplH * <span class="number">2</span>) * <span class="number">0.2</span></div><div class="line">			&#125;</div><div class="line">			<span class="comment">// console.log(tempx+'---------'+(this.pointY-this.startPointY));</span></div><div class="line">			<span class="keyword">if</span> ( <span class="keyword">this</span>.options.probeType == <span class="number">3</span> ) &#123;</div><div class="line">				<span class="keyword">this</span>._execEvent(<span class="string">'scroll'</span>);</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">return</span> tempx;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> newY;</div><div class="line">&#125;,</div><div class="line"></div><div class="line">   <span class="comment">//_move</span></div><div class="line">   newY = <span class="keyword">this</span>.moveOverScroll(newY);		<span class="comment">//计算小于一页滑动</span></div><div class="line"></div><div class="line">   <span class="keyword">this</span>._translate(newX, newY);</div></pre></td></tr></table></figure>
<p>在move函数中调用moveOverScroll函数，手动计算滚动y值</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line">   <span class="comment">//zzScroll.vue</span></div><div class="line">  teCall () &#123;</div><div class="line">     <span class="keyword">this</span>.isTouch = <span class="literal">false</span>;</div><div class="line">     <span class="keyword">if</span>(<span class="keyword">this</span>.pullupStatus == <span class="number">2</span>)&#123;   <span class="comment">/*激发下拉操作了*/</span></div><div class="line">       <span class="keyword">this</span>.pullupStatus = <span class="number">3</span>;</div><div class="line">       <span class="keyword">this</span>.myScroll.setRefresh(<span class="literal">true</span>);       <span class="comment">//teCall调用之后调用resetPosition 回滚到pullupH高度</span></div><div class="line">       <span class="keyword">this</span>.refreshCall(<span class="keyword">this</span>.scrollId);</div><div class="line">     &#125;</div><div class="line">  &#125;</div><div class="line">  <span class="comment">//.........</span></div><div class="line">  <span class="comment">//监听父组件$broadcast msg</span></div><div class="line">   <span class="string">"refresh-finish"</span>: <span class="function"><span class="keyword">function</span>(<span class="params">msg</span>)</span>&#123;</div><div class="line">     <span class="keyword">let</span> self = <span class="keyword">this</span>;</div><div class="line">     msg = msg || &#123;&#125;;</div><div class="line">     msg.scrollId = msg.scrollId || <span class="string">'scroll'</span>;</div><div class="line">     <span class="keyword">if</span>(self.scrollId == msg.scrollId)&#123;    <span class="comment">//区分一个页面同时有多个scroll</span></div><div class="line">       <span class="keyword">if</span>(msg.errorCode == <span class="number">0</span>)</div><div class="line">         self.pullupStatus = <span class="number">4</span>;</div><div class="line">       <span class="keyword">else</span></div><div class="line">         self.pullupStatus = <span class="number">5</span>;</div><div class="line">       self.myScroll.setRefresh(<span class="literal">false</span>);</div><div class="line">       <span class="keyword">if</span>(self.hasMoreData)</div><div class="line">         self.pulldownStatus = <span class="number">2</span>;     <span class="comment">//重新修改load-finish状态。hasMoreData的双向绑定没有这么快生效，要放在setTimeout中</span></div><div class="line">     &#125;</div><div class="line">   &#125;,</div><div class="line">   <span class="comment">//iscroll-lite-zly</span></div><div class="line">   setRefresh: <span class="function"><span class="keyword">function</span>(<span class="params">isRefreshing</span>)</span>&#123;</div><div class="line">	<span class="keyword">var</span> self = <span class="keyword">this</span>;</div><div class="line">	<span class="keyword">if</span>(isRefreshing)&#123;</div><div class="line">		<span class="keyword">this</span>.isRefreshing = <span class="literal">true</span>;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;		<span class="comment">//refresh结束分为两种情况</span></div><div class="line">		<span class="keyword">this</span>.isRefreshing = <span class="literal">false</span>;</div><div class="line">		<span class="keyword">if</span>(<span class="keyword">this</span>.isAnimating)&#123;		<span class="comment">//还没有滚动到40，正在滚动过程中。直接滚动到0,不能直接调用resetPostion</span></div><div class="line">               <span class="function"><span class="keyword">function</span> <span class="title">endCall</span>(<span class="params"></span>)</span>&#123;</div><div class="line">                   self.off(<span class="string">'scrollEnd'</span>, endCall);</div><div class="line">                   <span class="comment">// self.finishAnimate = false;</span></div><div class="line">                   self.refresh();</div><div class="line">               &#125;</div><div class="line">               <span class="keyword">this</span>.on(<span class="string">'scrollEnd'</span>, endCall);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;		<span class="comment">//正在40这里等待刷新成功</span></div><div class="line">			<span class="keyword">this</span>.resetPosition(<span class="keyword">this</span>.options.bounceTime);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;,</div><div class="line"></div><div class="line">   <span class="attr">resetPosition</span>: <span class="function"><span class="keyword">function</span>(<span class="params">time</span>)</span>&#123;</div><div class="line">       <span class="comment">//*******</span></div><div class="line">       <span class="comment">//add Code</span></div><div class="line">	<span class="keyword">if</span>(<span class="keyword">this</span>.isRefreshing)&#123;</div><div class="line">		y = <span class="keyword">this</span>.options.pullupH;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		y = y;</div><div class="line">	&#125;</div><div class="line">       <span class="comment">//*********</span></div><div class="line">   &#125;,</div><div class="line"><span class="attr">_animate</span>: <span class="function"><span class="keyword">function</span> (<span class="params">destX, destY, duration, easingFn</span>) </span>&#123;</div><div class="line">       <span class="comment">//*********</span></div><div class="line">       <span class="keyword">if</span> ( !that.resetPosition(that.options.bounceTime) ) &#123;</div><div class="line">           that._execEvent(<span class="string">'scrollEnd'</span>);</div><div class="line">       &#125;</div><div class="line">       <span class="comment">//********</span></div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>这一段就是刷新的代码，teCall是自定义的touchend回调，在teCall中设置isRefreshing为true。这样在_end中调用resetPosition的时候，y值就会被设置成为pullupH。resetPosition也就回scrollTo(0, pullupH)。如果这个时候刷新结束，在setRefresh函数中会监听_animate的scrollEnd事件；这里不需要再次手动调用_animate,因为在_animate函数中，滚动结束会调用resetPostion,而这时isRefresh已经变成了false，所以又是resetPosition会scrollTo(0, 0); 等到真正滚动到0，animate中也就回_execEvent(‘scrollEnd’); 这时再refresh当前页面，重新计算高度。</p>
<h4 id="加载更多相关重点代码"><a href="#加载更多相关重点代码" class="headerlink" title="加载更多相关重点代码"></a>加载更多相关重点代码</h4><p>上拉加载更多其实没什么好说的。无非就是一个滚动到哪里激发事件的问题，这里注意还要考虑加载一次之后可能还是不足一页的情况<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">showLoadMore () &#123;               <span class="comment">//判断是否达到下拉加载更多的时机(maxScrollY==0时不足一页)</span></div><div class="line">  <span class="keyword">return</span> (<span class="keyword">this</span>.myScroll.y&lt;<span class="keyword">this</span>.myScroll.maxScrollY+pullupH/<span class="number">2</span>) || (<span class="keyword">this</span>.myScroll.maxScrollY==<span class="number">0</span>);</div><div class="line">&#125;,</div></pre></td></tr></table></figure></p>
<h3 id="最终效果"><a href="#最终效果" class="headerlink" title="最终效果"></a>最终效果</h3><p><img src="http://ww3.sinaimg.cn/mw690/a5e2541bgw1f8qrr6en35j20k00zkdin.jpg" alt=""><br><img src="http://ww3.sinaimg.cn/mw690/a5e2541bgw1f8qrr5znlsj20k00zkgpx.jpg" alt=""><br><img src="http://ww1.sinaimg.cn/mw690/a5e2541bgw1f8qrr5mh9wj20k00zktcd.jpg" alt=""><br><img src="http://ww4.sinaimg.cn/mw690/a5e2541bgw1f8qrr54yfjj20k00zk42c.jpg" alt=""></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/10/13/20161013/" data-id="ciyvlrhov0027ocvrnksscpnw" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/IScroller/">IScroller</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/vue/">vue</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/下拉刷新-上拉加载/">下拉刷新+上拉加载</a></li></ul>

    </footer>
  </div>
  
</article>




  
    <article id="post-20161012" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/10/12/20161012/" class="article-date">
  <time datetime="2016-10-11T16:00:00.000Z" itemprop="datePublished">2016-10-12</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/node/">node</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/10/12/20161012/">node实现爬虫抓取淘宝商品图文详情</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="项目背景"><a href="#项目背景" class="headerlink" title="项目背景"></a>项目背景</h3><p>最近刚刚用vue完成了一个商城的项目。截下来就是填充数据的问题了，我们缺图片信息，只有想办法从淘宝弄了。第一次写个小爬虫还是挺兴奋的。python不会，只好用node实现了，查了下目前有两种方案：</p>
<ol>
<li>superagent + cheerio</li>
<li>phantomjs</li>
</ol>
<h3 id="superagent-cheerio"><a href="#superagent-cheerio" class="headerlink" title="superagent+cheerio"></a>superagent+cheerio</h3><p>superagent是服务器端异步请求模块的一种实现，它支持restful形式的api。内部依赖nodejs原生的请求api,适用于nodejs环境下。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">request</div><div class="line">.post(<span class="string">'/api/pet'</span>)</div><div class="line">.send(&#123; <span class="attr">name</span>: <span class="string">'Manny'</span>, <span class="attr">species</span>: <span class="string">'cat'</span> &#125;)</div><div class="line">.set(<span class="string">'X-API-Key'</span>, <span class="string">'foobar'</span>)</div><div class="line">.set(<span class="string">'Accept'</span>, <span class="string">'application/json'</span>)</div><div class="line">.end(<span class="function"><span class="keyword">function</span>(<span class="params">res</span>)</span>&#123;</div><div class="line">    <span class="keyword">if</span> (res.ok) &#123;</div><div class="line">    alert(<span class="string">'yay got '</span> + <span class="built_in">JSON</span>.stringify(res.body));</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">    alert(<span class="string">'Oh no! error '</span> + res.text);</div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>cheerio则是服务器端html解析器的一种实现，服务器端不像浏览器，带有html解析器。所以在操作html文档数据的时候，需要这种工具。</p>
<p>说到这里，思路也很清晰了：利用superagent异步拉取淘宝的商品详情页html。再利用cheerio解析其中需要的图文详情dom获得图片url。代码如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</div><div class="line"><span class="keyword">var</span> bodyParser = <span class="built_in">require</span>(<span class="string">'body-parser'</span>);</div><div class="line"><span class="keyword">var</span> cheerio = <span class="built_in">require</span>(<span class="string">'cheerio'</span>);</div><div class="line"><span class="keyword">var</span> superagent = <span class="built_in">require</span>(<span class="string">'superagent'</span>);</div><div class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> app = express();</div><div class="line">app.use(bodyParser.json(&#123;<span class="attr">limit</span>: <span class="string">'1mb'</span>&#125;));  <span class="comment">//body-parser 解析json格式数据</span></div><div class="line">app.use(bodyParser.urlencoded(&#123;            <span class="comment">//此项必须在 bodyParser.json 下面,为参数编码</span></div><div class="line">  extended: <span class="literal">true</span></div><div class="line">&#125;));</div><div class="line"></div><div class="line">app.get(<span class="string">'/index.html'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>)</span>&#123;</div><div class="line">  res.send(fs.readFileSync(<span class="string">'index.html'</span>).toString());</div><div class="line">&#125;);</div><div class="line"></div><div class="line">app.post(<span class="string">'/result'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>)</span>&#123;</div><div class="line">    <span class="comment">// console.log(req.body.urls.split('\r\n'));</span></div><div class="line">    <span class="keyword">var</span> urls = req.body.urls.split(<span class="string">'\r\n'</span>);</div><div class="line">    urls.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">url</span>) </span>&#123;</div><div class="line">        superagent.get(url).end(<span class="function"><span class="keyword">function</span> (<span class="params">err, sres</span>) </span>&#123;</div><div class="line">          <span class="keyword">if</span> (err) &#123; <span class="keyword">return</span> next(err); &#125;</div><div class="line">          <span class="keyword">var</span> $ = cheerio.load(sres.text);</div><div class="line">          <span class="keyword">var</span> items = [];</div><div class="line">          $(<span class="string">'.mui-custommodule .mui-custommodule-item img'</span>).each(<span class="function"><span class="keyword">function</span>(<span class="params">idx, element</span>)</span>&#123;</div><div class="line">            <span class="keyword">var</span> ele = $(element);</div><div class="line">            item.push(&#123;</div><div class="line">              <span class="attr">imgsrc</span>: ele.attr(<span class="string">'src'</span>)</div><div class="line">            &#125;)</div><div class="line">          &#125;);</div><div class="line">          <span class="keyword">var</span> se = [];</div><div class="line">          se.push(<span class="string">'页面地址:'</span>, url, <span class="string">'\n'</span>);</div><div class="line">          se.push(<span class="string">'页面html:'</span>, sres.text, <span class="string">'\n'</span>);</div><div class="line">          se.push(<span class="string">'页面结果:'</span>, <span class="built_in">JSON</span>.stringify(items), <span class="string">'\n'</span>);</div><div class="line">          res.send(se.join(<span class="string">''</span>));</div><div class="line">        &#125;);</div><div class="line">    &#125;);</div><div class="line">&#125;);</div><div class="line"></div><div class="line">app.listen(<span class="number">3000</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'app is listening at port 3000'</span>);</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>这里在index.html页面新建了一个form和textarea，textarea以换行符输入多个详情页面的url。要注意在使用express时，如果需要提取post提交的参数时，需要使用body-parser。</p>
<h4 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h4><p>最终结果并不如我所料。抓取到的页面url总是404，经过一番google。发现有如下原因：</p>
<ol>
<li>淘宝页面dom采用js动态生成，抓取不到；</li>
<li>淘宝反爬虫策略可以检测出这种基础的盗取数据方式</li>
</ol>
<h3 id="phantomjs"><a href="#phantomjs" class="headerlink" title="phantomjs"></a>phantomjs</h3><p>PhantomJS是一个无界面的,可脚本编程的WebKit浏览器引擎。它原生支持多种web 标准：DOM 操作，CSS选择器，JSON，Canvas 以及SVG。可以看做是一个无界面的浏览器。既然浏览器可以正常打开淘宝页面，phantomjs应该也可以；而且它还提供了操作dom的能力，只要等待页面加载完毕，dom生成之后，也就可以拿到数据了。代码如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> webPage = <span class="built_in">require</span>(<span class="string">'webpage'</span>);</div><div class="line"><span class="keyword">var</span> page = webPage.create();</div><div class="line"><span class="keyword">var</span> pageTb = webPage.create();</div><div class="line"><span class="keyword">var</span> pageImg = webPage.create();</div><div class="line"><span class="keyword">var</span> tbUrl = system.args[<span class="number">2</span>];</div><div class="line"></div><div class="line">page.settings.userAgent = <span class="string">"Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/45.0.2454.85 Safari/537.36"</span>;</div><div class="line"></div><div class="line">pageTb.open(tbUrl, <span class="function"><span class="keyword">function</span>(<span class="params">status</span>) </span>&#123;</div><div class="line">    <span class="comment">// 由于是拉取异步数据，我们打开页面后，等待12s再去操作dom，获取交易量</span></div><div class="line">    setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="keyword">var</span> result = pageTb.evaluate(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;               <span class="comment">//evaluate在页面中执行js代码（获取某个元素等）,open方法和evaluate方法中的console不会执行</span></div><div class="line">            <span class="keyword">var</span> temp = [];</div><div class="line">            <span class="built_in">Array</span>.prototype.forEach.call(<span class="built_in">document</span>.querySelectorAll(<span class="string">'.mui-custommodule-item img'</span>), <span class="function"><span class="keyword">function</span>(<span class="params">item</span>)</span>&#123;</div><div class="line">                temp.push(item.dataset.ksLazyload);     <span class="comment">//data自定义属性只能通过dataset获取，不能通过attributes和直接.访问到</span></div><div class="line">            &#125;)</div><div class="line">            <span class="keyword">return</span> temp;</div><div class="line">        &#125;);</div><div class="line"></div><div class="line">        <span class="comment">//生成该页面的url</span></div><div class="line">        <span class="keyword">var</span> resultLen = result.length;</div><div class="line">        pageImg.viewportSize = &#123; <span class="attr">width</span>: <span class="number">375</span> &#125;;</div><div class="line">        <span class="function"><span class="keyword">function</span> <span class="title">getImgs</span>(<span class="params"></span>)</span>&#123;</div><div class="line">            pageImg.open(result[<span class="number">0</span>], <span class="function"><span class="keyword">function</span>(<span class="params">status</span>) </span>&#123;</div><div class="line">                <span class="keyword">if</span> (status !== <span class="string">'success'</span>) &#123;</div><div class="line">                    <span class="built_in">console</span>.log(<span class="string">'Unable to load the address!'</span>);</div><div class="line">                    getImgs();</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="built_in">window</span>.setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">                        <span class="keyword">var</span> size = pageImg.evaluate(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">                            <span class="keyword">var</span> img = <span class="built_in">document</span>.querySelector(<span class="string">'img'</span>);</div><div class="line">                            <span class="keyword">var</span> h = img.getAttribute(<span class="string">'height'</span>), w = img.getAttribute(<span class="string">'width'</span>);</div><div class="line">                            <span class="keyword">return</span> &#123; <span class="attr">height</span>: h/w*<span class="number">750</span>, <span class="attr">width</span>: <span class="number">750</span>&#125;;             <span class="comment">//阿里服务器会自动将width和height加到图片上</span></div><div class="line">                        &#125;);</div><div class="line">                        pageImg.viewportSize = size;</div><div class="line">                        pageImg.render( resultLen-result.length+<span class="string">'.jpg'</span>, &#123;<span class="attr">format</span>: <span class="string">'jpg'</span>, <span class="attr">quality</span>: <span class="string">'100'</span>&#125;);</div><div class="line">                        getImgs();</div><div class="line">                    &#125;, <span class="number">200</span>);</div><div class="line">                &#125;</div><div class="line">                result.shift();                         <span class="comment">//删除第一个元素</span></div><div class="line">            &#125;)</div><div class="line">            <span class="keyword">if</span>(result.length&lt;=<span class="number">0</span>) phantom.exit();</div><div class="line">        &#125;</div><div class="line">        getImgs()</div><div class="line"></div><div class="line">        <span class="comment">//生成当前页面截图</span></div><div class="line">        <span class="comment">// pageTb.render("xuqintb2.png");</span></div><div class="line">        <span class="comment">// phantom.exit();</span></div><div class="line">    &#125;, <span class="number">2000</span>);</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>注意phantom可以用npm安装，但是不是node直接可以执行的，执行命令如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">phantom --ssl-protocol=any <span class="string">"https://detail.m.tmall.com/item.htm?id=40586936292"</span></div></pre></td></tr></table></figure></p>
<p>由于是打开https协议头的网页，所以执行js文件时，需要添加”–ssl-protocol=any”参数。详情页面的url作为参数传入。<br>可以看出上面phantom先加载页面，根据ksLazyload这个图片懒加载属性获取图片真实url；之后递归加载每张图片，利用render方法生成图片。</p>
<p>最终拉取下来效果是这样：<br><img src="http://ww1.sinaimg.cn/mw690/a5e2541bgw1f8pvj5fzigj20l607a0te.jpg"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/10/12/20161012/" data-id="ciyvlrhmo000uocvrd9af5j0v" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/爬虫/">爬虫</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/网络/">网络</a></li></ul>

    </footer>
  </div>
  
</article>




  
    <article id="post-20160707" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/07/07/20160707/" class="article-date">
  <time datetime="2016-07-06T16:00:00.000Z" itemprop="datePublished">2016-07-07</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/js/">js</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/07/07/20160707/">几种基本排序算法的理解</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>算下毕业一年零一个月了，闲下来回顾下大学基础知识，以后才能更上一层楼，顺着手头抄起从大学带到现在都很少翻过的算法导论看了起来。</p>
<h3 id="1-插入排序"><a href="#1-插入排序" class="headerlink" title="1.插入排序"></a>1.插入排序</h3><p>左侧维持为一个有序数组，从右侧添加新的排序数值，在左侧找到其位置插入，这样始终保持左侧数组是一个有序数组<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">function</span> insertSort(arr, ascend)&#123;</div><div class="line">	ascend = (ascend == undefined ? <span class="literal">true</span> : ascend);		 </div><div class="line">	var i,ilen,j,key;</div><div class="line">	<span class="keyword">if</span>(ascend)&#123;</div><div class="line">		<span class="keyword">for</span>(i=1,ilen=arr.length; i&lt;ilen; i++)&#123;</div><div class="line">			key = arr[i];</div><div class="line">			<span class="keyword">for</span>(j=i-1; j&gt;=0; j--)&#123;</div><div class="line">				<span class="keyword">if</span>(arr[j] &gt; key)&#123;</div><div class="line">					arr[j+1] = arr[j];</div><div class="line">				&#125; <span class="keyword">else</span> &#123;</div><div class="line">					<span class="built_in">break</span>;		//左侧为有序数组，j比较之后如果小，则左侧都小</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">			arr[j+1] = key;</div><div class="line">		&#125;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="keyword">for</span>(i=1,ilen=arr.length; i&lt;ilen; i++)&#123;</div><div class="line">			key = arr[i];</div><div class="line">			<span class="keyword">for</span>(j=i-1; j&gt;=0; j--)&#123;</div><div class="line">				<span class="keyword">if</span>(arr[j] &lt; key)&#123;</div><div class="line">					arr[j+1] = arr[j];</div><div class="line">				&#125; <span class="keyword">else</span> &#123;</div><div class="line">					<span class="built_in">break</span>;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">			arr[j+1] = key;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="built_in">return</span> arr;</div><div class="line">&#125;</div><div class="line">var ar = insertSort([1,4,2,8,6,9,7])</div></pre></td></tr></table></figure></p>
<h3 id="选择排序"><a href="#选择排序" class="headerlink" title="选择排序"></a>选择排序</h3><p>循环一般找出最小，和第一个元素交换，第二次循环找出第二小元素和第二个元素替换，这就是选择排序的思想<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">function</span> chooseSort(arr)&#123;</div><div class="line">	var temp, min;</div><div class="line">	<span class="keyword">for</span>(var i=0,ilen=arr.length; i&lt;ilen; i++)&#123;</div><div class="line">		min = i;</div><div class="line">		<span class="keyword">for</span>(var j=i+1,jlen=arr.length; j&lt;jlen; j++)&#123;</div><div class="line">			<span class="keyword">if</span>(arr[j] &lt; arr[min])</div><div class="line">				min = j;</div><div class="line">		&#125;</div><div class="line">		temp = arr[i];</div><div class="line">		arr[i] = arr[min];</div><div class="line">		arr[min] = temp;</div><div class="line">	&#125;</div><div class="line">	<span class="built_in">return</span> arr;</div><div class="line">&#125;</div><div class="line">var ar = chooseSort([5,1,4,2,8,6,9,7])</div></pre></td></tr></table></figure></p>
<h3 id="冒泡排序"><a href="#冒泡排序" class="headerlink" title="冒泡排序"></a>冒泡排序</h3><p>每个元素和相邻元素比较，如何符合a1<a2，则不处理，如果不符合则交换元素，一次循环下来可以确定当前的最小值，这一点和选择排序类似 <figure="" class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">function</span> bubbleSort(arr)&#123;</div><div class="line">	var temp;</div><div class="line">	<span class="keyword">for</span>(var i=0,ilen=arr.length; i&lt;ilen; i++)&#123;</div><div class="line">		<span class="keyword">for</span>(var j=i; j&lt;arr.length-i; j++)&#123;</div><div class="line">			<span class="keyword">if</span>(arr[j]&gt;arr[j+1])&#123;</div><div class="line">				temp=arr[j+1];</div><div class="line">				arr[j+1] = arr[j];</div><div class="line">				arr[j] = temp;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="built_in">return</span> arr;</div><div class="line">&#125; </div><div class="line">var ar = bubbleSort([5,1,4,2,8,6,9,7])</div></pre></td></tr></table></a2，则不处理，如果不符合则交换元素，一次循环下来可以确定当前的最小值，这一点和选择排序类似></p>
<p>以上三种排序，想法很常规，也比较容易实现，但时间复杂度都很差，都在n^2;</p>
<h3 id="快速排序"><a href="#快速排序" class="headerlink" title="快速排序"></a>快速排序</h3><p>快排和归并排序一样都用到了divide and conquer； 选中一个分界点（pvito），将小于这个元素的元素放到其左侧，大于这个元素的放到右侧。一次循环之后，可以得到左右两个数组，之后以同样的方法递归左后两个数组，等到递归结束的时候，数组就已经是有序的了<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">function</span> quickSort(arr, start, end)&#123;</div><div class="line">	var pivot = arr[end], temp;</div><div class="line">	var i = start-1;</div><div class="line">	<span class="keyword">for</span>(var j=start; j&lt;=end; j++)&#123;</div><div class="line">		<span class="keyword">if</span>(arr[j] &lt; pivot)&#123;</div><div class="line">			i++;</div><div class="line">			temp = arr[i];</div><div class="line">			arr[i] = arr[j];</div><div class="line">			arr[j] = temp;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	arr[i+1] = pivot;</div><div class="line">	quickSort(arr, start, i);</div><div class="line">	quickSort(arr, i+1, end);</div><div class="line">	<span class="built_in">return</span> arr;</div><div class="line">&#125;</div><div class="line">var ar = chooseSort([5,1,4,2,8,6,9,7], 0, 7);</div></pre></td></tr></table></figure></p>
<h3 id="归并排序"><a href="#归并排序" class="headerlink" title="归并排序"></a>归并排序</h3><p>归并排序是典型的divide and conquer的思想。首先递归将数组分割成单个元素，之后按顺序逐渐合并成一个个有顺序的数组，直到成为一个完整的数组。分割的过程其实没有时间复杂度，merge的过程才需要时间<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">var tempArr = [];</div><div class="line"><span class="keyword">function</span> merge(arr, start, middle, end)&#123;</div><div class="line">	var i = start, j=middle+1;</div><div class="line">	<span class="keyword">while</span>(i&lt;=middle &amp;&amp; j&lt;=end)&#123;</div><div class="line">		<span class="keyword">if</span>(arr[i] &lt; arr[j])&#123;</div><div class="line">			tempArr.push(arr[i]);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			tempArr.push(arr[j]);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span>(i&gt;=middle)&#123;</div><div class="line">		<span class="keyword">while</span>(j&lt;=end)&#123;</div><div class="line">			tempArr.push(a[j]);</div><div class="line">		&#125;</div><div class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span>(j&gt;=end)&#123;</div><div class="line">		<span class="keyword">while</span>(i&lt;=middle)&#123;</div><div class="line">			tempArr.push(a[i]);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	arr = tempArr;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">function</span> mergeSort(arr, start, end)&#123;</div><div class="line">	var middle;</div><div class="line">	<span class="keyword">if</span>(start &lt; end)&#123;</div><div class="line">		middle = Math.floor(start+end)/2;</div><div class="line">		mergeSort(arr, start, middle);</div><div class="line">		mergeSort(arr, middle+1, end);</div><div class="line">		merge(arr, start, middle, end);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line">var ar = chooseSort([5,1,4,2,8,6,9,7], 0, 7);</div></pre></td></tr></table></figure></p>
<h3 id="堆排序"><a href="#堆排序" class="headerlink" title="堆排序"></a>堆排序</h3><p>堆排涉及到堆这种数据结构，代码确实也是看得懂但难写出来。堆排如果希望升序可以使用大根堆，降序则使用小根堆。堆是一种完全二叉树（只有叶子节点一级节点个数可以少于两个，并且节点一定是先有左节点后有右节点的数）。堆排的思想就是<br>1.存储堆结构。盗用一张网上的图<br><img src="http://hi.csdn.net/attachment/201108/22/0_1314014706gZqn.gif"><br>可见堆的存储并不复杂。以广度优先遍历的顺序来存储在数组中即可。这一步没有时间复杂度。</p>
<p>2.构建大根堆。<br>得益于堆是一个完全二叉树。所以非叶子节点最大的下标为 arr.length/2向下取整。  对于一个有父节点p，假设有两个子节点pc1和pc2两个子节点。将p和p1，p2依次比较。如果如果子节点中较大的大于p。则交换p和该子节点。并记录下这个较大节点的index为largest。这是p，p1，p2这个堆就是个大根堆了。<br>但是调换之后。largest及其子节点就有可能不是大根堆了。所以递归调用，将这相连的子节点都变成大根堆。<br>由于父节点共有0-arr.length/2个；    所以需要遍历这些父节点<br>遍历完成之后。最大的元素就一定是根元素。</p>
<p>3.交换根节点与末尾节点<br>这样将选出的最大元素保留到最后。并将堆的大小heapSize-1;    重新执行上面构建大根堆的流程。直到heapSize为0；这时整个堆中每一个小堆都是大根堆，整个存储数组也是有序的了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">var i,j;</div><div class="line">Array.prototype.swap=<span class="keyword">function</span>(i,j)&#123;</div><div class="line">	var tmp=this[i];</div><div class="line">	this[i]=this[j];</div><div class="line">	this[j]=tmp;</div><div class="line">&#125;;</div><div class="line">Array.prototype.heapAdjust=<span class="keyword">function</span>(i,j)&#123;</div><div class="line">	var largest=i;</div><div class="line">	var left=2*i+1;</div><div class="line">	var right=2*i+2;</div><div class="line">	 </div><div class="line">	<span class="keyword">if</span>(left&lt;j&amp;&amp;this[largest]&lt;this[left])&#123;</div><div class="line">		largest=left;</div><div class="line">	&#125;</div><div class="line">	 </div><div class="line">	<span class="keyword">if</span>(right&lt;j&amp;&amp;this[largest]&lt;this[right])&#123;</div><div class="line">		largest=right;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span>(largest!=i)&#123;</div><div class="line">		this.swap(i,largest);</div><div class="line">		this.heapAdjust(largest,j);</div><div class="line">	&#125;</div><div class="line">&#125;;</div><div class="line">Array.prototype.buildMaxHeap=<span class="function"><span class="title">function</span></span>()&#123;</div><div class="line">	<span class="keyword">for</span>(var i=Math.floor(this.length/2)-1;i&gt;=0;i--)&#123;</div><div class="line">		this.heapAdjust(i,this.length);</div><div class="line">	&#125;</div><div class="line">&#125;;</div><div class="line">Array.prototype.heapSort=<span class="function"><span class="title">function</span></span>()&#123;</div><div class="line">	this.buildMaxHeap();</div><div class="line">	<span class="keyword">for</span>(vari=this.length-1;i&gt;0;i--)&#123;</div><div class="line">		this.swap(0,i);</div><div class="line">		this.heapAdjust(0,i);</div><div class="line">	&#125;</div><div class="line">	 </div><div class="line">	<span class="built_in">return</span> this;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>归并排序，快排， 堆排的时间复杂度都控制在nlgn。但归并排序是稳定排序，另外两种都不是稳定排序</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/07/07/20160707/" data-id="ciyvlrhml000rocvr9u5moi5k" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/排序算法/">排序算法</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/算法/">算法</a></li></ul>

    </footer>
  </div>
  
</article>




  
    <article id="post-20160530" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/05/30/20160530/" class="article-date">
  <time datetime="2016-05-29T16:00:00.000Z" itemprop="datePublished">2016-05-30</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/js/">js</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/05/30/20160530/">单页应用中的按需加载</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>最近在公司刚完成了一个微信的项目，我用的原生js+jsp做的一个单页应用，快完成的时候，需求添加，需要嵌入到公司app的多个入口中，我开始考虑单页应用的分模块加载问题。</p>
<p>刚开始直接这样重定向到index.jsp上，确定hash值为onlineOffline，正常没问题<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&lt;%</div><div class="line">      String hostStr = <span class="string">"http://testsaas-1000-100001.m.izhuazhua.com"</span>;</div><div class="line">      String serviceType1 = request.getParameter(<span class="string">"serviceType"</span>);</div><div class="line">      String yua1 = request.getHeader(<span class="string">"yua"</span>);</div><div class="line">      int platform = -1;</div><div class="line">      <span class="keyword">if</span>(yua1.indexOf(<span class="string">"Android"</span>) != -1)&#123;</div><div class="line">          platform = 1;</div><div class="line">          response.sendRedirect(hostStr + <span class="string">"/index.jsp#/onlineOffline?serviceType="</span> + serviceType1);</div><div class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span>(yua1.indexOf(<span class="string">"iOS"</span>) != -1)&#123;</div><div class="line">          platform = 2;</div><div class="line">      &#125;</div><div class="line">  %&gt;</div></pre></td></tr></table></figure></p>
<p>但是index.jsp作为单页。是这样实现的<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div></pre></td><td class="code"><pre><div class="line">&lt;head&gt;</div><div class="line">    &lt;link rel=<span class="string">"stylesheet"</span> href=<span class="string">"css/spinningwheel-didi.css?timestamp=34"</span>&gt;</div><div class="line">    &lt;link rel=<span class="string">"stylesheet"</span> href=<span class="string">"css/base.css?timestamp=367fdf"</span>&gt;</div><div class="line">    &lt;link rel=<span class="string">"stylesheet"</span> href=<span class="string">"css/main.css?timestamp=fd23f"</span>&gt;</div><div class="line">    &lt;link rel=<span class="string">"stylesheet"</span> href=<span class="string">"css/swiper.css"</span>&gt;</div><div class="line">    &lt;link rel=<span class="string">"stylesheet"</span> href=<span class="string">"css/zzDateRanger.css"</span>&gt;</div><div class="line"></div><div class="line">    &lt;script src=<span class="string">"library/template-native-debug.js"</span>&gt;&lt;/script&gt;</div><div class="line">    &lt;script src=<span class="string">"library/fastclick.js"</span>&gt;&lt;/script&gt;</div><div class="line">    &lt;script src=<span class="string">"library/jquery.min.js"</span>&gt;&lt;/script&gt;</div><div class="line">    &lt;script src=<span class="string">"library/iscroll-lite.js"</span>&gt;&lt;/script&gt;</div><div class="line">    &lt;script src=<span class="string">"library/swiper-3.3.1.jquery.min.js"</span>&gt;&lt;/script&gt;</div><div class="line">    &lt;script src=<span class="string">"library/spinningwheel-didi.js?timestamp=436sdf5"</span>&gt;&lt;/script&gt;</div><div class="line">    &lt;script src=<span class="string">"js/services/util.js?time=3df534d3"</span>&gt;&lt;/script&gt;</div><div class="line">    &lt;script src=<span class="string">"js/services/map.js?time=3df3"</span>&gt;&lt;/script&gt;</div><div class="line">    &lt;script src=<span class="string">"js/services/zzDateRanger.js?time=3df3"</span>&gt;&lt;/script&gt;</div><div class="line">    &lt;script src=<span class="string">"js/controllers/index.js?time=0sdffds9"</span>&gt;&lt;/script&gt;</div><div class="line">    &lt;script src=<span class="string">"js/controllers/service.js?time=9s99055"</span>&gt;&lt;/script&gt;</div><div class="line">    &lt;script src=<span class="string">"js/controllers/order.js?time=sdfsdfs"</span>&gt;&lt;/script&gt;</div><div class="line">    &lt;script src=<span class="string">"js/controllers/login.js?time=sdsdfsdf"</span>&gt;&lt;/script&gt;</div><div class="line">    &lt;script src=<span class="string">"js/controllers/my.js?time=3df3"</span>&gt;&lt;/script&gt;</div><div class="line">    &lt;script src=<span class="string">"js/controllers/myInfo.js?time=34dfsd"</span>&gt;&lt;/script&gt;</div><div class="line">    &lt;script src=<span class="string">"js/controllers/myAccount.js?time=sdsdfsdfsdf"</span>&gt;&lt;/script&gt;</div><div class="line">    &lt;script src=<span class="string">"js/controllers/petInfoInput.js?time=9f32423"</span>&gt;&lt;/script&gt;</div><div class="line">    &lt;script src=<span class="string">"js/controllers/listServicePrice.js?time=3df3"</span>&gt;&lt;/script&gt;</div><div class="line">    &lt;script src=<span class="string">"js/controllers/petColor.js?time=3df3"</span>&gt;&lt;/script&gt;</div><div class="line">    &lt;script src=<span class="string">"js/controllers/petFood.js?time=3df3"</span>&gt;&lt;/script&gt;</div><div class="line">    &lt;script src=<span class="string">"js/controllers/petBreed.js?time=3df3"</span>&gt;&lt;/script&gt;</div><div class="line">    &lt;script src=<span class="string">"js/controllers/petList.js?time=3df3"</span>&gt;&lt;/script&gt;</div><div class="line">    &lt;script src=<span class="string">"js/controllers/yhj.js?time=890?time=3df3"</span>&gt;&lt;/script&gt;</div><div class="line">    &lt;script src=<span class="string">"js/controllers/orderDetail.js?time=55d4555"</span>&gt;&lt;/script&gt;</div><div class="line">    &lt;script src=<span class="string">"js/controllers/orderAccess.js?time=12sdfsd"</span>&gt;&lt;/script&gt;</div><div class="line">    &lt;script src=<span class="string">"js/controllers/accessDetail.js?time=324sdfsd"</span>&gt;&lt;/script&gt;</div><div class="line">    &lt;script src=<span class="string">"js/controllers/agreement.js?time=3df3"</span>&gt;&lt;/script&gt;</div><div class="line">    &lt;script src=<span class="string">"js/controllers/paySuccess.js?time=sd33fsd"</span>&gt;&lt;/script&gt;</div><div class="line">    &lt;script src=<span class="string">"js/controllers/onlineOffline.js?time=12sd23"</span>&gt;&lt;/script&gt;</div><div class="line">    &lt;script src=<span class="string">"js/controllers/address.js"</span>&gt;&lt;/script&gt;</div><div class="line">    &lt;script src=<span class="string">"js/controllers/addressInput.js?time=sdfsdfsdfdfsdf234"</span>&gt;&lt;/script&gt;</div><div class="line">    &lt;script src=<span class="string">"js/controllers/storeList.js?time=ssdfsddfsdf"</span>&gt;&lt;/script&gt;</div><div class="line">    &lt;script src=<span class="string">"js/controllers/dateRanger.js?time=ssf"</span>&gt;&lt;/script&gt;</div><div class="line">    &lt;script src=<span class="string">"js/controllers/hotel.js?time=3df3"</span>&gt;&lt;/script&gt;</div><div class="line">    &lt;script src=<span class="string">"js/controllers/hotelList.js?time=3df3"</span>&gt;&lt;/script&gt;</div><div class="line">    &lt;script src=<span class="string">"js/controllers/changeTime.js?time=3df3"</span>&gt;&lt;/script&gt;</div><div class="line"></div><div class="line">    &lt;script <span class="built_in">type</span>=<span class="string">'text/javascript'</span> src=<span class="string">'http://res.wx.qq.com/open/js/jweixin-1.0.0.js'</span>&gt;&lt;/script&gt;</div><div class="line">    &lt;%@include  file=<span class="string">"wxshare.jsp"</span>%&gt;</div><div class="line">    &lt;script <span class="built_in">type</span>=<span class="string">"text/javascript"</span> src=<span class="string">"http://webapi.amap.com/maps?v=1.3&amp;key=950f0eafe4a4b4c2ab150a2c0141d173&amp;plugin=AMap.Geocoder,AMap.PlaceSearch"</span>&gt;&lt;/script&gt;</div><div class="line"></div><div class="line">    &lt;!-- 引入模板</div><div class="line">    &lt;%@ include  file=<span class="string">"templates/index.html"</span> %&gt;</div><div class="line">    &lt;%@ include  file=<span class="string">"templates/service.html"</span> %&gt;</div><div class="line">    &lt;%@ include  file=<span class="string">"templates/serviceTime.html"</span>%&gt;</div><div class="line">    &lt;%@ include  file=<span class="string">"templates/login.html"</span>%&gt;</div><div class="line">    &lt;%@ include  file=<span class="string">"templates/order.html"</span> %&gt;</div><div class="line">    &lt;%@ include  file=<span class="string">"templates/dialog.html"</span>%&gt;</div><div class="line">    &lt;%@ include  file=<span class="string">"templates/my.html"</span> %&gt;</div><div class="line">    &lt;%@ include  file=<span class="string">"templates/myInfo.html"</span>%&gt;</div><div class="line">    &lt;%@ include  file=<span class="string">"templates/myAccount.html"</span>%&gt;</div><div class="line">    &lt;%@ include  file=<span class="string">"templates/petInfoInput.html"</span>%&gt;</div><div class="line">    &lt;%@ include  file=<span class="string">"templates/listServicePrice.html"</span>%&gt;</div><div class="line">    &lt;%@ include  file=<span class="string">"templates/petColor.html"</span>%&gt;</div><div class="line">    &lt;%@ include  file=<span class="string">"templates/petFood.html"</span>%&gt;</div><div class="line">    &lt;%@ include  file=<span class="string">"templates/petBreed.html"</span>%&gt;</div><div class="line">    &lt;%@ include  file=<span class="string">"templates/yhj.html"</span> %&gt;</div><div class="line">    &lt;%@ include  file=<span class="string">"templates/petList.html"</span>%&gt;</div><div class="line">    &lt;%@ include  file=<span class="string">"templates/orderDetail.html"</span>%&gt;</div><div class="line">    &lt;%@ include  file=<span class="string">"templates/orderAccess.html"</span>%&gt;</div><div class="line">    &lt;%@ include  file=<span class="string">"templates/accessDetail.html"</span>%&gt;</div><div class="line">    &lt;%@ include  file=<span class="string">"templates/agreement.html"</span>%&gt;</div><div class="line">    &lt;%@ include  file=<span class="string">"templates/paySuccess.html"</span>%&gt;</div><div class="line">    &lt;%@ include  file=<span class="string">"templates/onlineOffline.html"</span>%&gt;</div><div class="line">    &lt;%@ include  file=<span class="string">"templates/address.html"</span>%&gt;</div><div class="line">    &lt;%@ include  file=<span class="string">"templates/addressInput.html"</span>%&gt;</div><div class="line">    &lt;%@ include  file=<span class="string">"templates/storeList.html"</span>%&gt;</div><div class="line">    &lt;%@ include  file=<span class="string">"templates/hotel.html"</span>%&gt;</div><div class="line">    &lt;%@ include  file=<span class="string">"templates/dateRanger.html"</span>%&gt;</div><div class="line">    &lt;%@ include  file=<span class="string">"templates/hotelList.html"</span>%&gt;</div><div class="line">    &lt;%@ include  file=<span class="string">"templates/changeTime.html"</span>%&gt;</div><div class="line">    &lt;%@ include  file=<span class="string">"templates/selectStore.html"</span>%&gt; </div><div class="line">&lt;/head&gt;</div><div class="line">&lt;body&gt;</div><div class="line">	&lt;div id=<span class="string">"content"</span>&gt;</div><div class="line">        &lt;div id=<span class="string">"index-con"</span> class=<span class="string">"page"</span>&gt;&lt;/div&gt;</div><div class="line">        &lt;div id=<span class="string">"my-con"</span> class=<span class="string">"page"</span>&gt;&lt;/div&gt;</div><div class="line">        &lt;div id=<span class="string">"myInfo-con"</span> class=<span class="string">"page"</span>&gt;&lt;/div&gt;</div><div class="line">        &lt;div id=<span class="string">"myAccount-con"</span> class=<span class="string">"page"</span>&gt;&lt;/div&gt;</div><div class="line">        &lt;div id=<span class="string">"order-con"</span> class=<span class="string">"page"</span>&gt;&lt;/div&gt;</div><div class="line">        &lt;div id=<span class="string">"service-con"</span> class=<span class="string">"page"</span>&gt;&lt;/div&gt;</div><div class="line">        &lt;div id=<span class="string">"yhj-con"</span> class=<span class="string">"page"</span>&gt;&lt;/div&gt;</div><div class="line">        &lt;div id=<span class="string">"login-con"</span> class=<span class="string">"page"</span>&gt;&lt;/div&gt;</div><div class="line">        &lt;div id=<span class="string">"petInfoInput-con"</span> class=<span class="string">"page"</span>&gt;&lt;/div&gt;</div><div class="line">        &lt;div id=<span class="string">"listServicePrice-con"</span> class=<span class="string">"page"</span>&gt;&lt;/div&gt;</div><div class="line">        &lt;div id=<span class="string">"petColor-con"</span> class=<span class="string">"page"</span>&gt;&lt;/div&gt;</div><div class="line">        &lt;div id=<span class="string">"petFood-con"</span> class=<span class="string">"page "</span> &gt;&lt;/div&gt;</div><div class="line">        &lt;div id=<span class="string">"petBreed-con"</span> class=<span class="string">"page"</span>&gt;&lt;/div&gt;</div><div class="line">        &lt;div id=<span class="string">"petList-con"</span> class=<span class="string">"page"</span>&gt;&lt;/div&gt;</div><div class="line">        &lt;div id=<span class="string">"orderDetail-con"</span> class=<span class="string">"page"</span>&gt;&lt;/div&gt;</div><div class="line">        &lt;div id=<span class="string">"orderAccess-con"</span> class=<span class="string">"page"</span>&gt;&lt;/div&gt;</div><div class="line">        &lt;div id=<span class="string">"accessDetail-con"</span> class=<span class="string">"page"</span>&gt;&lt;/div&gt;</div><div class="line">        &lt;div id=<span class="string">"agreement-con"</span> class=<span class="string">"page"</span>&gt;&lt;/div&gt;</div><div class="line">        &lt;div id=<span class="string">"paySuccess-con"</span> class=<span class="string">"page"</span>&gt;&lt;/div&gt;</div><div class="line">        &lt;div id=<span class="string">"onlineOffline-con"</span> class=<span class="string">"page"</span>&gt;&lt;/div&gt;</div><div class="line">        &lt;div id=<span class="string">"address-con"</span> class=<span class="string">"page"</span>&gt;&lt;/div&gt;</div><div class="line">        &lt;div id=<span class="string">"addressInput-con"</span> class=<span class="string">"page"</span>&gt;&lt;/div&gt;</div><div class="line">        &lt;div id=<span class="string">"storeList-con"</span> class=<span class="string">"page"</span>&gt;&lt;/div&gt;</div><div class="line">        &lt;div id=<span class="string">"hotel-con"</span> class=<span class="string">"page"</span>&gt;&lt;/div&gt;</div><div class="line">        &lt;div id=<span class="string">"dateRanger-con"</span> class=<span class="string">"page"</span>&gt;&lt;/div&gt;</div><div class="line">        &lt;div id=<span class="string">"hotelList-con"</span> class=<span class="string">"page"</span>&gt;&lt;/div&gt;</div><div class="line">        &lt;div id=<span class="string">"changeTime-con"</span> class=<span class="string">"page"</span>&gt;&lt;/div&gt;</div><div class="line">    &lt;/div&gt;</div><div class="line"></div><div class="line">    &lt;script <span class="built_in">type</span>=<span class="string">"text/javascript"</span>&gt;</div><div class="line">    	window.onhashchange = <span class="function"><span class="title">function</span></span>()&#123;</div><div class="line">            clearCovers();</div><div class="line">            //重置分享链接</div><div class="line">            <span class="keyword">if</span>(!window.G_ISAPP) <span class="built_in">set</span>WxData();</div><div class="line">            var <span class="built_in">hash</span>Str, paramStr;</div><div class="line">            <span class="built_in">hash</span>Str = util.getNowHash();</div><div class="line">            paramStr = util.getParamStr();</div><div class="line">            $(<span class="string">'.nowpage.page'</span>).removeClass(<span class="string">'nowpage'</span>);</div><div class="line">            $(<span class="string">'#'</span> + <span class="built_in">hash</span>Str + <span class="string">'-con'</span>).addClass(<span class="string">'nowpage'</span>);</div><div class="line">            util.clearStoreId(<span class="built_in">hash</span>Str);</div><div class="line">            util.hideFooter(<span class="built_in">hash</span>Str);            //根据当前<span class="built_in">hash</span>判断是否隐藏footer</div><div class="line">            var params = util.str2Params(paramStr);</div><div class="line">            window[<span class="built_in">hash</span>Str].onCreate(params);</div><div class="line">        &#125;;</div><div class="line">    &lt;/script&gt;</div><div class="line">&lt;/body&gt;</div></pre></td></tr></table></figure></p>
<p>index.jsp结构大概如上，先加载完所有的模板文件和js，css文件，之后通过onhashchange回调，将不同的模板填充到对应的page容器中。和所有单页应用一样，弊端在于首次加载时间过长。但是考虑到业务不是很复杂，页面也不多，真实gulp压缩js后控制在330k左右。可以接受。当然这是在微信中作为一整个web app。</p>
<p>但嵌入app的各个入口中情况就不一样了。<br><img src="http://i2.buimg.com/1d7c859e0f14631c.png"><br>点击洗澡，洁牙。。等等入口都会打开一个新的webview，如果都去加载整个index.jsp。虽然方便，但是效果可想而知。</p>
<p>思考1：<br>尝试用sea.js等按需加载库解决问题。但有三个困难点：<br>1.因为是单页，变量之间已经有一定耦合，项目大致已经完成。再去进行模块化和依赖关系的整理，恐怕会出问题；<br>2.sea.js目前只能模块化js。类似10几个模板文件这样依然很大，依然只有一次性加载，效果一般。当然还有webpack，不过暂且还没接触过；<br>3.页面切换的时机只在onhashchange。这样所有require js会变得很冗杂<br>另外按需加载也就相当于抛弃了单页应用的一个优点吧。这样渲染新模板的时候同时还是要加载js。效果也不好。</p>
<p>思考2：<br>最终解决方案，按照传递参数不同，jsp include不同的文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div></pre></td><td class="code"><pre><div class="line">&lt;%</div><div class="line">   //根据入口不同，加载不同的资源文件</div><div class="line">   boolean[] mods = new boolean[24];</div><div class="line">   int i=0,ilen=mods.length;</div><div class="line">   <span class="keyword">for</span>(i=0; i&lt;ilen; i++)&#123;</div><div class="line">       mods[i] = <span class="literal">false</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span>(from==null || from.equals(<span class="string">"web"</span>))&#123;         //从微信中，引入所有文件</div><div class="line">       <span class="keyword">for</span>(i=0; i&lt;ilen; i++)&#123;</div><div class="line">           mods[i] = <span class="literal">true</span>;</div><div class="line">       &#125;</div><div class="line">   &#125; <span class="keyword">else</span> &#123;      //app</div><div class="line">       <span class="keyword">if</span>(from.equals(<span class="string">"onlineOffline"</span>))&#123;   //点击进入服务选择</div><div class="line">           mods[0]=<span class="literal">true</span>;</div><div class="line">           mods[1]=<span class="literal">true</span>;</div><div class="line">           mods[2]=<span class="literal">true</span>;</div><div class="line">           mods[3]=<span class="literal">true</span>;</div><div class="line">           mods[4]=<span class="literal">true</span>;</div><div class="line">           mods[5]=<span class="literal">true</span>;</div><div class="line">           mods[6]=<span class="literal">true</span>;</div><div class="line">           mods[7]=<span class="literal">true</span>;</div><div class="line">           mods[9]=<span class="literal">true</span>;</div><div class="line">           mods[10]=<span class="literal">true</span>;</div><div class="line">           mods[11]=<span class="literal">true</span>;</div><div class="line">           mods[12]=<span class="literal">true</span>;</div><div class="line">           mods[14]=<span class="literal">true</span>;</div><div class="line">           mods[15]=<span class="literal">true</span>;</div><div class="line">           mods[16]=<span class="literal">true</span>;</div><div class="line">           mods[17]=<span class="literal">true</span>;</div><div class="line">           mods[19]=<span class="literal">true</span>;</div><div class="line">           mods[20]=<span class="literal">true</span>;</div><div class="line">           mods[21]=<span class="literal">true</span>;</div><div class="line">           mods[22]=<span class="literal">true</span>;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   %&gt;</div><div class="line">&lt;% <span class="keyword">if</span>(mods[0])&#123; %&gt;</div><div class="line">    &lt;script src=<span class="string">"library/template-native-debug.js"</span>&gt;&lt;/script&gt;</div><div class="line">    &lt;script src=<span class="string">"library/fastclick.js"</span>&gt;&lt;/script&gt;</div><div class="line">    &lt;script src=<span class="string">"library/jquery.min.js"</span>&gt;&lt;/script&gt;</div><div class="line">    &lt;script src=<span class="string">"library/iscroll-lite.js"</span>&gt;&lt;/script&gt;</div><div class="line">&lt;% &#125; %&gt;</div><div class="line">&lt;% <span class="keyword">if</span>(mods[1])&#123; %&gt;</div><div class="line">    &lt;link rel=<span class="string">"stylesheet"</span> href=<span class="string">"css/base.css"</span>&gt;</div><div class="line">&lt;% &#125; %&gt;</div><div class="line">&lt;% <span class="keyword">if</span>(mods[2])&#123; %&gt;</div><div class="line">    &lt;link rel=<span class="string">"stylesheet"</span> href=<span class="string">"css/main.css"</span>&gt;</div><div class="line">&lt;% &#125; %&gt;</div><div class="line">&lt;% <span class="keyword">if</span>(mods[3])&#123; %&gt;</div><div class="line">    &lt;link rel=<span class="string">"stylesheet"</span> href=<span class="string">"css/spinningwheel-didi.css"</span>&gt;</div><div class="line">    &lt;script src=<span class="string">"library/spinningwheel-didi.js"</span>&gt;&lt;/script&gt;</div><div class="line">&lt;% &#125; %&gt;</div><div class="line">&lt;% <span class="keyword">if</span>(mods[4])&#123; %&gt;</div><div class="line">    &lt;link rel=<span class="string">"stylesheet"</span> href=<span class="string">"css/swiper.css"</span>&gt;</div><div class="line">    &lt;script src=<span class="string">"library/swiper-3.3.1.jquery.min.js"</span>&gt;&lt;/script&gt;</div><div class="line">&lt;% &#125; %&gt;</div><div class="line">&lt;% <span class="keyword">if</span>(mods[5])&#123; %&gt;</div><div class="line">    &lt;%@ include  file=<span class="string">"templates/dialog.html"</span>%&gt;</div><div class="line">&lt;% &#125; %&gt;</div><div class="line">&lt;% <span class="keyword">if</span>(mods[6])&#123; %&gt;</div><div class="line">    &lt;script src=<span class="string">"js/services/util.js?time=3df534d3"</span>&gt;&lt;/script&gt;</div><div class="line">    &lt;script <span class="built_in">type</span>=<span class="string">"text/javascript"</span> src=<span class="string">"http://webapi.amap.com/maps?v=1.3&amp;key=950f0eafe4a4b4c2ab150a2c0141d173&amp;plugin=AMap.Geocoder,AMap.PlaceSearch"</span>&gt;&lt;/script&gt;</div><div class="line">    &lt;script src=<span class="string">"js/services/map.js?time=3df3"</span>&gt;&lt;/script&gt;</div><div class="line">&lt;% &#125; %&gt;</div><div class="line">&lt;% <span class="keyword">if</span>(mods[7])&#123; %&gt;</div><div class="line">    &lt;%@ include  file=<span class="string">"templates/orderAccess.html"</span>%&gt;</div><div class="line">    &lt;%@ include  file=<span class="string">"templates/accessDetail.html"</span>%&gt;</div><div class="line">    &lt;script src=<span class="string">"js/controllers/orderAccess.js?time=12sdfsd"</span>&gt;&lt;/script&gt;</div><div class="line">    &lt;script src=<span class="string">"js/controllers/accessDetail.js?time=324sdfsd"</span>&gt;&lt;/script&gt;</div><div class="line">&lt;% &#125; %&gt;</div><div class="line">&lt;% <span class="keyword">if</span>(mods[8])&#123; %&gt;</div><div class="line">    &lt;%@ include  file=<span class="string">"templates/index.html"</span> %&gt;</div><div class="line">    &lt;script src=<span class="string">"js/controllers/index.js?time=0sdffds9"</span>&gt;&lt;/script&gt;</div><div class="line">&lt;% &#125; %&gt;</div><div class="line">&lt;% <span class="keyword">if</span>(mods[9])&#123; %&gt;</div><div class="line">    &lt;%@ include  file=<span class="string">"templates/onlineOffline.html"</span>%&gt;</div><div class="line">    &lt;script src=<span class="string">"js/controllers/onlineOffline.js"</span>&gt;&lt;/script&gt;</div><div class="line">&lt;% &#125; %&gt;</div><div class="line">&lt;% <span class="keyword">if</span>(mods[10])&#123; %&gt;</div><div class="line">    &lt;%@ include  file=<span class="string">"templates/service.html"</span> %&gt;</div><div class="line">    &lt;%@ include  file=<span class="string">"templates/serviceTime.html"</span>%&gt;</div><div class="line">    &lt;%@ include  file=<span class="string">"templates/listServicePrice.html"</span>%&gt;</div><div class="line">    &lt;script src=<span class="string">"js/controllers/service.js?time=9s99055"</span>&gt;&lt;/script&gt;</div><div class="line">    &lt;script src=<span class="string">"js/controllers/listServicePrice.js?time=3df3"</span>&gt;&lt;/script&gt;</div><div class="line">&lt;% &#125; %&gt;</div></pre></td></tr></table></figure></p>
<p>简而言之，不同的入口需要不同的模板和不同的js文件，css文件。那么就按照它所需要的提供相应的这些资源文件就可以了。实际相当于将大的单页划分成很多小单页</p>
<p>在其中遇到一个问题，由此引出了一部分知识：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">//原始页面</div><div class="line">response.sendRedirect(hostStr + <span class="string">"/index.jsp#/onlineOffline?entrance=onlineOffline&amp;serviceType="</span> + serviceType1);</div><div class="line"></div><div class="line">//index.jsp</div><div class="line">String from = request.getParameter(<span class="string">"entrance"</span>);</div></pre></td></tr></table></figure></p>
<p>这是刚开始的时候我用来重定向传参的url和拿去url参数的方法。但很奇怪的是from总为空。查完资料后总结如下：</p>
<div style="color:red; font-size:bold;"><br><p>1. url中#之后的都被浏览器认为是地址符。onhashchange回调中该变的hash。 location.hash得到的就是：#/onlineOffline?entrance=onlineOffline&amp;serviceType=1;                这也解释了为什么单页应用的参数必须在#之后，如果在#之前，任何字符的改变都会导致页面刷新，而之后hash值改变页面不会刷新，并且会记录历史。这也是单页应用的基础</p><br><p>2. #之后的字符用来在浏览器端做向导，不会被传递到server端。所以在服务器端url是这样的:<a href="http://testsaas-1000-100001.m.izhuazhua.com/index.jsp" target="_blank" rel="external">http://testsaas-1000-100001.m.izhuazhua.com/index.jsp</a>. 这也就是为什么request.getParameter();request.getQueryString()获得的值都为空的原因</p><br></div>

<p>那么怎么讲标示参数传递到index.jsp呢。最终url如下：<br>response.sendRedirect(hostStr + “/index.jsp?entrance=onlineOffline#/onlineOffline?serviceType=” + serviceType1);<br>移到#之前就可以了。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/05/30/20160530/" data-id="ciyvlrhpb002jocvr70oho6ka" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/js/">js</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/spa/">spa</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/单页应用中的按需加载/">单页应用中的按需加载</a></li></ul>

    </footer>
  </div>
  
</article>




  
    <article id="post-20160402" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/04/02/20160402/" class="article-date">
  <time datetime="2016-04-01T16:00:00.000Z" itemprop="datePublished">2016-04-02</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/js/">js</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/04/02/20160402/">js实现图片切图</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>刚到的这创业公司还真是忙啊，web前端就我一个，最近时间忙一个微信上的saas系统，都快一个月时间没空写博客了。项目快忙完了，也顺便总结下自己遇到的几个问题，这里说得是canvas实现切图</p>
<p>首先想到的是js如何操作图片数据呢，毕竟js没有读写函数，但查了下资料，html5有file api，可见还是要多去了解html5新技术的应用</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">&lt;html&gt;</div><div class="line">&lt;head&gt;</div><div class="line">&lt;/head&gt;</div><div class="line">&lt;body&gt;</div><div class="line">   	&lt;input <span class="built_in">type</span>=<span class="string">"file"</span> value=<span class="string">""</span> id=<span class="string">"petImg-input"</span> accept=<span class="string">"image/*"</span> style=<span class="string">"display:none;"</span>/&gt;</div><div class="line">   	&lt;div id=<span class="string">"image-cropper"</span> style=<span class="string">"display:none; z-index:10; position:absolute; top:0; bottom:0; left:0; right:0; background-color:black;"</span>&gt;</div><div class="line">       &lt;div id=<span class="string">"image-area"</span> style=<span class="string">" position:absolute; top:10px; left: 50%; -webkit-transform:translateX(-50%); "</span>&gt;</div><div class="line">           &lt;img id=<span class="string">"corp-img"</span> style=<span class="string">"max-width:650px; max-height:700px; display:block;"</span>&gt;</div><div class="line">           &lt;div id=<span class="string">"corp-div"</span> style=<span class="string">"visibility:hidden; border:1px solid white; width:200px; height:200px; position:absolute; top:0; left:0; background-color: rgba(0, 0, 0, 0.2);"</span>&gt;</div><div class="line">               &lt;i id=<span class="string">"resize-point"</span> style=<span class="string">"display:block; width:30px; height:30px; border:1px solid white; border-radius:15px; position:absolute; right:-15px; bottom:-15px"</span>&gt;&lt;/i&gt;</div><div class="line">           &lt;/div&gt;</div><div class="line">       &lt;/div&gt;</div><div class="line">       &lt;canvas id=<span class="string">"crop-canvas"</span> width=<span class="string">"200"</span> height=<span class="string">"200"</span> style=<span class="string">"position:absolute; display:none;"</span>&gt;&lt;/canvas&gt;</div><div class="line">    &lt;/div&gt;</div><div class="line">    &lt;div id=<span class="string">"cropper-btns"</span> style=<span class="string">"position:absolute; z-index:12; bottom:30px; width:100%; height:80px; display:none;"</span>&gt;</div><div class="line">        &lt;span id=<span class="string">"cropper-sure"</span> style=<span class="string">"display: block;width: 150px;height: 80px;line-height: 80px;text-align: center; font-size: 32px;color: white;float: left;"</span>&gt;确定&lt;/span&gt;</div><div class="line">        &lt;span id=<span class="string">"cropper-cancel"</span>  style=<span class="string">"display: block;width: 150px;height: 80px;line-height: 80px;text-align: center; font-size: 32px;color: white;float: right;"</span>&gt;取消&lt;/span&gt;</div><div class="line">    &lt;/div&gt;</div><div class="line">   	&lt;script <span class="built_in">type</span>=<span class="string">"text/javascript"</span>&gt;</div><div class="line">   		var imgInput = document.querySelector(<span class="string">'#petImg-input'</span>);</div><div class="line">   		var cropImg = document.querySelector(<span class="string">'#corp-img'</span>);</div><div class="line"></div><div class="line">   		imgInput.addEventListener(<span class="string">'change'</span>, <span class="keyword">function</span>(file)&#123;</div><div class="line">			var reader = new FileReader();</div><div class="line">			reader.readAsDataURL(file);</div><div class="line">			reader.onload = <span class="function"><span class="title">function</span></span>()&#123;</div><div class="line">				//展示用图片</div><div class="line">				cropImg.src = reader.result;</div><div class="line">				//裁剪逻辑......</div><div class="line">			&#125;</div><div class="line">   		&#125;, <span class="literal">false</span>);</div><div class="line">   	&lt;/script&gt;</div><div class="line">&lt;/body&gt;</div><div class="line">&lt;/html&gt;</div></pre></td></tr></table></figure>
<p>FileReader对象允许访问Blob中的字符或字节，可以把它视为是BlobBuilder对应的一个对象。FileReader共有readAsText(), readAsArrayBuffer(), readAsDataURL(),readAsBinaryString()几个读取方法</p>
<p>但input type=file这种方式选取和读取本地文件在移动端却兼容性很差，很多手机上调不起本地图库。所以代替用微信jssdk解决图像选取这部分的问题。裁剪仍然用之前的逻辑。<br>微信图像接口主要有<br>wx.chooseImage({<br>    count: 1, // 默认9<br>    sizeType: [‘original’, ‘compressed’], // 可以指定是原图还是压缩图，默认二者都有<br>    sourceType: [‘album’, ‘camera’], // 可以指定来源是相册还是相机，默认二者都有<br>    success: function (res) {<br>        var localIds = res.localIds; // 返回选定照片的本地ID列表，localId可以作为img标签的src属性显示图片<br>    }<br>});<br>返回的localIds只是一段普通的字符串，并不能借此获取图片源信息，也就不能裁剪，所以还得用<br>wx.uploadImage({<br>    localId: ‘’, // 需要上传的图片的本地ID，由chooseImage接口获得<br>    isShowProgressTips: 1, // 默认为1，显示进度提示<br>    success: function (res) {<br>        var serverId = res.serverId; // 返回图片的服务器端ID<br>    }<br>});<br>将图片上传到微信服务器。但上传的图片有效期是三天，所以还需要用自己的服务器将图片存储下来<br>http请求方式: GET<br><a href="http://file.api.weixin.qq.com/cgi-bin/media/get?access_token=ACCESS_TOKEN&amp;media_id=MEDIA_ID" target="_blank" rel="external">http://file.api.weixin.qq.com/cgi-bin/media/get?access_token=ACCESS_TOKEN&amp;media_id=MEDIA_ID</a><br>调用微信多媒体下载接口就可以了。</p>
<p>整个流程出来了。先使用chooseImage之后在回调中调用uploadImage。之后请求后台自己的接口拉取微信图片服务器中的图片，并且返回base64字符串就行<br><strong style="color:red;">注：这里有个坑！！！起初为了减少数据量传输，本来只打算返回cdn上的图片url就行，想通过canvas的getImageData获取图片base64信息，后来调这个方法总是报错，查了下，是有跨域的限制，原来canvas也有跨域的限制，学习了，果然浏览器对于安全的限制无处不在</strong><br>有了base64信息，接下来就是裁剪了。裁剪方法也很简单：<br>1.将base64字符串赋值给corpimg.src作为展示；<br>2.使用oCropDiv作为裁剪框，加上拖动和拉伸改变大小的效果；<br>3.点击确定裁剪的时候，根据oCropDiv的大小和位置坐标，将图片的一部分drawImage到canvas上，再通过getImageData获取裁剪的图片的base64字符串，并且调用后台接口上传<br>完整代码如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div></pre></td><td class="code"><pre><div class="line">            var maxWidth = 650, maxHeight=700, transformRatio=1;</div><div class="line">            var cropImg = $(&apos;#corp-img&apos;);</div><div class="line">            var cropCanvas = $(&apos;#crop-canvas&apos;);</div><div class="line">            var cropDiv = $(&apos;#corp-div&apos;);</div><div class="line">            var resizePoint = $(&apos;#resize-point&apos;);</div><div class="line">            var imageCropper = $(&apos;#image-cropper&apos;);</div><div class="line">            var imageArea = $(&apos;#image-area&apos;);</div><div class="line">            $(&apos;.petInfoInput-page .pet-Img&apos;).on(&apos;click&apos;, function(ev)&#123;</div><div class="line">                wx.chooseImage(&#123;</div><div class="line">                    count: 1, // 默认9</div><div class="line">                    sizeType: [&apos;original&apos;, &apos;compressed&apos;], // 可以指定是原图还是压缩图，默认二者都有</div><div class="line">                    sourceType: [&apos;album&apos;, &apos;camera&apos;], // 可以指定来源是相册还是相机，默认二者都有</div><div class="line">                    success: function (res) &#123;</div><div class="line">                        var localIds = res.localIds; //返回选定照片的本地ID列表，localId可以作为img标签的src属性显示图片</div><div class="line">                        //显示裁剪浮层</div><div class="line">                        imageCropper.css(&apos;display&apos;,&apos;block&apos;);</div><div class="line">                        //显示loading</div><div class="line">                        util.loading();</div><div class="line"></div><div class="line">                        wx.uploadImage(&#123;</div><div class="line">                            localId: localIds[0], // 需要上传的图片的本地ID，由chooseImage接口获得</div><div class="line">                            isShowProgressTips: 0, // 默认为1，显示进度提示</div><div class="line">                            success: function (res) &#123;</div><div class="line">                                var serverId = res.serverId; // 返回图片的服务器端ID</div><div class="line">                                util.ajaxData(&apos;/json/SAAS_H5_GetImageToWx&apos;, &#123;type:2, mediaId:serverId&#125;).done(function(data)&#123;    //1是个人，2是宠物</div><div class="line">                                    var corpimg = document.getElementById(&apos;corp-img&apos;);</div><div class="line">                                    corpimg.src = &apos;data:image/jpg;base64,&apos; + data.body[&quot;img&quot;].trim();</div><div class="line">                                    alert(corpimg.src);</div><div class="line">                                    corpimg.onload = function()&#123;</div><div class="line">                                        util.loading(true);</div><div class="line"></div><div class="line">                                        var imgNw = cropImg[0].naturalWidth;</div><div class="line">                                        var imgNh = cropImg[0].naturalHeight;</div><div class="line"></div><div class="line">                                        if(imgNh&gt;maxHeight || imgNw&gt;maxWidth)&#123;  //图片被压缩了</div><div class="line">                                            if(imgNw&gt;imgNh)&#123;</div><div class="line">                                                transformRatio = imgNw / maxWidth;</div><div class="line">                                                cropDiv.css(&#123;&apos;width&apos;:imgNh/transformRatio, &apos;height&apos;:imgNh/transformRatio&#125;);</div><div class="line">                                            &#125; else &#123;        //img压缩高度宽度不会被改变，需要自己调整</div><div class="line">                                                transformRatio = imgNh / maxHeight;</div><div class="line">                                                cropImg.css(&apos;width&apos;, imgNw/transformRatio);</div><div class="line">                                                cropDiv.css(&#123;&apos;width&apos;:imgNw/transformRatio, &apos;height&apos;:imgNw/transformRatio&#125;);</div><div class="line">                                            &#125;</div><div class="line">                                        &#125; else &#123;                             //需要拉伸图片</div><div class="line">                                            if(imgNw&gt;imgNh)&#123;</div><div class="line">                                                transformRatio = imgNw/maxWidth;</div><div class="line">                                                cropImg.css(&#123;</div><div class="line">                                                    &apos;width&apos;: maxWidth,</div><div class="line">                                                    &apos;height&apos;: imgNh/transformRatio</div><div class="line">                                                &#125;);</div><div class="line">                                                cropDiv.css(&#123;&apos;width&apos;:maxHeight, &apos;height&apos;:maxHeight&#125;);</div><div class="line">                                            &#125; else &#123;</div><div class="line">                                                transformRatio = imgNh/maxHeight;</div><div class="line">                                                cropImg.css(&#123;</div><div class="line">                                                    &apos;width&apos;: maxWidth/transformRatio,</div><div class="line">                                                    &apos;height&apos;: maxHeight</div><div class="line">                                                &#125;);</div><div class="line">                                                cropDiv.css(&#123;&apos;width&apos;:maxHeight, &apos;height&apos;:maxHeight&#125;);</div><div class="line">                                            &#125;</div><div class="line">                                        &#125;</div><div class="line">                                    &#125;;</div><div class="line">                                &#125;).fail(function()&#123;</div><div class="line">                                    util.toster(&apos;图片上传失败&apos;);</div><div class="line">                                &#125;);</div><div class="line">                            &#125;</div><div class="line">                        &#125;);</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">                ev.stopImmediatePropagation();</div><div class="line">                ev.preventDefault();</div><div class="line">            &#125;);</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">            var oImageArea = document.getElementById(&apos;image-area&apos;);</div><div class="line">            oImageArea.addEventListener(&apos;click&apos;, function(e)&#123;</div><div class="line">                var deltax = e.pageX - (360-imageArea.width()/2) - cropDiv.width()/2;</div><div class="line">                var deltay = e.pageY - cropDiv.height()/2;</div><div class="line">                cropDiv.css(&#123;</div><div class="line">                    &apos;left&apos;: deltax,</div><div class="line">                    &apos;top&apos;: deltay</div><div class="line">                &#125;);</div><div class="line">                e.stopImmediatePropagation();</div><div class="line">                e.preventDefault();</div><div class="line">            &#125;);</div><div class="line"></div><div class="line">            var sx,sy,nowleft,nowtop, oCropDiv=document.getElementById(&apos;corp-div&apos;);</div><div class="line">            oCropDiv.addEventListener(&apos;touchstart&apos;, function(e)&#123;</div><div class="line">                sx = e.changedTouches[0].pageX;</div><div class="line">                sy = e.changedTouches[0].pageY;</div><div class="line">                nowleft = parseFloat($(this).css(&apos;left&apos;).slice(0,-2));</div><div class="line">                nowtop = parseFloat($(this).css(&apos;top&apos;).slice(0,-2));</div><div class="line">            &#125;);</div><div class="line">            oCropDiv.addEventListener(&apos;touchmove&apos;, function(e)&#123;</div><div class="line">                var deltax = e.changedTouches[0].pageX - sx;</div><div class="line">                var deltay = e.changedTouches[0].pageY - sy;</div><div class="line">                // console.log(deltax + &apos; &apos; +  deltay);</div><div class="line">                $(this).css(&#123;</div><div class="line">                    &apos;left&apos;: nowleft + deltax,</div><div class="line">                    &apos;top&apos;: nowtop + deltay</div><div class="line">                &#125;);</div><div class="line">            &#125;);</div><div class="line">            oCropDiv.addEventListener(&apos;touchend&apos;, function(e)&#123;</div><div class="line">                sx = e.changedTouches[0].pageX;</div><div class="line">                sy = e.changedTouches[0].pageY;</div><div class="line">                //检测边界问题</div><div class="line">                self.checkBound(cropDiv, imageArea, 1);</div><div class="line">            &#125;);</div><div class="line"></div><div class="line">            var px,py,nowwidth,nowheight, oResizePoint=document.getElementById(&apos;resize-point&apos;);</div><div class="line">            oResizePoint.addEventListener(&apos;touchstart&apos;, function(e)&#123;</div><div class="line">                px = e.changedTouches[0].pageX;</div><div class="line">                py = e.changedTouches[0].pageY;</div><div class="line">                nowwidth = $(cropDiv).width();</div><div class="line">                nowheight = $(cropDiv).height();</div><div class="line">                e.stopImmediatePropagation();</div><div class="line">                e.preventDefault();</div><div class="line">            &#125;);</div><div class="line">            oResizePoint.addEventListener(&apos;touchmove&apos;, function(e)&#123;</div><div class="line">                var deltax = e.changedTouches[0].pageX - px;</div><div class="line">                var deltay = e.changedTouches[0].pageY - py;</div><div class="line">                $(cropDiv).css(&#123;</div><div class="line">                    &apos;width&apos;: nowwidth + deltax,</div><div class="line">                    &apos;height&apos;: nowheight + deltay</div><div class="line">                &#125;);</div><div class="line">                e.stopImmediatePropagation();</div><div class="line">                e.preventDefault();</div><div class="line">            &#125;);</div><div class="line">            oResizePoint.addEventListener(&apos;touchend&apos;, function(e)&#123;</div><div class="line">                px = e.changedTouches[0].pageX;</div><div class="line">                py = e.changedTouches[0].pageY;</div><div class="line">                //检测边界问题</div><div class="line">                self.checkBound(cropDiv, imageArea, 2);</div><div class="line">                e.stopImmediatePropagation();</div><div class="line">                e.preventDefault();</div><div class="line">            &#125;);</div><div class="line"></div><div class="line">//            var canvas = document.getElementById(&apos;crop-canvas&apos;);</div><div class="line">//            var ctx = canvas.getContext(&apos;2d&apos;);</div><div class="line">            $(&apos;#cropper-sure&apos;).on(&apos;click&apos;, function(e)&#123;</div><div class="line">                util.loading(false);</div><div class="line">                //需要乘上devicePixelRatio，canvas坐标使用的是物理像素  * devicePixelRatio</div><div class="line">                var x = transformRatio  * parseFloat($(cropDiv).css(&apos;left&apos;).slice(0,-2));</div><div class="line">                var y = transformRatio  * parseFloat($(cropDiv).css(&apos;top&apos;).slice(0,-2));</div><div class="line">                var wid = transformRatio  * $(cropDiv).width();</div><div class="line">                var hei = transformRatio  * $(cropDiv).height();</div><div class="line">//                cropCanvas.attr(&#123;&quot;width&quot;:wid, &quot;height&quot;:hei&#125;);</div><div class="line">                var cropCan = document.getElementById(&quot;crop-canvas&quot;);</div><div class="line">                var cropImage = document.getElementById(&quot;corp-img&quot;);</div><div class="line">                cropImage.crossOrigin = &quot;Anonymous&quot;;</div><div class="line">                cropCan.width = wid;</div><div class="line">                cropCan.height = hei;</div><div class="line">                var ctx = cropCan.getContext(&apos;2d&apos;);</div><div class="line">                ctx.drawImage(cropImage, x, y, wid, hei, 0, 0, wid, hei);</div><div class="line">                var data = cropCan.toDataURL();</div><div class="line">                alert(&quot;imgdata&quot; + data);</div><div class="line">                $.ajax(&#123;</div><div class="line">                    type: &apos;post&apos;,</div><div class="line">                    url: &apos;/imageupload&apos;,</div><div class="line">                    data:&#123;type:&apos;petimg&apos;, base64:data&#125;,</div><div class="line">                    dataType: &apos;json&apos;,</div><div class="line">                    success: function(res)&#123;</div><div class="line">                        if(res &amp;&amp; res.code == 0)&#123;</div><div class="line">                            util.toster(&apos;保存成功&apos;);</div><div class="line">                            $(&apos;.petImg-show&apos;).attr(&apos;src&apos;, data);        //设置显示</div><div class="line">                            $(&apos;#image-cropper&apos;).css(&apos;display&apos;, &apos;none&apos;);</div><div class="line"></div><div class="line">                            $(&apos;.petImg-show&apos;).attr(&apos;data-id&apos;, res.imageId);</div><div class="line">                            self.checkChange(1);</div><div class="line">                        &#125; else &#123;</div><div class="line">                            util.toster(&apos;保存失败&apos;);</div><div class="line">                        &#125;</div><div class="line">                    &#125;,</div><div class="line">                    error: function()&#123;</div><div class="line">                        util.toster(&apos;保存失败&apos;);</div><div class="line">                    &#125;,</div><div class="line">                    complete: function()&#123;</div><div class="line">                        util.loading(true);</div><div class="line">                    &#125;</div><div class="line">                &#125;)</div><div class="line">            &#125;);</div><div class="line"></div><div class="line">            $(&apos;#cropper-cancel&apos;).on(&apos;click&apos;, function()&#123;</div><div class="line">                setTimeout(function()&#123;</div><div class="line">                    $(&apos;#image-cropper&apos;).css(&apos;display&apos;, &apos;none&apos;);</div><div class="line">                &#125;, 500);</div><div class="line">            &#125;);</div></pre></td></tr></table></figure></p>
<p>其中还考虑了两个问题：<br>1.图像压缩的问题，限定最大宽maxWidth和高maxHeight，图片等比例压缩，计算出缩小或者拉伸的比例transformRatio。在canvas drawImage的时候要将cropdiv的坐标和高度乘上相应比例<br>2.边界超出处理，如果拉伸大小或者拖动超出边界，都直接回正</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/04/02/20160402/" data-id="ciyvlrhmg000nocvrfn5h40bc" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/canvas/">canvas</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/切图/">切图</a></li></ul>

    </footer>
  </div>
  
</article>




  
    <article id="post-20160215" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/02/15/20160215/" class="article-date">
  <time datetime="2016-02-14T16:00:00.000Z" itemprop="datePublished">2016-02-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/css/">css</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/02/15/20160215/">offsetHeight,clientHeight和scrollHeight的区别</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>我们在写页面的时候经常会遇到判断是否滚动也页底的情况，比如在我的上一篇博客中的瀑布流插件的实现中就需要滑动到页底加载下一页的功能。这是大家会不会很头晕，clientTop，offsetTop，scrollTop这些怎么使用？</p>
<p>先google之，拿到两张图<br><img src="http://i.stack.imgur.com/zWca7.png"><br><img src="http://pic002.cnblogs.com/images/2011/85285/2011102915280329.jpg"><br>大概有一定了解</p>
<p>自己写个demo检验一下<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line">&lt;!doctype html&gt;</div><div class="line">&lt;html&gt;</div><div class="line">&lt;head&gt;</div><div class="line">	&lt;meta charset=<span class="string">"utf-8"</span>&gt;</div><div class="line">	&lt;style&gt;</div><div class="line">		<span class="comment">#container&#123;</span></div><div class="line">			height:200px; </div><div class="line">			width:200px; 		</div><div class="line">			border:5px solid blue;</div><div class="line">			padding:10px;</div><div class="line">			margin:10px;</div><div class="line">		&#125;</div><div class="line">		<span class="comment">#content&#123;</span></div><div class="line">			height:100%;</div><div class="line">			padding:8px;</div><div class="line">			border:4px solid red;</div><div class="line">			overflow:auto;</div><div class="line">		&#125;</div><div class="line">	&lt;/style&gt;</div><div class="line">&lt;/head&gt;</div><div class="line">&lt;body&gt;</div><div class="line">	&lt;div id=<span class="string">"container"</span>&gt;</div><div class="line">		&lt;div id=<span class="string">"content"</span>&gt;</div><div class="line">			&lt;div id=<span class="string">"text"</span>&gt;</div><div class="line">			测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试</div><div class="line">			&lt;/div&gt;</div><div class="line">		&lt;/div&gt;</div><div class="line">	&lt;/div&gt;</div><div class="line"></div><div class="line">	&lt;script&gt;</div><div class="line">		var text = document.querySelector(<span class="string">'#text'</span>);</div><div class="line">		console.log(text.offsetHeight);		//chrome下540</div><div class="line">		console.log(text.offsetWidth);		//chrome下159</div><div class="line"></div><div class="line">		var content = document.querySelector(<span class="string">'#content'</span>);</div><div class="line"></div><div class="line">		console.log(content.offsetHeight);	//chrome下224(100%=&gt;200px; 200+8+8+4+4)</div><div class="line">		console.log(content.offsetWidth);	//chrome下200(container中设置width为200,实际就是contentbox为200，这里自动占满了父级宽度，也是200)</div><div class="line"></div><div class="line">		console.log(content.clientHeight);	//chrome下216(200+8+8);</div><div class="line">		console.log(content.clientWidth);	//chrome下175(clientWidth和clientHeight不包括margin，border和滚动条宽度，包括padding宽度，这里如果没有滚动条就应该是200-4-4)</div><div class="line">		console.log(content.clientTop);		//chrome下4(content的border-top宽度)</div><div class="line">		console.log(content.clientLeft);	//chrome下4(content的border-left宽度)</div><div class="line"></div><div class="line">		console.log(content.scrollHeight);	//chrome下556(540+8+8),可见scrollHeight是内部元素的高度+padding的高度</div><div class="line">		console.log(content.scrollWidth);	//chrome下175(没有横向滚动条)</div><div class="line">		console.log(content.scrollTop);		//chrome下0-340</div><div class="line">	&lt;script&gt;</div><div class="line">&lt;/body&gt;</div><div class="line">&lt;/html&gt;</div></pre></td></tr></table></figure></p>
<p>有如下结论:</p>
<ol>
<li>注意content的scrollTop在变化，而text的scrollTop一直为0.    可想而知。content.clientHeight + content.scrollTop == content.scrollHeight到达底部(216 + 340 = 556);<br>可以发现这也是为什么scrollHeight和clientHeight都包含padding高度的原因，因为这样才能相互抵消。计算正确。</li>
<li>引用stackoverflow的一段话<br> clientHeight:<br> Returns the height of the visible area for an object, in pixels. The value contains the height with the padding, but it does not include the scrollBar, border, and the margin.<br> offsetHeight:<br> Returns the height of the visible area for an object, in pixels. The value contains the height with the padding, scrollBar, and the border, but does not include the margin.<br> So, offsetHeight includes scrollbar and border, clientHeight doesn’t.<br>大意就是：<span style="color:red;">offsetHeight包括scrollbar和border的高度，clientHeight则不包括两者； 它们都不包括margin的高度；</span></li>
</ol>
<p>结论大致与上面的两个图一致，浏览器兼容性未测试，后续遇到实际问题总结</p>
<p>效果图如下：<br><img src="http://i13.tietuku.com/396ca7456fe1fa83.png"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/02/15/20160215/" data-id="ciyvlrhm8000kocvru36wwk96" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/clientHeight/">clientHeight</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/clientLeft/">clientLeft</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/clientTop/">clientTop</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/offsetHeight/">offsetHeight</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/offsetLeft/">offsetLeft</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/offsetTop/">offsetTop</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/scrollHeight/">scrollHeight</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/scrollLeft/">scrollLeft</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/scrollTop/">scrollTop</a></li></ul>

    </footer>
  </div>
  
</article>




  
    <article id="post-20160214" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/02/14/20160214/" class="article-date">
  <time datetime="2016-02-13T16:00:00.000Z" itemprop="datePublished">2016-02-14</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/js/">js</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/02/14/20160214/">瀑布流布局插件的实现</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>最近看taobaoued的一篇博客关于<a href="http://ued.taobao.org/blog/2011/09/waterfall/" target="_blank" rel="external">瀑布流布局</a>,之前也看过<a href="http://www.l99.com/media_index.action" target="_blank" rel="external">同学公司的网站</a>用的这种布局，很新颖但不知道是什么名字，为提升实践能力，我就打算写一个瀑布流插件，弄了一天，现在放在<a href="https://github.com/uniquezhuo/WaterFallPlugin" target="_blank" rel="external">github waterfallplugin</a>上了。<br> Pinterest最早开始使用这种布局，后来国内的蘑菇街之类的网站开始跟风。这种布局明显适合那种大量图片显示的网站</p>
<h1 id="实现方式"><a href="#实现方式" class="headerlink" title="实现方式"></a>实现方式</h1><h2 id="一-多列浮动"><a href="#一-多列浮动" class="headerlink" title="一.多列浮动"></a>一.多列浮动</h2><p> 使用这种方式的网站有：<br> 蘑菇街，我同事的公司网站</p>
<p> 这种方式最容易想到，让几个div float在一个container中，每次加载出新内容时按计算结果向不同div中添加新的模块<br> <img src="http://img02.taobaocdn.com/tps/i2/T1zXGoXdVpXXXXXXXX-600-452.png"></p>
<p>优点：</p>
<ol>
<li>简单易实现</li>
<li>不用明确知道数据块高度，当数据块中有图片时，就不需要指定图片高度。（这一点很重要）<br>缺点：</li>
<li>列数固定，当浏览器窗口变化时，只能固定n列，出现滚动条</li>
</ol>
<h2 id="二-css3多栏布局"><a href="#二-css3多栏布局" class="headerlink" title="二.css3多栏布局"></a>二.css3多栏布局</h2><p>可查询column-count了解不多叙述。</p>
<p>优点:</p>
<ol>
<li>简单不用写代码<br>缺点：</li>
<li>css3兼容性问题</li>
</ol>
<h2 id="三-绝对定位"><a href="#三-绝对定位" class="headerlink" title="三.绝对定位"></a>三.绝对定位</h2><p>这种方式很高端，有难度，我写的插件也是采用的这种方式。使用这种方式的有：Pinterest， KISSY<br>使用我的WaterFall需要一句初始化代码即可<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">new WaterFall(&#123;</div><div class="line">          container: <span class="string">"#main-container"</span>,   //父容器</div><div class="line">          minColumn: 2,    //resize window时保留的最小列数</div><div class="line">          colWidth: 208,   //每列宽度，当前列数就去 max(container.width/(colWidth+colGap), minColumn)</div><div class="line">          colGap: 10,     //单元格列间距</div><div class="line">          rowGap: 10,     //单元格行坚决</div><div class="line">          load: <span class="keyword">function</span>(successCallBack)&#123;    //每次加载固定数据的函数，success为调整位置的函数</div><div class="line">              $.ajax(&#123;</div><div class="line">                  url: <span class="string">'items.json'</span>,</div><div class="line">                  data: &#123;&#125;,</div><div class="line">                  <span class="built_in">type</span>: <span class="string">'get'</span>,</div><div class="line">                  dataType: <span class="string">'json'</span>,</div><div class="line">                  success: <span class="keyword">function</span>(result)&#123;</div><div class="line">                      <span class="keyword">if</span>(result.code == 0)</div><div class="line">                          successCallBack(result.data, <span class="string">'#watertmpl'</span>);</div><div class="line">                  &#125;</div><div class="line">              &#125;);</div><div class="line">          &#125;</div><div class="line">      &#125;)</div></pre></td></tr></table></figure></p>
<p>从这里也大概可以看出代码的核心：</p>
<h3 id="1-获取列数-用container宽度除以设置的（列宽-列间隙）与设置的最小列数进行比较取最大；-这样保证了可以在window-resize时自动变化列数，同时避免过窄保证有基本的列数"><a href="#1-获取列数-用container宽度除以设置的（列宽-列间隙）与设置的最小列数进行比较取最大；-这样保证了可以在window-resize时自动变化列数，同时避免过窄保证有基本的列数" class="headerlink" title="1. 获取列数,用container宽度除以设置的（列宽+列间隙）与设置的最小列数进行比较取最大； 这样保证了可以在window resize时自动变化列数，同时避免过窄保证有基本的列数"></a>1. 获取列数,用container宽度除以设置的（列宽+列间隙）与设置的最小列数进行比较取最大； 这样保证了可以在window resize时自动变化列数，同时避免过窄保证有基本的列数</h3><h3 id="2-保存每一列的高度，记录最高高度列和最低高度列；在最低高度列中插入新的元素（设置position：absolute-left：index-colWidth-colGap-top-colsHeight-index-）-然后更新整个高度数组，并将容器高度设置为最高高度列的高度；"><a href="#2-保存每一列的高度，记录最高高度列和最低高度列；在最低高度列中插入新的元素（设置position：absolute-left：index-colWidth-colGap-top-colsHeight-index-）-然后更新整个高度数组，并将容器高度设置为最高高度列的高度；" class="headerlink" title="2. 保存每一列的高度，记录最高高度列和最低高度列；在最低高度列中插入新的元素（设置position：absolute; left：index*(colWidth+colGap); top: colsHeight[index]）; 然后更新整个高度数组，并将容器高度设置为最高高度列的高度；"></a>2. 保存每一列的高度，记录最高高度列和最低高度列；在最低高度列中插入新的元素（设置position：absolute; left：index*(colWidth+colGap); top: colsHeight[index]）; 然后更新整个高度数组，并将容器高度设置为最高高度列的高度；</h3><p>有以下几点值得思考:</p>
<h4 id="1-插入元素没有使用拼接字符串，而是采用doT模板引擎；这样是为了可扩展性，因为不知道在每个item内部dom结构，这个需要用户自己来填写；-限定定了容器id-”main-container”，单个item-class-”waterfall-item”"><a href="#1-插入元素没有使用拼接字符串，而是采用doT模板引擎；这样是为了可扩展性，因为不知道在每个item内部dom结构，这个需要用户自己来填写；-限定定了容器id-”main-container”，单个item-class-”waterfall-item”" class="headerlink" title="(1). 插入元素没有使用拼接字符串，而是采用doT模板引擎；这样是为了可扩展性，因为不知道在每个item内部dom结构，这个需要用户自己来填写；    限定定了容器id=”main-container”，单个item class=”waterfall-item”"></a>(1). 插入元素没有使用拼接字符串，而是采用doT模板引擎；这样是为了可扩展性，因为不知道在每个item内部dom结构，这个需要用户自己来填写；    限定定了容器id=”main-container”，单个item class=”waterfall-item”</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&lt;script id=<span class="string">"watertmpl"</span> <span class="built_in">type</span>=<span class="string">"text/x-dot-template"</span>&gt;</div><div class="line">       &lt;div class=<span class="string">"waterfall-item"</span>&gt;</div><div class="line">           &lt;img src=<span class="string">"&#123;&#123;= it.imgUrl&#125;&#125;"</span>/&gt;</div><div class="line">           &lt;p&gt;&#123;&#123;= it.briefIntro&#125;&#125;&lt;/p&gt;</div><div class="line">       &lt;/div&gt;</div><div class="line">   &lt;/script&gt;</div><div class="line">   &lt;div id=<span class="string">"main-container"</span>&gt;</div><div class="line">   &lt;/div&gt;</div></pre></td></tr></table></figure>
<h4 id="2-使用模板引擎之后在元素填充到dom之前，需要修改其style定义left和top值将元素插入到相应的列。因为采用了分批加载，每次获得的都是一组数组，所以要对数组数据进行分批处理。"><a href="#2-使用模板引擎之后在元素填充到dom之前，需要修改其style定义left和top值将元素插入到相应的列。因为采用了分批加载，每次获得的都是一组数组，所以要对数组数据进行分批处理。" class="headerlink" title="(2). 使用模板引擎之后在元素填充到dom之前，需要修改其style定义left和top值将元素插入到相应的列。因为采用了分批加载，每次获得的都是一组数组，所以要对数组数据进行分批处理。"></a>(2). 使用模板引擎之后在元素填充到dom之前，需要修改其style定义left和top值将元素插入到相应的列。因为采用了分批加载，每次获得的都是一组数组，所以要对数组数据进行分批处理。</h4><p>这里就出现了一个问题：<br><b style="color:red;">只有在每个元素插入到dom中之后才能获取它实际的高度，进而更新每个列的高度，进而进行下一个元素的插入计算，但如果item中含有图片，则在图片没有加载完之前获取的offsetHeight是不准确的，怎么办???</b><br>解决方法有两个：<br>    一.服务器端返回item中图片的高度。<br>    二.服务器端不支持，客户端在加载一张图片结束之后进行下一个元素的插入。<br>实际效果可想而知，明显第一个方法体验更好，性能更好。<br>但是我的插件这里采用的第二种方法，为了更加独立的完成这个效果：<br>代码如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">var loadingTag = (<span class="function"><span class="title">function</span></span>()&#123;              //串行渲染标识</div><div class="line">       var isLoading = <span class="literal">false</span>;</div><div class="line">       <span class="built_in">return</span>  <span class="keyword">function</span>(il)&#123;</div><div class="line">           <span class="keyword">if</span>(il != undefined)&#123;</div><div class="line">               isLoading = il;</div><div class="line">           &#125;</div><div class="line">           <span class="built_in">return</span> isLoading;</div><div class="line">       &#125;;</div><div class="line">   &#125;)();</div><div class="line"></div><div class="line">/**</div><div class="line">    * 每次加载一页数据之后，添加到dom中的函数。</div><div class="line">    * 此方法不能并行被调用，即一组数据还没有彻底填充完，另一组数据不能开始填充。这也是由图片高度未知导致的</div><div class="line">    * @param arr</div><div class="line">    * @param tmplId</div><div class="line">    */</div><div class="line">   <span class="keyword">function</span> addItems(arr, tmplSelector)&#123;</div><div class="line">       <span class="keyword">if</span>(!isArray(arr))</div><div class="line">           <span class="built_in">return</span>;</div><div class="line">       var waterTmpl = <span class="keyword">do</span>T.template(document.querySelector(tmplSelector).innerText);</div><div class="line">       addBundleItems(arr, 0, waterTmpl);</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="keyword">function</span> addBundleItems(arr, i, waterTmpl)&#123;</div><div class="line">       <span class="keyword">if</span>(i &gt;= arr.length)&#123;</div><div class="line">           loadingTag(<span class="literal">false</span>);</div><div class="line">           <span class="built_in">return</span>;</div><div class="line">       &#125;</div><div class="line">       var newItemText = waterTmpl(arr[i]);</div><div class="line">       var posItemText = calculatePosition(newItemText);</div><div class="line">       container.innerHTML += posItemText;</div><div class="line">       var imgs = document.querySelectorAll(<span class="string">'.waterfall-item img'</span>);</div><div class="line">       imgs[imgs.length-1].onload = <span class="function"><span class="title">function</span></span>()&#123;</div><div class="line">           updateHeight(this.offsetHeight + 30);    //在服务器没有返回图片高度的情况下。之后自己计算高度，等到图片加载完成之后才能确切高度；进行下一个item插入</div><div class="line">           i++;</div><div class="line">           addBundleItems(arr, i, waterTmpl);</div><div class="line">       &#125;</div><div class="line">   &#125;;</div></pre></td></tr></table></figure>
<p>由于存在onload事件，所以一定会用到递归调用。另外这个方法是不能并行被调用的，即必须在一批数组全部填充到dom中之后才能开始填充下一批数据。这也是由于图片加载完成之前高度未知决定的。所以这里使用了一个标记位。isLoading放到闭包中，避免被误修改。</p>
<h4 id="3-calculatePosition函数用于向doT渲染出来的html字符串中插入left和top属性值。之后将修改的字符串返回填充到dom中"><a href="#3-calculatePosition函数用于向doT渲染出来的html字符串中插入left和top属性值。之后将修改的字符串返回填充到dom中" class="headerlink" title="(3). calculatePosition函数用于向doT渲染出来的html字符串中插入left和top属性值。之后将修改的字符串返回填充到dom中"></a>(3). calculatePosition函数用于向doT渲染出来的html字符串中插入left和top属性值。之后将修改的字符串返回填充到dom中</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line">    *将html字符串中加入left和top值</div><div class="line">    * @param newItemText</div><div class="line">    */</div><div class="line">   <span class="keyword">function</span> calculatePosition(newItemText)&#123;</div><div class="line">       var leftStyle = /[^&lt;]*(style\s*=\s*<span class="string">").*waterfall-item[^&gt;]*/ig;</span></div><div class="line">       var rightStyle = /[^&lt;]*waterfall-item.*(style\s*=\s*")[^&gt;]*/ig;</div><div class="line">       var leftResult = leftStyle.exec(newItemText);           //匹配结果：[<span class="string">" div class="</span>waterfall-item<span class="string">" style  =  "</span><span class="string">" "</span>, <span class="string">"style  =  "</span><span class="string">"]</span></div><div class="line">       var rightResult = rightStyle.exec(newItemText);         //匹配结果：[" div class=<span class="string">"waterfall-item"</span> style  =  <span class="string">""</span> <span class="string">", "</span>style  =  <span class="string">""</span>]</div><div class="line">       var leftPos = minIndex * (configs.colWidth + configs.colGap);</div><div class="line">       var topPos = colsHeight[minIndex] + configs.rowGap;</div><div class="line"></div><div class="line">       <span class="keyword">if</span>(!!leftResult &amp;&amp; leftResult.length != 0)&#123;             //style在class左侧</div><div class="line"></div><div class="line">           newItemText = newItemText.replace(leftResult[1].toString(), leftResult[1].toString() + <span class="string">"left:"</span> + leftPos + <span class="string">"px; top:"</span> + topPos + <span class="string">"px; width:"</span> + configs.colWidth + <span class="string">"px;"</span>);</div><div class="line"></div><div class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span>(!!rightResult &amp;&amp; rightResult.length != 0)&#123;    //style在class右侧</div><div class="line"></div><div class="line">           newItemText = newItemText.replace(rightResult[1].toString(), rightResult[1].toString() + <span class="string">"left:"</span> + leftPos + <span class="string">"px; top:"</span> + topPos + <span class="string">"px; width:"</span> + configs.colWidth + <span class="string">"px;"</span>);</div><div class="line"></div><div class="line">       &#125; <span class="keyword">else</span> &#123;                                                //没有style</div><div class="line"></div><div class="line">           var temp = newItemText.match(/[^&lt;]*waterfall-item[^&gt;]*/i)[0];</div><div class="line">           newItemText = newItemText.replace(temp.toString(), temp.toString() + <span class="string">'style = "top:'</span> + topPos + <span class="string">'px; left:'</span> + leftPos + <span class="string">'px; width:'</span> + configs.colWidth + <span class="string">'px;"'</span>);</div><div class="line"></div><div class="line">       &#125;</div><div class="line">       <span class="built_in">return</span> newItemText;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>分为</p>
<ol>
<li>class=”waterfall-item” style=””</li>
<li>style=”” class=”waterfall-item”</li>
<li>class=”waterfall-item”<br>三种情况进行正则匹配，之后修改style属性值添加left和top属性</li>
</ol>
<h4 id="4-updateHeight方法用于在填充dom之后，同步每一列的高度数据。提供给下一次的calculatePosition方法执行调用"><a href="#4-updateHeight方法用于在填充dom之后，同步每一列的高度数据。提供给下一次的calculatePosition方法执行调用" class="headerlink" title="(4). updateHeight方法用于在填充dom之后，同步每一列的高度数据。提供给下一次的calculatePosition方法执行调用"></a>(4). updateHeight方法用于在填充dom之后，同步每一列的高度数据。提供给下一次的calculatePosition方法执行调用</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line">    * 更新列高度数组，和最小高度列的下标</div><div class="line">    * @param newItemHeight</div><div class="line">    */</div><div class="line">   <span class="keyword">function</span> updateHeight(newItemHeight)&#123;</div><div class="line">       newItemHeight = newItemHeight || 0;</div><div class="line">       colsHeight[minIndex] += newItemHeight;</div><div class="line">       <span class="keyword">for</span>(var i <span class="keyword">in</span> colsHeight)&#123;</div><div class="line">           colsHeight = colsHeight;   //没有初始化的进行初始化</div><div class="line">           <span class="keyword">if</span>(colsHeight[i] &lt; colsHeight[minIndex])&#123;</div><div class="line">               minIndex = i;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">if</span>(colsHeight[i] &gt; colsHeight[maxIndex])&#123;</div><div class="line">               maxIndex = i;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       container.style.height = colsHeight[maxIndex] + <span class="string">"px"</span>;      //更改容器高度为所有列中最大</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<h3 id="3-设置window-onresize-动态改变列数"><a href="#3-设置window-onresize-动态改变列数" class="headerlink" title="3. 设置window.onresize,动态改变列数"></a>3. 设置window.onresize,动态改变列数</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line">    * 窗口变化时，动态改变已有元素排列，只对已有元素</div><div class="line">    */</div><div class="line">   <span class="keyword">function</span> <span class="function"><span class="title">reflow</span></span>()&#123;</div><div class="line">       colNum = Math.max(parseInt(container.offsetWidth/(configs.colWidth+configs.colGap)), configs.minColumn);    //列数</div><div class="line">       colsHeight.length = 0;</div><div class="line">       minIndex = 0;</div><div class="line">       maxIndex = 0;</div><div class="line">       //初始化高度数组都为0</div><div class="line">       <span class="keyword">for</span>(var i=0; i&lt;colNum; i++)&#123;</div><div class="line">           colsHeight[i] = 0;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       var items = document.querySelectorAll(<span class="string">'.waterfall-item'</span>);</div><div class="line">       Array.prototype.forEach.call(items, <span class="keyword">function</span>(item, i)&#123;</div><div class="line">           var leftPos = minIndex * (configs.colWidth + configs.colGap);</div><div class="line">           var topPos = colsHeight[minIndex] + configs.rowGap;</div><div class="line"></div><div class="line">           item.style.left = leftPos + <span class="string">"px"</span>;</div><div class="line">           item.style.top = topPos + <span class="string">"px"</span>;</div><div class="line">           updateHeight(item.offsetHeight);</div><div class="line">       &#125;);</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   var timer;</div><div class="line">   window.onresize = <span class="function"><span class="title">function</span></span>()&#123;</div><div class="line">       clearTimeout(timer);</div><div class="line">       timer = <span class="built_in">set</span>Timeout(<span class="function"><span class="title">function</span></span>()&#123;</div><div class="line">           reflow();</div><div class="line">       &#125;, 300);</div><div class="line">   &#125;;</div></pre></td></tr></table></figure>
<p>resize时使用setTimeout优化性能；对已有元素重排</p>
<h3 id="4-设置window-onscroll来控制下一页加载时机"><a href="#4-设置window-onscroll来控制下一页加载时机" class="headerlink" title="4. 设置window.onscroll来控制下一页加载时机"></a>4. 设置window.onscroll来控制下一页加载时机</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line">    * 滚动条是html.clientHeight &lt; html.offsetHeight   所以是由于html过长导致的滚动条出现</div><div class="line">    * @param e</div><div class="line">    */</div><div class="line">   window.onscroll = <span class="keyword">function</span>(e)&#123;</div><div class="line">       var t = document.documentElement.scrollTop || document.body.scrollTop;</div><div class="line">       <span class="keyword">if</span>(!loadingTag() &amp;&amp; t + document.documentElement.clientHeight &gt; container.offsetHeight - configs.loadDistance)&#123;</div><div class="line">           loadingTag(<span class="literal">true</span>);</div><div class="line">           configs.load(addItems);</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>普通html页面由于过长产生的滚动条是由于html元素太长在window中显示出的滚动条； </p>
<h3 id="5-设置首屏加载。注意临界条件的判断"><a href="#5-设置首屏加载。注意临界条件的判断" class="headerlink" title="5. 设置首屏加载。注意临界条件的判断"></a>5. 设置首屏加载。注意临界条件的判断</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line">   * 加载第一屏</div><div class="line">   */</div><div class="line">  var firstPageInterval;</div><div class="line">  firstPageInterval = <span class="built_in">set</span>Interval(<span class="function"><span class="title">function</span></span>()&#123;</div><div class="line">      <span class="keyword">if</span>(!loadingTag() &amp;&amp; container.offsetHeight &lt; document.documentElement.clientHeight) &#123;</div><div class="line">          loadingTag(<span class="literal">true</span>);</div><div class="line">          configs.load(addItems);</div><div class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span>(container.offsetHeight &gt; document.documentElement.clientHeight)&#123;</div><div class="line">          clearInterval(firstPageInterval);</div><div class="line">      &#125;</div><div class="line">  &#125;, 200);</div></pre></td></tr></table></figure>
<p>以下是最终效果<br><img src="http://i11.tietuku.com/819e18f3fbe4ec08.png"><br><img src="http://i11.tietuku.com/4bd7ecf0cb342c7c.png"><br><img src="http://i11.tietuku.com/d2f0e2752f098c43.png"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/02/14/20160214/" data-id="ciyvlrhm1000focvruf8qteaj" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/瀑布流/">瀑布流</a></li></ul>

    </footer>
  </div>
  
</article>




  
    <article id="post-20160126" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/01/26/20160126/" class="article-date">
  <time datetime="2016-01-25T16:00:00.000Z" itemprop="datePublished">2016-01-26</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/js/">js</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/01/26/20160126/">angular1回顾</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>angular1自2009年出来之后一直很火，但也有不少弊端：比如十分影响性能的dirty check;所以google对angular2的设计可谓是完全颠覆，和vue.js，react.js类似，都跟上了组件化开发的新趋势，angular1确实是处于一种完全尴尬的境地； 这里就只当“温故”吧</p>
<h3 id="directive"><a href="#directive" class="headerlink" title="directive"></a>directive</h3><p>angular1被人吐槽的一点就是太多新的概念，学习曲线太陡。要说其中最常用也比较难以运用的就是directive了，directive实际上就是一种组件化的思想，一个指令封装dom操作和相应逻辑，达到封装一次，到处使用的目的<br>这个很实用，比如之前做的一个ionic的app。有多个列表页，当时为了赶时间就没有进行指令化，连续写了四个很类似的页面，修改起来也很麻烦。<br>以下贴一个例子：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">angular.module(<span class="string">'docsTransclusionExample'</span>, [])</div><div class="line">	.controller(<span class="string">'Controller'</span>, [<span class="string">'$scope'</span>, <span class="keyword">function</span>(<span class="variable">$scope</span>) &#123;</div><div class="line">	  <span class="variable">$scope</span>.name = <span class="string">'Tobias'</span>;</div><div class="line">	  <span class="variable">$scope</span>.list = [];</div><div class="line">	&#125;])</div><div class="line">	.directive(<span class="string">'myDialog'</span>, <span class="function"><span class="title">function</span></span>() &#123;</div><div class="line">	  <span class="built_in">return</span> &#123;</div><div class="line">	    restrict: <span class="string">'E'</span>,</div><div class="line">	    transclude: <span class="literal">true</span>,</div><div class="line">	    scope: &#123;</div><div class="line">	    	list: <span class="string">'=li'</span>，</div><div class="line">	    	id: <span class="string">'@'</span>,</div><div class="line">	    	onSend: <span class="string">'&amp;'</span></div><div class="line">	    &#125;,</div><div class="line">	    templateUrl: <span class="string">'my-dialog.html'</span>,</div><div class="line">	    link: <span class="keyword">function</span> (scope, element) &#123;</div><div class="line">	      scope.name = <span class="string">'Jeff'</span>;</div><div class="line">	    &#125;,</div><div class="line">	    controller: <span class="string">'SomeController'</span>,</div><div class="line">	    controller: <span class="keyword">function</span>(<span class="variable">$scope</span>, <span class="variable">$element</span>, <span class="variable">$attr</span> <span class="variable">$transclude</span>)&#123;</div><div class="line"></div><div class="line">		&#125;</div><div class="line">	  &#125;;</div><div class="line">	&#125;);</div><div class="line"></div><div class="line"></div><div class="line">//my-dialog.html</div><div class="line">&lt;div class=<span class="string">"alert"</span> ng-transclude&gt;</div><div class="line">&lt;/div&gt;</div><div class="line"></div><div class="line">//index.html</div><div class="line">&lt;div ng-controller=<span class="string">"Controller"</span>&gt;</div><div class="line">  &lt;my-dialog li=<span class="string">"list"</span> on-send=<span class="string">"sendMail()"</span> from-name=<span class="string">""</span>&gt;Check out the contents, &#123;&#123;name&#125;&#125;!&lt;/my-dialog&gt;</div><div class="line">&lt;/div&gt;</div></pre></td></tr></table></figure></p>
<p>其中scope就是指令内的作用域，一旦定义scope属性，就隔离了外部作用域。如果不定义这个，那么指令作用域就会自动继承父级作用域，这里就是controller的作用域scope<br>scope中可以用来接收外部传参,’=’是双向绑定，@是单向绑定，&amp;是绑定方法</p>
<p>transclude的使用也是一个重点。比如上述代码，那么最终会被解析为‘Tobias’，因为transclude：true，和ng-transclude的配合使用使得指令作用域中包含的html拥有了指令外部的作用域（也就是controller作用域）而不是指令内部的作用域。<br>The transclude option changes the way scopes are nested. It makes it so that the contents of a transcluded directive have whatever scope is outside the directive, rather than whatever scope is on the inside.<br>这一点还是改变不了的。其实这是有必要的，因为内部元素要独立出来，证明是想获得外部作用域的，否则完全可以直接放在template模板中</p>
<p>controller属性可以是一个字符串或者一个函数，如果值为字符串，会以字符串的值为名字来查找注册在应用中的控制器的构造函数，<br>如果为匿名函数则与link函数类似，但link只能在当前指令中定义行为，无法在指令间复用，而<a href="http://docs.angularjs.cn/guide/directive" target="_blank" rel="external">controller却可以复用</a></p>
<h3 id="config和run"><a href="#config和run" class="headerlink" title="config和run"></a>config和run</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">angular.module(<span class="string">'myApp'</span>, [])</div><div class="line">	.config(<span class="keyword">function</span>(<span class="variable">$routeProvider</span>)&#123;</div><div class="line"></div><div class="line">	&#125;)</div><div class="line">	.run(<span class="function"><span class="title">function</span></span>()&#123;</div><div class="line"></div><div class="line">	&#125;);</div></pre></td></tr></table></figure>
<p>config方法是唯一能在应用启动之前修改的部分，config只支持部分的类型注入：provider和constant。这证明只有通过provider自定义的service和.constant声明的常量才能够被注入<br>run方法则是在注入器创建之后被执行。它是angularjs应用中第一个被运行的方法，运行块常用于注册全局的时间监听器</p>
<h3 id="services"><a href="#services" class="headerlink" title="services"></a>services</h3><p>服务也是angular的重要组成部分，与controller每次被销毁和新建不同，service是单例的，且是懒加载。并且一旦被创建不会被销毁，知道应用结束。<br>除常用的factory创建服务之外，还有：<br>service()<br>constant()<br>value()<br>provider()<br>几种创建服务的方法<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">angular.module(<span class="string">'myApp'</span>)</div><div class="line">	.factory(<span class="string">'indexService'</span>, <span class="keyword">function</span>(<span class="variable">$http</span>)&#123;</div><div class="line">		<span class="built_in">return</span> &#123;</div><div class="line">			getName: <span class="function"><span class="title">function</span></span>()&#123;</div><div class="line"></div><div class="line">			&#125;</div><div class="line">		&#125;;</div><div class="line">	&#125;)</div><div class="line"></div><div class="line">	//service可以注册一个支持构造函数的服务</div><div class="line">	.service(<span class="string">'serviceService'</span>, <span class="keyword">function</span>(<span class="variable">$http</span>)&#123;</div><div class="line">		this.getName = <span class="function"><span class="title">function</span></span>()&#123;</div><div class="line"></div><div class="line">		&#125;</div><div class="line">	&#125;)</div><div class="line"></div><div class="line">	//provider注册服务必须提供一个<span class="variable">$get</span>方法</div><div class="line">	.provider(<span class="string">'providerService'</span>, &#123;</div><div class="line">		<span class="variable">$get</span>: <span class="function"><span class="title">function</span></span>()&#123;</div><div class="line">			<span class="built_in">return</span> &#123;</div><div class="line">				<span class="string">'username'</span>: <span class="string">'auser'</span></div><div class="line">			&#125;;</div><div class="line">		&#125;</div><div class="line">	&#125;);</div></pre></td></tr></table></figure></p>
<p>factory实际是provider方法注册服务的简写方式。<br>但有一点区别，provider生成的服务可以被注入到config方法中，但是factory则不行</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/01/26/20160126/" data-id="ciyvlrhm4000hocvrguwgvjzc" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/angular/">angular</a></li></ul>

    </footer>
  </div>
  
</article>




  
    <article id="post-20160118" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/01/18/20160118/" class="article-date">
  <time datetime="2016-01-17T16:00:00.000Z" itemprop="datePublished">2016-01-18</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/css/">css</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/01/18/20160118/">css3复杂连续动画控制</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>早一两个月前看到了这个页面<a href="http://h5.m.koudai.com/hd/2015_03_niuren_index/redirectLocalJsp.do?hd_p=platH5&amp;from=timeline&amp;isappinstalled=0" target="_blank" rel="external">某公司招人页面</a>，觉得挺炫，一直想临摹一遍，自己又懒，这周六把它实现了一遍，代码已经上传到我的github上<a href="https://github.com/uniquezhuo/Css3AnimationExample" target="_blank" rel="external">Css3AnimationExample</a>，算是个小战果吧</p>
<h3 id="需求分析"><a href="#需求分析" class="headerlink" title="需求分析"></a>需求分析</h3><p><img src="http://i8.tietuku.com/f07d3832fc5742bb.png"><br><img src="http://i8.tietuku.com/43e507fa2bb6e862.png"><br><img src="http://i8.tietuku.com/631a4344b8eeb159.png"><br><img src="http://i8.tietuku.com/00cafa844a127eb0.png"></p>
<p>静态图，效果看不大出。但基本也就是手势swipe up； swipe down切换页面。但仔细观察会发现:</p>
<ol>
<li>每个页面都可归纳出四种动画：swipe up隐藏，swipe up显示，swipe down隐藏，swipe down显示；</li>
<li>四种动画中页面中元素的动画顺序不固定，速度不固定，动画甚至也不是简单的两种状态（添加和删除同一个class）</li>
</ol>
<h3 id="尝试"><a href="#尝试" class="headerlink" title="尝试"></a>尝试</h3><p>我进行了第一个尝试：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">&lt;div class=<span class="string">"page page1 active"</span>  style=<span class="string">"z-index:5;"</span>&gt;</div><div class="line">       &lt;div class=<span class="string">"circle-icon"</span> data-sort=<span class="string">"1"</span> has-next=<span class="string">"true"</span>&gt;</div><div class="line">           &lt;div class=<span class="string">"circle"</span>  data-sort=<span class="string">"2"</span>&gt;&lt;/div&gt;</div><div class="line">           &lt;div class=<span class="string">"icon"</span>  data-sort=<span class="string">"3"</span> &gt;&lt;/div&gt;</div><div class="line">       &lt;/div&gt;</div><div class="line">       &lt;div class=<span class="string">"slogan"</span> data-sort=<span class="string">"4"</span>&gt;</div><div class="line">       &lt;/div&gt;</div><div class="line">       &lt;div class=<span class="string">"car-run"</span> data-sort=<span class="string">"5"</span>&gt;</div><div class="line">           &lt;div class=<span class="string">"car-suite"</span>&gt;</div><div class="line">               &lt;div class=<span class="string">"cdj"</span> data-sort=<span class="string">"6"</span>&gt;&lt;/div&gt;</div><div class="line">               &lt;div class=<span class="string">"bmw"</span> data-sort=<span class="string">"7"</span>&gt;&lt;/div&gt;</div><div class="line">               &lt;div class=<span class="string">"bm320"</span> data-sort=<span class="string">"8"</span>&gt;&lt;/div&gt;</div><div class="line">               &lt;div class=<span class="string">"car"</span>&gt;&lt;/div&gt;</div><div class="line">               &lt;div class=<span class="string">"wheel1"</span>&gt;&lt;/div&gt;</div><div class="line">               &lt;div class=<span class="string">"wheel2"</span>&gt;&lt;/div&gt;</div><div class="line">           &lt;/div&gt;</div><div class="line">           &lt;div class=<span class="string">"ground"</span>&gt;&lt;/div&gt;</div><div class="line">       &lt;/div&gt;</div><div class="line">   &lt;/div&gt;</div></pre></td></tr></table></figure></p>
<p>在html元素中自定义属性标示出四种动画的元素顺序，之后依次为这些元素加上on或者next( on为动画一级状态，next为动画二级状态，用多个类逐渐添加来解决动画有多个类的问题)<br>但是对于有的元素在第三步时是addClass(‘next’); 有的则是removeClass(‘on’);这个问题怎么办？只有再继续添加标志性的自定义元素has-next了<br>好，怎么控制不同的启动速度，当然也可以继续添加自定义属性，比如什么data-next-time<br>上面问题都解决了，但是很不优雅，也不一目了然。</p>
<hr>
<p>我们可以总结出两点：</p>
<ol>
<li>css3动画其实就是类的叠加</li>
<li>我们需要记录动画信息，并能通用的解析出来，提高扩展性</li>
</ol>
<p>既然html不行，就换成js吧</p>
<h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><p>先上代码<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div></pre></td><td class="code"><pre><div class="line">var pages = [</div><div class="line">       &#123;       //page1</div><div class="line">           <span class="string">'upIn'</span>: [<span class="string">'.logo|on|add'</span>, <span class="string">'.circle|on|add'</span>, [<span class="string">'.circle-icon|on|add'</span>,<span class="string">'.icon|on|add'</span>], <span class="string">'.slogan|on|add'</span>, <span class="string">'.car-run|on|add|200'</span>, <span class="string">'.cdj|on|add|200'</span>, <span class="string">'.bmw|on|add|200'</span>, <span class="string">'.bm320|on|add'</span>],</div><div class="line">           <span class="string">'upOut'</span>: [<span class="string">'.circle-icon|next|add'</span>, <span class="string">'.slogan|next|add|200'</span>, <span class="string">'.cdj|on|remove|200'</span>, <span class="string">'.bmw|on|remove|200'</span>, <span class="string">'.bm320|on|remove'</span>, <span class="string">'.car-run|next|add'</span>],</div><div class="line">           <span class="string">'downIn'</span>: [<span class="string">'.car-run|next|remove|100'</span>, <span class="string">'.bm320|on|add|100'</span>, <span class="string">'.bmw|on|add|100'</span>, <span class="string">'.cdj|on|add|100'</span>, <span class="string">'.slogan|next|remove'</span>, <span class="string">'.circle-icon|next|remove'</span>],</div><div class="line">           <span class="string">'downOut'</span>: []</div><div class="line">       &#125;,</div><div class="line">       &#123;       //page2</div><div class="line">           <span class="string">'upIn'</span>: [ <span class="string">'.niu-ren|on|add'</span>, <span class="string">'body|zoom-out|add'</span>, <span class="string">'.mail-icon|on|add'</span>, <span class="string">'.words|on|add'</span>, <span class="string">'.money|on|add'</span>, <span class="string">'body|zoom-out|add'</span> ],</div><div class="line">           <span class="string">'upOut'</span>: [<span class="string">'.niu-ren|next|add'</span>, <span class="string">'.mail-icon|next|add'</span>, <span class="string">'.words|next|add'</span>],</div><div class="line">           <span class="string">'downIn'</span>: [<span class="string">'.words|next|remove'</span>, <span class="string">'.mail-icon|next|remove'</span>, <span class="string">'.niu-ren|next|remove'</span>],</div><div class="line">           <span class="string">'downOut'</span>: [<span class="string">'.words|on|remove'</span>, <span class="string">'.mail-icon|on|remove'</span>, <span class="string">'.niu-ren|on|remove'</span>]</div><div class="line">       &#125;,</div><div class="line">       &#123;       //page3</div><div class="line">           <span class="string">'upIn'</span>: [<span class="string">'.p3-title|on|add'</span>, <span class="string">'.recommend|on|add|100'</span>, <span class="string">'.recommend-name|on|add|100'</span>, <span class="string">'.recommend-tel|on|add|100'</span>, <span class="string">'.recommend-mail|on|add|100'</span>, <span class="string">'.be-recommend|on|add|100'</span>, <span class="string">'.be-recommend-name|on|add|100'</span>, <span class="string">'.be-recommend-job|on|add|100'</span>, <span class="string">'.be-recommend-resume|on|add|100'</span>],</div><div class="line">           <span class="string">'upOut'</span>: [<span class="string">'.p3-title|next|add|200'</span>, <span class="string">'.recommend|next|add|200'</span>, [<span class="string">'.recommend-name|next|add|200'</span>, <span class="string">'.recommend-tel|next|add|200'</span>, <span class="string">'.recommend-mail|next|add|200'</span>], <span class="string">'.be-recommend|next|add|200'</span>, [<span class="string">'.be-recommend-name|next|add|200'</span>, <span class="string">'.be-recommend-job|next|add|200'</span>, <span class="string">'.be-recommend-resume|next|add|200'</span>]],</div><div class="line">           <span class="string">'downIn'</span>: [<span class="string">'.be-recommend-resume|next|remove|200'</span>, <span class="string">'.be-recommend-job|next|remove|200'</span>, <span class="string">'.be-recommend-name|next|remove|200'</span>, <span class="string">'.be-recommend|next|remove|200'</span>, <span class="string">'.recommend-mail|next|remove|200'</span>, <span class="string">'.recommend-tel|next|remove|200'</span>, <span class="string">'.recommend-name|next|remove|200'</span>, <span class="string">'.recommend|next|remove|200'</span>, <span class="string">'.p3-title|next|remove|200'</span>],</div><div class="line">           <span class="string">'downOut'</span>: [<span class="string">'.be-recommend-resume|on|remove|200'</span>, <span class="string">'.be-recommend-job|on|remove|200'</span>, <span class="string">'.be-recommend-name|on|remove|200'</span>, <span class="string">'.be-recommend|on|remove|200'</span>, <span class="string">'.recommend-mail|on|remove|200'</span>, <span class="string">'.recommend-tel|on|remove|200'</span>, <span class="string">'.recommend-name|on|remove|200'</span>, <span class="string">'.recommend|on|remove|200'</span>, <span class="string">'.p3-title|on|remove|200'</span>]</div><div class="line">       &#125;,</div><div class="line">       &#123;       //page4</div><div class="line">           <span class="string">'upIn'</span>: [<span class="string">'.p4-title|on|add'</span>, <span class="string">'.java|on|add|100'</span>, <span class="string">'.android|on|add|100'</span>, <span class="string">'.ios|on|add|100'</span>, <span class="string">'.view-design|on|add|100'</span>, <span class="string">'.marketing|on|add|100'</span>, <span class="string">'.product|on|add|100'</span>, <span class="string">'.query-btn|on|add'</span>, <span class="string">'.email|on|add'</span>],</div><div class="line">           <span class="string">'upOut'</span>: [],</div><div class="line">           <span class="string">'downIn'</span>: [],</div><div class="line">           <span class="string">'downOut'</span>: [<span class="string">'.email|on|remove|100'</span>, <span class="string">'.query-btn|on|remove|100'</span>, <span class="string">'.product|on|remove|100'</span>, <span class="string">'.marketing|on|remove|100'</span>, <span class="string">'.view-design|on|remove|100'</span>, <span class="string">'.ios|on|remove|100'</span>, <span class="string">'.android|on|remove|100'</span>, <span class="string">'.java|on|remove|100'</span>, <span class="string">'.p4-title|on|remove'</span>]</div><div class="line">       &#125;</div><div class="line">   ];</div><div class="line"></div><div class="line">   /**</div><div class="line">    * css动画就是添加和删除class</div><div class="line">    * @param information</div><div class="line">    * @param container</div><div class="line">    */</div><div class="line">   <span class="keyword">function</span> handleClass(information, container)&#123;</div><div class="line">       var infos = information.split(<span class="string">'|'</span>);</div><div class="line">       //如果元素不在该page中,全documen查找</div><div class="line">       var target = container.find(infos[0]);</div><div class="line">       <span class="keyword">if</span>(target.length == 0)&#123;</div><div class="line">           infos[2] == <span class="string">'add'</span> ? $(infos[0]).addClass(infos[1]) : $(infos[0]).removeClass(infos[1]) ;</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           infos[2] == <span class="string">'add'</span> ? target.addClass(infos[1]) : target.removeClass(infos[1]) ;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   var prevTimer;</div><div class="line"></div><div class="line">   /**</div><div class="line">    * 显示动画</div><div class="line">    * @param container page容器</div><div class="line">    * @param aniArr 动画信息数组</div><div class="line">    * @param index 递归标记</div><div class="line">    */</div><div class="line">   <span class="keyword">function</span> showAnimation(container, aniArr, index, endCall)&#123;</div><div class="line">       clearTimeout(prevTimer);</div><div class="line">       <span class="keyword">if</span>(index &gt;= aniArr.length)&#123; //递归结束条件</div><div class="line">           endCall = endCall || <span class="function"><span class="title">function</span></span>()&#123;&#125;;</div><div class="line">           endCall();</div><div class="line">           <span class="built_in">return</span>;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       var information = aniArr[index];</div><div class="line">       var tmpl;   //标记自定义时间，数组中的默认第一个元素</div><div class="line">       <span class="keyword">if</span>( typeof information == <span class="string">'string'</span>)&#123;</div><div class="line">           handleClass(information, container);</div><div class="line">           tmpl = information.split(<span class="string">'|'</span>)[3];</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           //infos是数组</div><div class="line">           <span class="keyword">for</span>(var j= 0,jLen=information.length; j&lt;jLen; j++)&#123;</div><div class="line">               handleClass(information[j], container);</div><div class="line">           &#125;</div><div class="line">           tmpl = information.length &gt; 0 ? information[0].split(<span class="string">'|'</span>)[3] : undefined;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       prevTimer = <span class="built_in">set</span>Timeout(<span class="function"><span class="title">function</span></span>()&#123;</div><div class="line">           showAnimation(container, aniArr, ++index, endCall);</div><div class="line">       &#125;, !!tmpl&amp;&amp;tmpl.trim().length&gt;0 ? parseInt(tmpl) : 500);   //没有自定义时间</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   /**</div><div class="line">    * 初次载入动画</div><div class="line">    */</div><div class="line">   showAnimation($(<span class="string">'.page1'</span>), pages[0][<span class="string">'upIn'</span>], 0);</div></pre></td></tr></table></figure></p>
<p>看到数据结构自然就懂了，“选择器|类|操作（add或者remove）|自定义下个动画时间（可以不写默认500ms）”，对于有多个同时触发的，采用一个子数组出现。<br>这样剩下的就是解析字符串了，当时我还在想，字符串还好，如果是子数组，里面又有子数组怎么办？<br>这tm岂不是一个多维数组遍历问题，肯定要用递归，递归也行。关键这里是采用的setTimeout，一个异步回调+递归将是一个难以解决的蛋疼问题。<br>不对。。。。这tm不是多维的最多是二维，明显同一个时间里面就那几个，不能同一个时间里面还有第三维吧，好吧，这是物理问题。<br>这样问题就好办了，通过setTimeout动态改变间隔时间来调整速度，每次取消上次的计时器，再根据当前参数新建新的计时器，递归解决，就是这样。</p>
<p>这应该算是比较完美解决连续多个css3动画不同速度不同方向不同顺序播放的问题吧：css+js</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/01/18/20160118/" data-id="ciyvlrhlx000cocvr0dmd8mho" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/动画/">动画</a></li></ul>

    </footer>
  </div>
  
</article>




  
    <article id="post-20160107" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/01/07/20160107/" class="article-date">
  <time datetime="2016-01-06T16:00:00.000Z" itemprop="datePublished">2016-01-07</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/css/">css</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/01/07/20160107/">css3 3d动画</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>最近做项目越来越追求美了，难道做前端都会慢慢变得有艺术。反正看着静态页面连做下去的欲望都没有了</p>
<h2 id="css3两种动画"><a href="#css3两种动画" class="headerlink" title="css3两种动画"></a>css3两种动画</h2><h3 id="1-transition动画"><a href="#1-transition动画" class="headerlink" title="1.transition动画"></a>1.transition动画</h3><p>transition动画用起来简单顺手，感觉很轻量<br><figure class="highlight maxima"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">li</span>.radio&#123;</div><div class="line">    -webkit-<span class="built_in">transform</span>: perspective(300px) <span class="built_in">scale</span>(<span class="number">0.9</span>) rotateX(-20deg) translateZ(-40px);</div><div class="line">    <span class="built_in">opacity</span>: <span class="number">0</span>;</div><div class="line">   // -webkit-transition: all <span class="number">0.</span>5s <span class="built_in">linear</span> <span class="number">0s</span>;</div><div class="line">   	-webkit-transition: -webkit-<span class="built_in">transform</span> <span class="number">0.</span>5s <span class="built_in">linear</span> <span class="number">0s</span>, <span class="built_in">opacity</span> <span class="number">0.</span>5s <span class="built_in">linear</span> <span class="number">0s</span></div><div class="line">&#125;</div><div class="line"><span class="built_in">li</span>.radio.on&#123;</div><div class="line">    -webkit-<span class="built_in">transform</span>: perspective(<span class="number">0px</span>) <span class="built_in">scale</span>(<span class="number">1</span>) rotateX(<span class="number">0deg</span>) translateZ(<span class="number">0px</span>);</div><div class="line">    <span class="built_in">opacity</span>: <span class="number">1</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>transition动画在css属性变化时激发，一般常用就是绑定一个新的class名，通过js动态添加和去掉类名（.on）实现动画。书写方式就不解释了，重点关注下第三个参数时间函数，使用这个贝塞尔曲线函数cubic-bezier(n,n,n,n)变化很多，可以找个在线网站去动态创建自己想要的事件函数</p>
<h3 id="2-key-frames动画"><a href="#2-key-frames动画" class="headerlink" title="2.@key-frames动画"></a>2.@key-frames动画</h3><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="selector-class">.car-run</span> <span class="selector-class">.car-suite</span>&#123;</div><div class="line">    <span class="attribute">width</span>: <span class="number">100px</span>;</div><div class="line">    <span class="attribute">height</span>: <span class="number">150px</span>;</div><div class="line">    <span class="attribute">position</span>: absolute;</div><div class="line">    <span class="attribute">bottom</span>: <span class="number">6px</span>;</div><div class="line">    <span class="attribute">-webkit-animation</span>: car-shake <span class="number">0.5s</span> infinite;</div><div class="line"></div><div class="line">&#125;</div><div class="line">@-<span class="keyword">webkit</span>-<span class="keyword">keyframes</span> car-shake &#123;</div><div class="line">    0&#123;</div><div class="line">        <span class="attribute">-webkit-transform</span>: <span class="built_in">scale</span>(0.97,1.03);</div><div class="line">    &#125;</div><div class="line">    50%&#123;</div><div class="line">        <span class="attribute">-webkit-transform</span>: <span class="built_in">scale</span>(1,1);</div><div class="line">    &#125;</div><div class="line">    100%&#123;</div><div class="line">        <span class="attribute">-webkit-transform</span>: <span class="built_in">scale</span>(0.97,1.03);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>key-frames动画更加强大，激发条件也很简单。当该属性出现时就开始了动画，当然可是可以设置延迟的。它的属性更多，无疑可以进行更为精确的控制，比如，可以设置动画执行的次数，可以具体控制属性的变化</p>
<p>###总结<br>小动画，一次之后不会再次运行用transition；复杂细致控制，多次执行用animation</p>
<h2 id="css3-3d动画"><a href="#css3-3d动画" class="headerlink" title="css3 3d动画"></a>css3 3d动画</h2><p>要使得图像看起来立体，我们首先了解x,y,z轴<br>在css中，z轴是指向观察者的，可以想象面前一条横线是x轴，竖线为y轴；这样就很容易理解rotateX,rotateY,rotateZ和translateX,translateY,translateZ</p>
<p>还要了解perspective和perspective-origin属性，这是创造3d视图的关键。perspective调整元素距离视图的距离。<br>有两种设置方式：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="selector-class">.stage</span> &#123;	<span class="comment">//写在舞台元素（一般是父元素）</span></div><div class="line">    <span class="attribute">perspective</span>: <span class="number">600px</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="selector-id">#stage</span> <span class="selector-class">.box</span> &#123;	<span class="comment">//写在自己身上</span></div><div class="line">    <span class="attribute">transform</span>: perspective(<span class="number">600px</span>) rotateY(<span class="number">45deg</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>当动画元素（即box）只有一个时，效果是一样的。为什么我们没有perspective时没有3d效果，可以这样理解：现在眼睛或者说舞台父元素与动画元素距离为0，贴的太近看不出效果；当视线逐渐变远，就可以看到3d效果了。当变得很远，又会看不到效果了，而translateZ也就是可以改变元素这个方向上距离的属性。</p>
<p>当动画元素有多个时，效果就不一样了。第一个在父元素中设置perspective，相当于只有一个视角，这是看到多个相同的动画元素的倾斜角是不同的。但如果直接在元素本身这是perspective，则会发现多个元素的倾斜角依然相同，因为这相当于创建了多个视角</p>
<p>详细请看大神博客<a href="http://www.zhangxinxu.com/wordpress/2012/09/css3-3d-transform-perspective-animate-transition/" target="_blank" rel="external">css3d动画</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/01/07/20160107/" data-id="ciyvlrhls000bocvrcasgn28y" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/3d动画/">3d动画</a></li></ul>

    </footer>
  </div>
  
</article>




  
    <article id="post-20151231" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/12/31/20151231/" class="article-date">
  <time datetime="2015-12-30T16:00:00.000Z" itemprop="datePublished">2015-12-31</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/css/">css</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/12/31/20151231/">css盒子模型</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>作为web前端程序猿，虽然应该重点关注js，但基本的css应该也要“彻底”弄清楚，我们都知道盒子模型有两种：ie盒子和w3c标准盒子<br>要说明一下的是：ie并不是不支持w3c标准的盒子，只要在网页顶部去掉doctype的声明，ie会采用ie盒子；    反之则采用w3c盒子</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">&lt;!DOCTYPE html&gt;</div><div class="line">&lt;html&gt;</div><div class="line">&lt;head&gt;</div><div class="line">&lt;style&gt;</div><div class="line">	.limitOuter&#123;</div><div class="line">		width:100px;</div><div class="line">		height:100px;</div><div class="line">		border:5px solid green;</div><div class="line">		padding:10px;</div><div class="line">		margin:10px;</div><div class="line">		background-color: red;</div><div class="line">	&#125;</div><div class="line">	.limitContent&#123;</div><div class="line">		background-color: blue;</div><div class="line">	&#125;</div><div class="line">&lt;/style&gt;</div><div class="line">&lt;/head&gt;</div><div class="line">&lt;body&gt;</div><div class="line">	&lt;div class=<span class="string">"limitOuter"</span>&gt;</div><div class="line">		&lt;div class=<span class="string">"limitContent"</span>&gt;&lt;/div&gt;</div><div class="line">	&lt;/div&gt;</div><div class="line">&lt;/body&gt;</div><div class="line">&lt;script&gt;</div><div class="line">	console.log(document.querySelector(<span class="string">'.limitOuter'</span>).offsetWidth);	//chrome中130，		ie中100</div><div class="line">	console.log(document.querySelector(<span class="string">'.limitContent'</span>).offsetWidth);	//chrome中100，		ie中70</div><div class="line">&lt;/script&gt;</div><div class="line">&lt;/html&gt;</div></pre></td></tr></table></figure>
<p>可以看出ie设置width,包括了border和padding； w3c中width则只是content的width，整个元素的offsetWidth还包括了border和padding；    </p>
<p>这个在排版的时候很重要，比如两个li排成一列，最好设定li宽度50%； 之后为了让内部元素不撑开外部元素，应该使用内部元素的margin来形成间距； 而不是直接在li上设定padding</p>
<p>##延伸<br>css3中出现了新的盒子模型：弹性盒子模型，在很多地方我们会看到display:flex,    box,    flexbox三种方式</p>
<p>display: box - This was the first flexible box model that was accepted as the newest model around the year 2009. Don’t use it.</p>
<p>display: flexbox - This flexible box model came in the year 2011 which was still in its development. Don’t use it.</p>
<p>display: flex - This is the newest flexible box model that currently finds its place as the latest box standard. This might further undergo some changes but this is preferred to the other two standards.</p>
<p>其实都是盒子模型，不过是不同的时期的不同模型<br>flex对应如下属性：<br>flex-direction:<br>flex-wrap:<br>flex-flow:    flex-direction,flex-wrap的简写<br>justify-content:<br>align-items:<br>align-content:<br><a href="http://www.runoob.com/w3cnote/flex-grammar.html" target="_blank" rel="external">flex属性简介</a></p>
<p>与之对应box有如下属性：<br>box-orient:<br>box-direction:<br>box-lines:<br>box-align:<br>box-pack:<br>box-orient 属性指定一个box子元素是否应按水平或垂直排列。<br>Tip: 水平方向的box里的子元素是由左到右显示，垂直方向的box显示从上到下排列。然而，box-direction方向可由 box-ordinal-group属性改变这个顺序。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2015/12/31/20151231/" data-id="ciyvlrhlh0006ocvryt1j0szq" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/盒子模型/">盒子模型</a></li></ul>

    </footer>
  </div>
  
</article>




  
    <article id="post-20151229" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/12/29/20151229/" class="article-date">
  <time datetime="2015-12-28T16:00:00.000Z" itemprop="datePublished">2015-12-29</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/js/">js</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/12/29/20151229/">移动设备中的点击事件</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>最近接触了几个移动web活动页面的制作，不算复杂，用不上类似angular的框架，自己决定使用哪些js库，很自由。说一下为此了解的几个问题。</p>
<h2 id="click事件在移动设备上"><a href="#click事件在移动设备上" class="headerlink" title="click事件在移动设备上"></a>click事件在移动设备上</h2><p>click事件在web页面中有300ms的延迟，原因和历史大家知道，当初iphone流行时考虑到双指点击缩放的问题，需要等待300ms来确定用户是单击还是双击，因此造成的延迟在设备上还是比较明显<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">var body = document.querySelector(<span class="string">'body'</span>);</div><div class="line">var st,et,ct;</div><div class="line">body.addEventListener(<span class="string">'touchstart'</span>, <span class="function"><span class="title">function</span></span>()&#123;</div><div class="line">	st = Date.now();</div><div class="line">&#125;);</div><div class="line">body.addEventListener(<span class="string">'touchend'</span>, <span class="function"><span class="title">function</span></span>()&#123;</div><div class="line">	et = Date.now();</div><div class="line">&#125;);</div><div class="line">body.addEventListener(<span class="string">'click'</span>, <span class="function"><span class="title">function</span></span>()&#123;</div><div class="line">	ct = Date.now();</div><div class="line">	console.log(<span class="string">"touchstart gap: "</span> + (ct-st));	//301</div><div class="line">	console.log(<span class="string">"touchend gap: "</span> + (ct-et));	//173</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<h2 id="解决过程"><a href="#解决过程" class="headerlink" title="解决过程"></a>解决过程</h2><h3 id="zepto-touch"><a href="#zepto-touch" class="headerlink" title="zepto touch"></a>zepto touch</h3><p>页面用使用zepto的话，建议使用touch模块中的tap方法，此模块还提供了’swipe’, ‘swipeLeft’, ‘swipeRight’, ‘swipeUp’, ‘swipeDown’,’doubleTap’, ‘tap’, ‘singleTap’, ‘longTap’等方法<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">touchTimeout = <span class="built_in">set</span>Timeout(<span class="function"><span class="title">function</span></span>()&#123;</div><div class="line">                  touchTimeout = null</div><div class="line">                  <span class="keyword">if</span> (touch.el) touch.el.trigger(<span class="string">'singleTap'</span>)</div><div class="line">                  touch = &#123;&#125;</div><div class="line">                &#125;, 250)</div></pre></td></tr></table></figure></p>
<p>以上是部分源码，它是通过添加touchstart[touchstart MSPointerDown pointerdown],    touchmove[touchmove MSPointerMove pointermove]    touchend[touchend MSPointerUp pointerup]事件监听，激发Tap事件条件可能有两个：<br>1.没有激发touchmove事件则直接激发<br>2.激发了touchmove事件则要在移动误差deltaX和deltaY小于30<br>实测效果可以，但依赖zepto</p>
<p>另外还有一个很严重的问题<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$(document)</div><div class="line">    .bind(<span class="string">'MSGestureEnd'</span>, <span class="keyword">function</span>(e)&#123;&#125;</div></pre></td></tr></table></figure></p>
<p>touch模块中将所有的事件都代理到document上</p>
<h3 id="fastclick"><a href="#fastclick" class="headerlink" title="fastclick"></a>fastclick</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">FastClick.attach(document.body);</div><div class="line"></div><div class="line">var body = document.querySelector(<span class="string">'body'</span>);</div><div class="line">	var st,et,ct;</div><div class="line">	body.addEventListener(<span class="string">'touchstart'</span>, <span class="function"><span class="title">function</span></span>()&#123;</div><div class="line">		st = Date.now();</div><div class="line">	&#125;);</div><div class="line">	body.addEventListener(<span class="string">'touchend'</span>, <span class="function"><span class="title">function</span></span>()&#123;</div><div class="line">		et = Date.now();</div><div class="line">	&#125;);</div><div class="line">	body.addEventListener(<span class="string">'click'</span>, <span class="function"><span class="title">function</span></span>()&#123;</div><div class="line">		ct = Date.now();</div><div class="line">		console.log(<span class="string">"touchstart gap: "</span> + (ct-st));	//130</div><div class="line">		console.log(<span class="string">"touchend gap: "</span> + (ct-et));	//NaN</div><div class="line">	&#125;);</div></pre></td></tr></table></figure>
<p>基本上touchend之后立即触发，另外fastclick相比于tap还有如下优点：<a href="http://www.cnblogs.com/yexiaochai/p/3442220.html" target="_blank" rel="external">fastclick与zepto tap对比</a></p>
<h3 id="自定义点击事件"><a href="#自定义点击事件" class="headerlink" title="自定义点击事件"></a>自定义点击事件</h3><p>如果要做的页面很少，想想fastclick 26k的大小，还是不想用，另外业务需求，要加入点击效果，so想想还是自定义一个吧<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">window.Tap = <span class="keyword">function</span>(p)&#123;</div><div class="line">        this.target = p.target ;</div><div class="line">        this.tapCallBack = p.tapCallBack || <span class="function"><span class="title">function</span></span>()&#123;&#125;;</div><div class="line">        this.startCallBack = p.startCallBack || <span class="function"><span class="title">function</span></span>()&#123;&#125;;</div><div class="line">        this.endCallBack = p.endCallBack || <span class="function"><span class="title">function</span></span>()&#123;&#125;;</div><div class="line">        this.cancelCallBack = p.cancelCallBack || <span class="function"><span class="title">function</span></span>()&#123;&#125;;</div><div class="line">    &#125;;</div><div class="line">    Tap.prototype.addTapEvent = <span class="function"><span class="title">function</span></span>()&#123;</div><div class="line">        var touch = &#123;&#125;;</div><div class="line">        this.target.addEventListener(<span class="string">'touchstart'</span>, <span class="keyword">function</span>(e)&#123;</div><div class="line">            this.startCallBack(this.target);</div><div class="line">            touch.x1 = e.touches[0].pageX;</div><div class="line">            touch.y1 = e.touches[0].pageY;</div><div class="line">            touch.last = Date.now();</div><div class="line">        &#125;.bind(this));</div><div class="line"></div><div class="line">        this.target.addEventListener(<span class="string">'touchmove'</span>, <span class="keyword">function</span>(e)&#123;</div><div class="line">            touch.x2 = e.touches[0].pageX;</div><div class="line">            touch.y2 = e.touches[0].pageY;</div><div class="line">        &#125;.bind(this));</div><div class="line"></div><div class="line">        this.target.addEventListener(<span class="string">'touchend'</span>, <span class="keyword">function</span>(e)&#123;</div><div class="line">            this.endCallBack(this.target);</div><div class="line">            /*模拟zepto tap事件, 分为touchmove激发和不激发两种情况*/</div><div class="line">            <span class="keyword">if</span>( (Date.now() - touch.last &lt; 250) )&#123;</div><div class="line">                <span class="keyword">if</span>(touch.x2 &amp;&amp; touch.y2)&#123;</div><div class="line">                    <span class="keyword">if</span>( Math.abs(touch.x1 - touch.x2) &lt; 30 &amp;&amp; Math.abs(touch.y1 - touch.y2) &lt; 30 )&#123;</div><div class="line">                        this.tapCallBack(this.target);</div><div class="line">                    &#125;</div><div class="line">                &#125;<span class="keyword">else</span>&#123;</div><div class="line">                    this.tapCallBack(this.target);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            touch = &#123;&#125;;</div><div class="line">        &#125;.bind(this));</div><div class="line"></div><div class="line">        this.target.addEventListener(<span class="string">'touchcancel'</span>, <span class="function"><span class="title">function</span></span>()&#123;</div><div class="line">            touch = &#123;&#125;;</div><div class="line">            this.cancelCallBack(this.target);</div><div class="line">        &#125;.bind(this));</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>定义了按下回调，弹起回调，点击回调和取消回调几个函数；考虑到会被多次调用，必须私有化这几个变量，所以定义在构造函数中，其他模拟zepto tap，但将点击直接绑定在元素本身，为了保证在事件回调函数中访问到外面的this, 利用bind关键字改变函数this上下文，这是bind常用的地方。<br>实测效果不错，自定义效果运行正常，</p>
<p>注意touch事件的流程<br>1.touchstart -》 touchend<br>2.touchstart -》 touchmove -》touchend<br>3.touchstart -》 touchcancel<br>4.2.touchstart -》 touchmove -》touchcancel<br>也就是说当touch事件被打断，touchcancel被触发时(如弹出复制选框)，touchend事件不会被执行。所以在cancel事件中要恢复样式。或者在touchstart事件中调用e.preventDefault()使得不会触发touchCancel。样式会自动返回。但这样会造成一系列问题：如果绑定的click事件不会被执行。不推荐这么做</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2015/12/29/20151229/" data-id="ciyvlrhle0005ocvry1vyuru3" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/点击/">点击</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/移动/">移动</a></li></ul>

    </footer>
  </div>
  
</article>




  
    <article id="post-20151210" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/12/10/20151210/" class="article-date">
  <time datetime="2015-12-09T16:00:00.000Z" itemprop="datePublished">2015-12-10</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/js/">js</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/12/10/20151210/">单页应用中的路由控制</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="1-以往的浏览器历史跳转"><a href="#1-以往的浏览器历史跳转" class="headerlink" title="1.以往的浏览器历史跳转"></a>1.以往的浏览器历史跳转</h2><p>在普通的通过window.location.href的跳转时实际上是直接改变了地址栏地址，对服务器发送了请求，至于<br>请求的文件的位置，这种路由的查找则是由服务器端完成的</p>
<h2 id="2-spa单页应用的不同"><a href="#2-spa单页应用的不同" class="headerlink" title="2.spa单页应用的不同"></a>2.spa单页应用的不同</h2><p>之前用angular写过几个移动app，一直没有考虑过其路由的问题。因为是使用了ionic和ui-router，所以之前一直以为是ionic<br>实现的单页应用而不是angular</p>
<p>![ionic code]{ioniccode.png}</p>
<p>ionic实现了模板的缓存，类似栈的形式，不断将新的页面压入栈顶（class=”active”）,而之前的页面(class=”cached”)则是<br>拥有display:none而隐藏</p>
<p>实际上angular的ng-route模块同ui-router一样都提供了客户端路由，使得spa应用成为可能</p>
<p>那么我们自己如何实现这种路由机制呢，方法有两种</p>
<p>1.location.hash  window.onhashchange事件<br>    优点： 兼容性好，ie8中支持</p>
<p>2.history.state pushState replaceState两种方法 window.popstate事件<br>    优点：h5中引入的新特性，可以传递参数对象</p>
<p>如下是我实现的一个pjax小测试<br>    <a href="https://github.com/uniquezhuo/spa-client-router" target="_blank" rel="external">基于location.hash实现的客户端路由</a><br>    至于pjax，后续我会研究类似于director.js这样的路由库或者ng-route和ui-router进行更深度的分析，毕竟在实际应用中，我们不敢也不用去造轮子</p>
<p>那么有一个问题产生了，修改location为什么没有发生跳转呢</p>
<p>这就设计到锚标记的问题了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&lt;a href=<span class="string">"#point"</span>&gt;&lt;/a&gt;</div><div class="line">&lt;p id=<span class="string">'point'</span>&gt;&lt;/p&gt;</div></pre></td></tr></table></figure>
<p>这就是a标签锚点的应用，常用于在很长的一张网页中进行导航，点击a会跳转到p的位置，可见当location<br>遇到#号后面的hash部分发生变化时不会跳转，而仅仅是在本页面中查找相应位置</p>
<p>这也是所有客户端路由库的原理，改变hash骗过浏览器的历史导航，而实际使用ajax请求模板，替换页面中的内容，这种技术成为pjax</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2015/12/10/20151210/" data-id="ciyvlrhki0000ocvrcnlmixux" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/路由/">路由</a></li></ul>

    </footer>
  </div>
  
</article>




  
    <article id="post-20151103" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/11/03/20151103/" class="article-date">
  <time datetime="2015-11-02T16:00:00.000Z" itemprop="datePublished">2015-11-03</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/js/">js</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/11/03/20151103/">js严格模式与非严格模式</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="一-概述"><a href="#一-概述" class="headerlink" title="一.概述"></a>一.概述</h3><p>严格模式是在ECMAScript5中引入的，它是该语言的一个受限制的子集，它修正了语言的重要缺陷，并提供了健壮的查错功能和增强的安全机制。使用<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="string">'use strict'</span>;</div></pre></td></tr></table></figure></p>
<p>进入该模式，其后续所有代码都会被解析为严格代码</p>
<h3 id="二-严格模式与非严格模式区别-前三条尤为重要"><a href="#二-严格模式与非严格模式区别-前三条尤为重要" class="headerlink" title="二.严格模式与非严格模式区别(前三条尤为重要)"></a>二.严格模式与非严格模式区别(前三条尤为重要)</h3><ol>
<li><p>严格模式中禁止使用with语句<br> with用法如下</p>
 <figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">var s=&#123;</div><div class="line">	t:&#123;</div><div class="line">		<span class="built_in">name</span>:'zhuo',</div><div class="line">		<span class="built_in">id</span>:<span class="number">32434</span></div><div class="line">	&#125;</div><div class="line">&#125;;</div><div class="line"><span class="keyword">with</span>(s.t)&#123;</div><div class="line">	<span class="built_in">name</span>='lingyun',</div><div class="line">	<span class="built_in">id</span>=<span class="number">565</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p> with不是简单的做了一个代码缩写，它是在当前作用域链顶层又添加了一个新的活动对象，之后属性的查找沿着作用域链，会首先从活动对象往下找，直至全局window对象。可见恰当使用with会加快查找速度，减少输入。with的性能问题另见博客<br> 这种作用域链的修改是临时的，在with语句结束后，顶部对象会被销毁<br> 还要注意with修改作用域链只在查找时有用到，如果创建新的变量，是没有作用的</p>
 <figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> o=&#123;&#125;;</div><div class="line"><span class="keyword">with</span>(o)&#123;</div><div class="line">	x=<span class="number">1</span>;</div><div class="line">&#125;			<span class="comment">//o还是没有x属性，x创建在window对象中</span></div><div class="line"><span class="keyword">var</span> s=&#123;<span class="attr">x</span>:<span class="number">0</span>&#125;;</div><div class="line"><span class="keyword">with</span>(s)&#123;</div><div class="line">	s.x=<span class="number">1</span>;</div><div class="line">&#125;			<span class="comment">//s=&#123;x:1&#125;</span></div><div class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line"><span class="meta">	"use strict"</span>; </div><div class="line">	<span class="keyword">var</span> s=&#123;<span class="attr">x</span>:<span class="number">0</span>&#125;;</div><div class="line">	<span class="keyword">with</span>(s)&#123;</div><div class="line">		s.x=<span class="number">1</span>;	<span class="comment">//Strict mode code may not include a with statement(…)</span></div><div class="line">	&#125;</div><div class="line">&#125;)();</div></pre></td></tr></table></figure>
<p> 可见with提供了一种只读取，写入；但不创建属性的方法  </p>
<blockquote>
<p>权威指南中写到: with语句浏览器难以优化，运行效率慢<br> 可见严格模式中为什么禁用with</p>
</blockquote>
</li>
<li><p>在严格模式中，所有的变量都要先声明</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">(<span class="function"><span class="title">function</span></span>()&#123;</div><div class="line">	<span class="string">"use strict"</span>; </div><div class="line">	m=0;	// Uncaught ReferenceError: m is not defined(…)</div><div class="line">&#125;)();</div></pre></td></tr></table></figure>
</li>
<li><p>在严格模式中，调用一个函数（不是方法）的this指向undefined而不是window</p>
 <figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> isStrict = (<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line"><span class="meta">	"use strict"</span>;</div><div class="line">	<span class="keyword">return</span> <span class="keyword">this</span> === <span class="literal">undefined</span>;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p> 因此我们也有了一种判断当前javascript解释器是否支持严格模式的方法</p>
</li>
<li><p>在严格模式中，通过call或apply调用函数时，this值就是第一个参数（在非严格模式中，null和undefined会被全局对象和转换为对象的非对象值所代替）</p>
 <figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line"><span class="meta">	'use strict'</span>;</div><div class="line">	<span class="keyword">var</span> f=<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;<span class="built_in">console</span>.log(<span class="keyword">this</span>.name);&#125;; </div><div class="line">	<span class="keyword">var</span> s=&#123;<span class="attr">name</span>:<span class="string">"zhuo"</span>&#125;; </div><div class="line">	<span class="keyword">var</span> name=<span class="string">"ling"</span>; </div><div class="line">	f.call();		<span class="comment">//Cannot read property 'name' of undefined(…)</span></div><div class="line">				<span class="comment">//如果去掉'use strict',结果为ling，证明被window取代</span></div><div class="line">&#125;)();</div></pre></td></tr></table></figure>
</li>
<li><p>在严格模式中，给只读属性赋值和给不可扩展的对象创建新成员会抛出一个类型错误异常（在非严格模式中，这些操作只是简单地操作失败，不会报错）</p>
 <figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line"><span class="meta">	'use strict'</span>;	<span class="comment">//加上严格之后Uncaught TypeError: Cannot assign to read only property 'x' of #&lt;Object&gt;(…)</span></div><div class="line">	<span class="keyword">var</span> o=&#123;&#125;;</div><div class="line">	<span class="built_in">Object</span>.defineProperty(o, <span class="string">"x"</span>, &#123;<span class="attr">value</span>:<span class="number">1</span>, <span class="attr">writable</span>:<span class="literal">false</span>, <span class="attr">enumerable</span>:<span class="literal">true</span>, <span class="attr">configurable</span>:<span class="literal">true</span>&#125;);</div><div class="line">	o.x = <span class="number">2</span>;</div><div class="line">&#125;)();</div><div class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line"><span class="meta">	'use strict'</span>;	<span class="comment">//Uncaught TypeError: Can't add property newp, object is not extensible(…)</span></div><div class="line">	<span class="keyword">var</span> o=&#123;<span class="attr">p</span>:<span class="number">1</span>&#125;;</div><div class="line">	<span class="built_in">Object</span>.preventExtensions(o);</div><div class="line">	<span class="comment">//Object.seal(o);</span></div><div class="line">	<span class="comment">//Object.freeze(o);</span></div><div class="line">	o.newp=<span class="number">2</span>;</div><div class="line">&#125;)();</div></pre></td></tr></table></figure>
</li>
<li><p>在严格模式中，传入eval()的代码不能在调用程序所在的上下文中声明变量或者定义函数，而在非严格模式中可以这么做。</p>
</li>
<li><p>在严格模式中，arguments对象拥有传入函数值的静态副本。在非严格模式中，arguments里的数组元素和函数参数指向同一个值的引用</p>
</li>
<li><p>在严格模式中，当delete运算法之后跟随非法标识符(比如变量，函数，函数参数)时，会报错。非严格模式中只是返回false</p>
</li>
<li><p>在严格模式中, 试图删除一个不可配置的属性会报错,非严格模式中，只是返回false</p>
</li>
<li><p>在严格模式中，一个对象直接量中定义两个同名属性会报错，而非严格模式则不会</p>
</li>
<li><p>在严格模式中，参数出现同名会报错，非严格模式中不会</p>
</li>
<li><p>在严格模式中，不允许使用八进制整数直接量，非严格中可以</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line"><span class="meta">	'use strict'</span>;		<span class="comment">//Uncaught SyntaxError: Octal literals are not allowed in strict mode.(…)</span></div><div class="line">	<span class="keyword">var</span> e=<span class="number">023</span>;</div><div class="line">&#125;)();</div></pre></td></tr></table></figure>
</li>
<li><p>在严格模式中，eval和arguments被当作关键字</p>
</li>
<li><p>在严格模式中，限制了对调用栈的检测能力，在函数中arguments.caller和arguments.callee的访问会报错。严格模式同样具有caller和arguments属性，当访问这两个属性时会报错；</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line"><span class="meta">	'use strict'</span>;</div><div class="line">	<span class="function"><span class="keyword">function</span> <span class="title">fun</span>(<span class="params"></span>)</span>&#123;</div><div class="line">		<span class="built_in">console</span>.log(<span class="built_in">arguments</span>.caller, <span class="built_in">arguments</span>.callee);</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">function</span> <span class="title">callfun</span>(<span class="params"></span>)</span>&#123;</div><div class="line">		fun(<span class="number">1</span>,<span class="number">2</span>);</div><div class="line">	&#125;</div><div class="line">	callfun();	<span class="comment">//Uncaught TypeError: 'caller', 'callee', and 'arguments' properties may not be accessed on strict mode functions or the arguments objects for calls to them(…)</span></div><div class="line">&#125;)()</div></pre></td></tr></table></figure>
</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2015/11/03/20151103/" data-id="ciyvlrhlm0008ocvrsqwromy2" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/严格模式/">严格模式</a></li></ul>

    </footer>
  </div>
  
</article>




  
  


</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/css/">css</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/">java</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/js/">js</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/node/">node</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/redux/">redux</a><span class="category-list-count">2</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/3d动画/">3d动画</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/IScroller/">IScroller</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/angular/">angular</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/canvas/">canvas</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/clientHeight/">clientHeight</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/clientLeft/">clientLeft</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/clientTop/">clientTop</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cookie/">cookie</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/">java</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/js/">js</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/minicap/">minicap</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/node/">node</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/offsetHeight/">offsetHeight</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/offsetLeft/">offsetLeft</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/offsetTop/">offsetTop</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/react/">react</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/react-redux/">react-redux</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/redux/">redux</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rem/">rem</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/scrollHeight/">scrollHeight</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/scrollLeft/">scrollLeft</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/scrollTop/">scrollTop</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/spa/">spa</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/stf/">stf</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/symbol/">symbol</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/viewport/">viewport</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vue/">vue</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vue-router/">vue-router</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/webpack/">webpack</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/webpack-dev-server/">webpack-dev-server</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/下拉刷新-上拉加载/">下拉刷新+上拉加载</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/严格模式/">严格模式</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/切图/">切图</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/动画/">动画</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/单页/">单页</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/单页应用中的按需加载/">单页应用中的按需加载</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/多页/">多页</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/排序算法/">排序算法</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/瀑布流/">瀑布流</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/点击/">点击</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/爬虫/">爬虫</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/盒子模型/">盒子模型</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/移动/">移动</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/算法/">算法</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/网络/">网络</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/路由/">路由</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/闭包/">闭包</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/3d动画/" style="font-size: 10px;">3d动画</a> <a href="/tags/IScroller/" style="font-size: 10px;">IScroller</a> <a href="/tags/angular/" style="font-size: 10px;">angular</a> <a href="/tags/canvas/" style="font-size: 10px;">canvas</a> <a href="/tags/clientHeight/" style="font-size: 10px;">clientHeight</a> <a href="/tags/clientLeft/" style="font-size: 10px;">clientLeft</a> <a href="/tags/clientTop/" style="font-size: 10px;">clientTop</a> <a href="/tags/cookie/" style="font-size: 10px;">cookie</a> <a href="/tags/java/" style="font-size: 10px;">java</a> <a href="/tags/js/" style="font-size: 10px;">js</a> <a href="/tags/minicap/" style="font-size: 10px;">minicap</a> <a href="/tags/node/" style="font-size: 10px;">node</a> <a href="/tags/offsetHeight/" style="font-size: 10px;">offsetHeight</a> <a href="/tags/offsetLeft/" style="font-size: 10px;">offsetLeft</a> <a href="/tags/offsetTop/" style="font-size: 10px;">offsetTop</a> <a href="/tags/react/" style="font-size: 10px;">react</a> <a href="/tags/react-redux/" style="font-size: 10px;">react-redux</a> <a href="/tags/redux/" style="font-size: 20px;">redux</a> <a href="/tags/rem/" style="font-size: 10px;">rem</a> <a href="/tags/scrollHeight/" style="font-size: 10px;">scrollHeight</a> <a href="/tags/scrollLeft/" style="font-size: 10px;">scrollLeft</a> <a href="/tags/scrollTop/" style="font-size: 10px;">scrollTop</a> <a href="/tags/spa/" style="font-size: 10px;">spa</a> <a href="/tags/stf/" style="font-size: 10px;">stf</a> <a href="/tags/symbol/" style="font-size: 10px;">symbol</a> <a href="/tags/viewport/" style="font-size: 10px;">viewport</a> <a href="/tags/vue/" style="font-size: 20px;">vue</a> <a href="/tags/vue-router/" style="font-size: 10px;">vue-router</a> <a href="/tags/webpack/" style="font-size: 20px;">webpack</a> <a href="/tags/webpack-dev-server/" style="font-size: 10px;">webpack-dev-server</a> <a href="/tags/下拉刷新-上拉加载/" style="font-size: 10px;">下拉刷新+上拉加载</a> <a href="/tags/严格模式/" style="font-size: 10px;">严格模式</a> <a href="/tags/切图/" style="font-size: 10px;">切图</a> <a href="/tags/动画/" style="font-size: 10px;">动画</a> <a href="/tags/单页/" style="font-size: 10px;">单页</a> <a href="/tags/单页应用中的按需加载/" style="font-size: 10px;">单页应用中的按需加载</a> <a href="/tags/多页/" style="font-size: 10px;">多页</a> <a href="/tags/排序算法/" style="font-size: 10px;">排序算法</a> <a href="/tags/瀑布流/" style="font-size: 10px;">瀑布流</a> <a href="/tags/点击/" style="font-size: 10px;">点击</a> <a href="/tags/爬虫/" style="font-size: 10px;">爬虫</a> <a href="/tags/盒子模型/" style="font-size: 10px;">盒子模型</a> <a href="/tags/移动/" style="font-size: 10px;">移动</a> <a href="/tags/算法/" style="font-size: 10px;">算法</a> <a href="/tags/网络/" style="font-size: 10px;">网络</a> <a href="/tags/路由/" style="font-size: 10px;">路由</a> <a href="/tags/闭包/" style="font-size: 10px;">闭包</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">October 2016</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">May 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">February 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">January 2016</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">December 2015</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">November 2015</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2016/12/08/20170206/">基于openstf minicap实现的屏幕投影客户端</a>
          </li>
        
          <li>
            <a href="/2016/12/08/20161208/">stf源码解读</a>
          </li>
        
          <li>
            <a href="/2016/11/25/20161125/">私有变量与私有方法实现</a>
          </li>
        
          <li>
            <a href="/2016/11/24/20161124/">react-redux源码解析</a>
          </li>
        
          <li>
            <a href="/2016/11/19/20161119/">redux源码解析</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 卓凌云<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>