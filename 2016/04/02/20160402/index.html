<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>js实现图片切图 | vanquish blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="刚到的这创业公司还真是忙啊，web前端就我一个，最近时间忙一个微信上的saas系统，都快一个月时间没空写博客了。项目快忙完了，也顺便总结下自己遇到的几个问题，这里说得是canvas实现切图
首先想到的是js如何操作图片数据呢，毕竟js没有读写函数，但查了下资料，html5有file api，可见还是要多去了解html5新技术的应用
123456789101112131415161718192021">
<meta property="og:type" content="article">
<meta property="og:title" content="js实现图片切图">
<meta property="og:url" content="http://yoursite.com/2016/04/02/20160402/index.html">
<meta property="og:site_name" content="vanquish blog">
<meta property="og:description" content="刚到的这创业公司还真是忙啊，web前端就我一个，最近时间忙一个微信上的saas系统，都快一个月时间没空写博客了。项目快忙完了，也顺便总结下自己遇到的几个问题，这里说得是canvas实现切图
首先想到的是js如何操作图片数据呢，毕竟js没有读写函数，但查了下资料，html5有file api，可见还是要多去了解html5新技术的应用
123456789101112131415161718192021">
<meta property="og:updated_time" content="2016-10-13T13:49:42.241Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="js实现图片切图">
<meta name="twitter:description" content="刚到的这创业公司还真是忙啊，web前端就我一个，最近时间忙一个微信上的saas系统，都快一个月时间没空写博客了。项目快忙完了，也顺便总结下自己遇到的几个问题，这里说得是canvas实现切图
首先想到的是js如何操作图片数据呢，毕竟js没有读写函数，但查了下资料，html5有file api，可见还是要多去了解html5新技术的应用
123456789101112131415161718192021">
  
    <link rel="alternative" href="/atom.xml" title="vanquish blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css">
  

</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">vanquish blog</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">make progress every day</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-20160402" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/04/02/20160402/" class="article-date">
  <time datetime="2016-04-01T16:00:00.000Z" itemprop="datePublished">2016-04-02</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/js/">js</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      js实现图片切图
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>刚到的这创业公司还真是忙啊，web前端就我一个，最近时间忙一个微信上的saas系统，都快一个月时间没空写博客了。项目快忙完了，也顺便总结下自己遇到的几个问题，这里说得是canvas实现切图</p>
<p>首先想到的是js如何操作图片数据呢，毕竟js没有读写函数，但查了下资料，html5有file api，可见还是要多去了解html5新技术的应用</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">&lt;html&gt;</div><div class="line">&lt;head&gt;</div><div class="line">&lt;/head&gt;</div><div class="line">&lt;body&gt;</div><div class="line">   	&lt;input <span class="built_in">type</span>=<span class="string">"file"</span> value=<span class="string">""</span> id=<span class="string">"petImg-input"</span> accept=<span class="string">"image/*"</span> style=<span class="string">"display:none;"</span>/&gt;</div><div class="line">   	&lt;div id=<span class="string">"image-cropper"</span> style=<span class="string">"display:none; z-index:10; position:absolute; top:0; bottom:0; left:0; right:0; background-color:black;"</span>&gt;</div><div class="line">       &lt;div id=<span class="string">"image-area"</span> style=<span class="string">" position:absolute; top:10px; left: 50%; -webkit-transform:translateX(-50%); "</span>&gt;</div><div class="line">           &lt;img id=<span class="string">"corp-img"</span> style=<span class="string">"max-width:650px; max-height:700px; display:block;"</span>&gt;</div><div class="line">           &lt;div id=<span class="string">"corp-div"</span> style=<span class="string">"visibility:hidden; border:1px solid white; width:200px; height:200px; position:absolute; top:0; left:0; background-color: rgba(0, 0, 0, 0.2);"</span>&gt;</div><div class="line">               &lt;i id=<span class="string">"resize-point"</span> style=<span class="string">"display:block; width:30px; height:30px; border:1px solid white; border-radius:15px; position:absolute; right:-15px; bottom:-15px"</span>&gt;&lt;/i&gt;</div><div class="line">           &lt;/div&gt;</div><div class="line">       &lt;/div&gt;</div><div class="line">       &lt;canvas id=<span class="string">"crop-canvas"</span> width=<span class="string">"200"</span> height=<span class="string">"200"</span> style=<span class="string">"position:absolute; display:none;"</span>&gt;&lt;/canvas&gt;</div><div class="line">    &lt;/div&gt;</div><div class="line">    &lt;div id=<span class="string">"cropper-btns"</span> style=<span class="string">"position:absolute; z-index:12; bottom:30px; width:100%; height:80px; display:none;"</span>&gt;</div><div class="line">        &lt;span id=<span class="string">"cropper-sure"</span> style=<span class="string">"display: block;width: 150px;height: 80px;line-height: 80px;text-align: center; font-size: 32px;color: white;float: left;"</span>&gt;确定&lt;/span&gt;</div><div class="line">        &lt;span id=<span class="string">"cropper-cancel"</span>  style=<span class="string">"display: block;width: 150px;height: 80px;line-height: 80px;text-align: center; font-size: 32px;color: white;float: right;"</span>&gt;取消&lt;/span&gt;</div><div class="line">    &lt;/div&gt;</div><div class="line">   	&lt;script <span class="built_in">type</span>=<span class="string">"text/javascript"</span>&gt;</div><div class="line">   		var imgInput = document.querySelector(<span class="string">'#petImg-input'</span>);</div><div class="line">   		var cropImg = document.querySelector(<span class="string">'#corp-img'</span>);</div><div class="line"></div><div class="line">   		imgInput.addEventListener(<span class="string">'change'</span>, <span class="keyword">function</span>(file)&#123;</div><div class="line">			var reader = new FileReader();</div><div class="line">			reader.readAsDataURL(file);</div><div class="line">			reader.onload = <span class="function"><span class="title">function</span></span>()&#123;</div><div class="line">				//展示用图片</div><div class="line">				cropImg.src = reader.result;</div><div class="line">				//裁剪逻辑......</div><div class="line">			&#125;</div><div class="line">   		&#125;, <span class="literal">false</span>);</div><div class="line">   	&lt;/script&gt;</div><div class="line">&lt;/body&gt;</div><div class="line">&lt;/html&gt;</div></pre></td></tr></table></figure>
<p>FileReader对象允许访问Blob中的字符或字节，可以把它视为是BlobBuilder对应的一个对象。FileReader共有readAsText(), readAsArrayBuffer(), readAsDataURL(),readAsBinaryString()几个读取方法</p>
<p>但input type=file这种方式选取和读取本地文件在移动端却兼容性很差，很多手机上调不起本地图库。所以代替用微信jssdk解决图像选取这部分的问题。裁剪仍然用之前的逻辑。<br>微信图像接口主要有<br>wx.chooseImage({<br>    count: 1, // 默认9<br>    sizeType: [‘original’, ‘compressed’], // 可以指定是原图还是压缩图，默认二者都有<br>    sourceType: [‘album’, ‘camera’], // 可以指定来源是相册还是相机，默认二者都有<br>    success: function (res) {<br>        var localIds = res.localIds; // 返回选定照片的本地ID列表，localId可以作为img标签的src属性显示图片<br>    }<br>});<br>返回的localIds只是一段普通的字符串，并不能借此获取图片源信息，也就不能裁剪，所以还得用<br>wx.uploadImage({<br>    localId: ‘’, // 需要上传的图片的本地ID，由chooseImage接口获得<br>    isShowProgressTips: 1, // 默认为1，显示进度提示<br>    success: function (res) {<br>        var serverId = res.serverId; // 返回图片的服务器端ID<br>    }<br>});<br>将图片上传到微信服务器。但上传的图片有效期是三天，所以还需要用自己的服务器将图片存储下来<br>http请求方式: GET<br><a href="http://file.api.weixin.qq.com/cgi-bin/media/get?access_token=ACCESS_TOKEN&amp;media_id=MEDIA_ID" target="_blank" rel="external">http://file.api.weixin.qq.com/cgi-bin/media/get?access_token=ACCESS_TOKEN&amp;media_id=MEDIA_ID</a><br>调用微信多媒体下载接口就可以了。</p>
<p>整个流程出来了。先使用chooseImage之后在回调中调用uploadImage。之后请求后台自己的接口拉取微信图片服务器中的图片，并且返回base64字符串就行<br><strong style="color:red;">注：这里有个坑！！！起初为了减少数据量传输，本来只打算返回cdn上的图片url就行，想通过canvas的getImageData获取图片base64信息，后来调这个方法总是报错，查了下，是有跨域的限制，原来canvas也有跨域的限制，学习了，果然浏览器对于安全的限制无处不在</strong><br>有了base64信息，接下来就是裁剪了。裁剪方法也很简单：<br>1.将base64字符串赋值给corpimg.src作为展示；<br>2.使用oCropDiv作为裁剪框，加上拖动和拉伸改变大小的效果；<br>3.点击确定裁剪的时候，根据oCropDiv的大小和位置坐标，将图片的一部分drawImage到canvas上，再通过getImageData获取裁剪的图片的base64字符串，并且调用后台接口上传<br>完整代码如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div></pre></td><td class="code"><pre><div class="line">            var maxWidth = 650, maxHeight=700, transformRatio=1;</div><div class="line">            var cropImg = $(&apos;#corp-img&apos;);</div><div class="line">            var cropCanvas = $(&apos;#crop-canvas&apos;);</div><div class="line">            var cropDiv = $(&apos;#corp-div&apos;);</div><div class="line">            var resizePoint = $(&apos;#resize-point&apos;);</div><div class="line">            var imageCropper = $(&apos;#image-cropper&apos;);</div><div class="line">            var imageArea = $(&apos;#image-area&apos;);</div><div class="line">            $(&apos;.petInfoInput-page .pet-Img&apos;).on(&apos;click&apos;, function(ev)&#123;</div><div class="line">                wx.chooseImage(&#123;</div><div class="line">                    count: 1, // 默认9</div><div class="line">                    sizeType: [&apos;original&apos;, &apos;compressed&apos;], // 可以指定是原图还是压缩图，默认二者都有</div><div class="line">                    sourceType: [&apos;album&apos;, &apos;camera&apos;], // 可以指定来源是相册还是相机，默认二者都有</div><div class="line">                    success: function (res) &#123;</div><div class="line">                        var localIds = res.localIds; //返回选定照片的本地ID列表，localId可以作为img标签的src属性显示图片</div><div class="line">                        //显示裁剪浮层</div><div class="line">                        imageCropper.css(&apos;display&apos;,&apos;block&apos;);</div><div class="line">                        //显示loading</div><div class="line">                        util.loading();</div><div class="line"></div><div class="line">                        wx.uploadImage(&#123;</div><div class="line">                            localId: localIds[0], // 需要上传的图片的本地ID，由chooseImage接口获得</div><div class="line">                            isShowProgressTips: 0, // 默认为1，显示进度提示</div><div class="line">                            success: function (res) &#123;</div><div class="line">                                var serverId = res.serverId; // 返回图片的服务器端ID</div><div class="line">                                util.ajaxData(&apos;/json/SAAS_H5_GetImageToWx&apos;, &#123;type:2, mediaId:serverId&#125;).done(function(data)&#123;    //1是个人，2是宠物</div><div class="line">                                    var corpimg = document.getElementById(&apos;corp-img&apos;);</div><div class="line">                                    corpimg.src = &apos;data:image/jpg;base64,&apos; + data.body[&quot;img&quot;].trim();</div><div class="line">                                    alert(corpimg.src);</div><div class="line">                                    corpimg.onload = function()&#123;</div><div class="line">                                        util.loading(true);</div><div class="line"></div><div class="line">                                        var imgNw = cropImg[0].naturalWidth;</div><div class="line">                                        var imgNh = cropImg[0].naturalHeight;</div><div class="line"></div><div class="line">                                        if(imgNh&gt;maxHeight || imgNw&gt;maxWidth)&#123;  //图片被压缩了</div><div class="line">                                            if(imgNw&gt;imgNh)&#123;</div><div class="line">                                                transformRatio = imgNw / maxWidth;</div><div class="line">                                                cropDiv.css(&#123;&apos;width&apos;:imgNh/transformRatio, &apos;height&apos;:imgNh/transformRatio&#125;);</div><div class="line">                                            &#125; else &#123;        //img压缩高度宽度不会被改变，需要自己调整</div><div class="line">                                                transformRatio = imgNh / maxHeight;</div><div class="line">                                                cropImg.css(&apos;width&apos;, imgNw/transformRatio);</div><div class="line">                                                cropDiv.css(&#123;&apos;width&apos;:imgNw/transformRatio, &apos;height&apos;:imgNw/transformRatio&#125;);</div><div class="line">                                            &#125;</div><div class="line">                                        &#125; else &#123;                             //需要拉伸图片</div><div class="line">                                            if(imgNw&gt;imgNh)&#123;</div><div class="line">                                                transformRatio = imgNw/maxWidth;</div><div class="line">                                                cropImg.css(&#123;</div><div class="line">                                                    &apos;width&apos;: maxWidth,</div><div class="line">                                                    &apos;height&apos;: imgNh/transformRatio</div><div class="line">                                                &#125;);</div><div class="line">                                                cropDiv.css(&#123;&apos;width&apos;:maxHeight, &apos;height&apos;:maxHeight&#125;);</div><div class="line">                                            &#125; else &#123;</div><div class="line">                                                transformRatio = imgNh/maxHeight;</div><div class="line">                                                cropImg.css(&#123;</div><div class="line">                                                    &apos;width&apos;: maxWidth/transformRatio,</div><div class="line">                                                    &apos;height&apos;: maxHeight</div><div class="line">                                                &#125;);</div><div class="line">                                                cropDiv.css(&#123;&apos;width&apos;:maxHeight, &apos;height&apos;:maxHeight&#125;);</div><div class="line">                                            &#125;</div><div class="line">                                        &#125;</div><div class="line">                                    &#125;;</div><div class="line">                                &#125;).fail(function()&#123;</div><div class="line">                                    util.toster(&apos;图片上传失败&apos;);</div><div class="line">                                &#125;);</div><div class="line">                            &#125;</div><div class="line">                        &#125;);</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">                ev.stopImmediatePropagation();</div><div class="line">                ev.preventDefault();</div><div class="line">            &#125;);</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">            var oImageArea = document.getElementById(&apos;image-area&apos;);</div><div class="line">            oImageArea.addEventListener(&apos;click&apos;, function(e)&#123;</div><div class="line">                var deltax = e.pageX - (360-imageArea.width()/2) - cropDiv.width()/2;</div><div class="line">                var deltay = e.pageY - cropDiv.height()/2;</div><div class="line">                cropDiv.css(&#123;</div><div class="line">                    &apos;left&apos;: deltax,</div><div class="line">                    &apos;top&apos;: deltay</div><div class="line">                &#125;);</div><div class="line">                e.stopImmediatePropagation();</div><div class="line">                e.preventDefault();</div><div class="line">            &#125;);</div><div class="line"></div><div class="line">            var sx,sy,nowleft,nowtop, oCropDiv=document.getElementById(&apos;corp-div&apos;);</div><div class="line">            oCropDiv.addEventListener(&apos;touchstart&apos;, function(e)&#123;</div><div class="line">                sx = e.changedTouches[0].pageX;</div><div class="line">                sy = e.changedTouches[0].pageY;</div><div class="line">                nowleft = parseFloat($(this).css(&apos;left&apos;).slice(0,-2));</div><div class="line">                nowtop = parseFloat($(this).css(&apos;top&apos;).slice(0,-2));</div><div class="line">            &#125;);</div><div class="line">            oCropDiv.addEventListener(&apos;touchmove&apos;, function(e)&#123;</div><div class="line">                var deltax = e.changedTouches[0].pageX - sx;</div><div class="line">                var deltay = e.changedTouches[0].pageY - sy;</div><div class="line">                // console.log(deltax + &apos; &apos; +  deltay);</div><div class="line">                $(this).css(&#123;</div><div class="line">                    &apos;left&apos;: nowleft + deltax,</div><div class="line">                    &apos;top&apos;: nowtop + deltay</div><div class="line">                &#125;);</div><div class="line">            &#125;);</div><div class="line">            oCropDiv.addEventListener(&apos;touchend&apos;, function(e)&#123;</div><div class="line">                sx = e.changedTouches[0].pageX;</div><div class="line">                sy = e.changedTouches[0].pageY;</div><div class="line">                //检测边界问题</div><div class="line">                self.checkBound(cropDiv, imageArea, 1);</div><div class="line">            &#125;);</div><div class="line"></div><div class="line">            var px,py,nowwidth,nowheight, oResizePoint=document.getElementById(&apos;resize-point&apos;);</div><div class="line">            oResizePoint.addEventListener(&apos;touchstart&apos;, function(e)&#123;</div><div class="line">                px = e.changedTouches[0].pageX;</div><div class="line">                py = e.changedTouches[0].pageY;</div><div class="line">                nowwidth = $(cropDiv).width();</div><div class="line">                nowheight = $(cropDiv).height();</div><div class="line">                e.stopImmediatePropagation();</div><div class="line">                e.preventDefault();</div><div class="line">            &#125;);</div><div class="line">            oResizePoint.addEventListener(&apos;touchmove&apos;, function(e)&#123;</div><div class="line">                var deltax = e.changedTouches[0].pageX - px;</div><div class="line">                var deltay = e.changedTouches[0].pageY - py;</div><div class="line">                $(cropDiv).css(&#123;</div><div class="line">                    &apos;width&apos;: nowwidth + deltax,</div><div class="line">                    &apos;height&apos;: nowheight + deltay</div><div class="line">                &#125;);</div><div class="line">                e.stopImmediatePropagation();</div><div class="line">                e.preventDefault();</div><div class="line">            &#125;);</div><div class="line">            oResizePoint.addEventListener(&apos;touchend&apos;, function(e)&#123;</div><div class="line">                px = e.changedTouches[0].pageX;</div><div class="line">                py = e.changedTouches[0].pageY;</div><div class="line">                //检测边界问题</div><div class="line">                self.checkBound(cropDiv, imageArea, 2);</div><div class="line">                e.stopImmediatePropagation();</div><div class="line">                e.preventDefault();</div><div class="line">            &#125;);</div><div class="line"></div><div class="line">//            var canvas = document.getElementById(&apos;crop-canvas&apos;);</div><div class="line">//            var ctx = canvas.getContext(&apos;2d&apos;);</div><div class="line">            $(&apos;#cropper-sure&apos;).on(&apos;click&apos;, function(e)&#123;</div><div class="line">                util.loading(false);</div><div class="line">                //需要乘上devicePixelRatio，canvas坐标使用的是物理像素  * devicePixelRatio</div><div class="line">                var x = transformRatio  * parseFloat($(cropDiv).css(&apos;left&apos;).slice(0,-2));</div><div class="line">                var y = transformRatio  * parseFloat($(cropDiv).css(&apos;top&apos;).slice(0,-2));</div><div class="line">                var wid = transformRatio  * $(cropDiv).width();</div><div class="line">                var hei = transformRatio  * $(cropDiv).height();</div><div class="line">//                cropCanvas.attr(&#123;&quot;width&quot;:wid, &quot;height&quot;:hei&#125;);</div><div class="line">                var cropCan = document.getElementById(&quot;crop-canvas&quot;);</div><div class="line">                var cropImage = document.getElementById(&quot;corp-img&quot;);</div><div class="line">                cropImage.crossOrigin = &quot;Anonymous&quot;;</div><div class="line">                cropCan.width = wid;</div><div class="line">                cropCan.height = hei;</div><div class="line">                var ctx = cropCan.getContext(&apos;2d&apos;);</div><div class="line">                ctx.drawImage(cropImage, x, y, wid, hei, 0, 0, wid, hei);</div><div class="line">                var data = cropCan.toDataURL();</div><div class="line">                alert(&quot;imgdata&quot; + data);</div><div class="line">                $.ajax(&#123;</div><div class="line">                    type: &apos;post&apos;,</div><div class="line">                    url: &apos;/imageupload&apos;,</div><div class="line">                    data:&#123;type:&apos;petimg&apos;, base64:data&#125;,</div><div class="line">                    dataType: &apos;json&apos;,</div><div class="line">                    success: function(res)&#123;</div><div class="line">                        if(res &amp;&amp; res.code == 0)&#123;</div><div class="line">                            util.toster(&apos;保存成功&apos;);</div><div class="line">                            $(&apos;.petImg-show&apos;).attr(&apos;src&apos;, data);        //设置显示</div><div class="line">                            $(&apos;#image-cropper&apos;).css(&apos;display&apos;, &apos;none&apos;);</div><div class="line"></div><div class="line">                            $(&apos;.petImg-show&apos;).attr(&apos;data-id&apos;, res.imageId);</div><div class="line">                            self.checkChange(1);</div><div class="line">                        &#125; else &#123;</div><div class="line">                            util.toster(&apos;保存失败&apos;);</div><div class="line">                        &#125;</div><div class="line">                    &#125;,</div><div class="line">                    error: function()&#123;</div><div class="line">                        util.toster(&apos;保存失败&apos;);</div><div class="line">                    &#125;,</div><div class="line">                    complete: function()&#123;</div><div class="line">                        util.loading(true);</div><div class="line">                    &#125;</div><div class="line">                &#125;)</div><div class="line">            &#125;);</div><div class="line"></div><div class="line">            $(&apos;#cropper-cancel&apos;).on(&apos;click&apos;, function()&#123;</div><div class="line">                setTimeout(function()&#123;</div><div class="line">                    $(&apos;#image-cropper&apos;).css(&apos;display&apos;, &apos;none&apos;);</div><div class="line">                &#125;, 500);</div><div class="line">            &#125;);</div></pre></td></tr></table></figure></p>
<p>其中还考虑了两个问题：<br>1.图像压缩的问题，限定最大宽maxWidth和高maxHeight，图片等比例压缩，计算出缩小或者拉伸的比例transformRatio。在canvas drawImage的时候要将cropdiv的坐标和高度乘上相应比例<br>2.边界超出处理，如果拉伸大小或者拖动超出边界，都直接回正</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/04/02/20160402/" data-id="civ136dpo000iqgdlso96qniz" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/canvas/">canvas</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/切图/">切图</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2016/05/30/20160530/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          单页应用中的按需加载
        
      </div>
    </a>
  
  
    <a href="/2016/02/15/20160215/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">offsetHeight,clientHeight和scrollHeight的区别</div>
    </a>
  
</nav>

  
</article>




  <section id="comments">
    <!-- 多说评论框 start -->
    <div class="ds-thread" data-thread-key="post-20160402" data-title="js实现图片切图" data-url="http://yoursite.com/2016/04/02/20160402/"></div>
    <!-- 多说评论框 end -->
    <!-- 多说公共JS代码 start (一个网页只需插入一次) -->
    <script type="text/javascript">
    var duoshuoQuery = {short_name:'uniquezhuo'};
      (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0] 
         || document.getElementsByTagName('body')[0]).appendChild(ds);
      })();
      </script>
    <!-- 多说公共JS代码 end -->
  </section>
</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/css/">css</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/js/">js</a><span class="category-list-count">12</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/3d动画/">3d动画</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/IScroller/">IScroller</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/angular/">angular</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/canvas/">canvas</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/clientHeight/">clientHeight</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/clientLeft/">clientLeft</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/clientTop/">clientTop</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/js/">js</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/offsetHeight/">offsetHeight</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/offsetLeft/">offsetLeft</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/offsetTop/">offsetTop</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/scrollHeight/">scrollHeight</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/scrollLeft/">scrollLeft</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/scrollTop/">scrollTop</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/spa/">spa</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vue/">vue</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vue-router/">vue-router</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/webpack/">webpack</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/webpack-dev-server/">webpack-dev-server</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/下拉刷新-上拉加载/">下拉刷新+上拉加载</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/严格模式/">严格模式</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/切图/">切图</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/动画/">动画</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/单页/">单页</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/单页应用中的按需加载/">单页应用中的按需加载</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/多页/">多页</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/排序算法/">排序算法</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/瀑布流/">瀑布流</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/点击/">点击</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/爬虫/">爬虫</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/盒子模型/">盒子模型</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/移动/">移动</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/算法/">算法</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/网络/">网络</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/路由/">路由</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/3d动画/" style="font-size: 10px;">3d动画</a> <a href="/tags/IScroller/" style="font-size: 10px;">IScroller</a> <a href="/tags/angular/" style="font-size: 10px;">angular</a> <a href="/tags/canvas/" style="font-size: 10px;">canvas</a> <a href="/tags/clientHeight/" style="font-size: 10px;">clientHeight</a> <a href="/tags/clientLeft/" style="font-size: 10px;">clientLeft</a> <a href="/tags/clientTop/" style="font-size: 10px;">clientTop</a> <a href="/tags/js/" style="font-size: 10px;">js</a> <a href="/tags/offsetHeight/" style="font-size: 10px;">offsetHeight</a> <a href="/tags/offsetLeft/" style="font-size: 10px;">offsetLeft</a> <a href="/tags/offsetTop/" style="font-size: 10px;">offsetTop</a> <a href="/tags/scrollHeight/" style="font-size: 10px;">scrollHeight</a> <a href="/tags/scrollLeft/" style="font-size: 10px;">scrollLeft</a> <a href="/tags/scrollTop/" style="font-size: 10px;">scrollTop</a> <a href="/tags/spa/" style="font-size: 10px;">spa</a> <a href="/tags/vue/" style="font-size: 20px;">vue</a> <a href="/tags/vue-router/" style="font-size: 10px;">vue-router</a> <a href="/tags/webpack/" style="font-size: 20px;">webpack</a> <a href="/tags/webpack-dev-server/" style="font-size: 10px;">webpack-dev-server</a> <a href="/tags/下拉刷新-上拉加载/" style="font-size: 10px;">下拉刷新+上拉加载</a> <a href="/tags/严格模式/" style="font-size: 10px;">严格模式</a> <a href="/tags/切图/" style="font-size: 10px;">切图</a> <a href="/tags/动画/" style="font-size: 10px;">动画</a> <a href="/tags/单页/" style="font-size: 10px;">单页</a> <a href="/tags/单页应用中的按需加载/" style="font-size: 10px;">单页应用中的按需加载</a> <a href="/tags/多页/" style="font-size: 10px;">多页</a> <a href="/tags/排序算法/" style="font-size: 10px;">排序算法</a> <a href="/tags/瀑布流/" style="font-size: 10px;">瀑布流</a> <a href="/tags/点击/" style="font-size: 10px;">点击</a> <a href="/tags/爬虫/" style="font-size: 10px;">爬虫</a> <a href="/tags/盒子模型/" style="font-size: 10px;">盒子模型</a> <a href="/tags/移动/" style="font-size: 10px;">移动</a> <a href="/tags/算法/" style="font-size: 10px;">算法</a> <a href="/tags/网络/" style="font-size: 10px;">网络</a> <a href="/tags/路由/" style="font-size: 10px;">路由</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">October 2016</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">May 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">February 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">January 2016</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">December 2015</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">November 2015</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2016/11/02/20161102/">webpack热更新调试的几种方法</a>
          </li>
        
          <li>
            <a href="/2016/10/15/20161015/">vue+webpack单页应用及多页应用实现</a>
          </li>
        
          <li>
            <a href="/2016/10/13/20161013/">iscroll源码解析及vue下拉刷新与上拉加载组件实现</a>
          </li>
        
          <li>
            <a href="/2016/10/12/20161012/">node实现爬虫抓取淘宝商品图文详情</a>
          </li>
        
          <li>
            <a href="/2016/07/07/20160707/">几种基本排序算法的理解</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 卓凌云<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>