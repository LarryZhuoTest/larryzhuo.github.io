<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>vanquish blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="vanquish blog">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="vanquish blog">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="vanquish blog">
  
    <link rel="alternative" href="/atom.xml" title="vanquish blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css">
  

</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">vanquish blog</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">make progress every day</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-20160402" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/04/02/20160402/" class="article-date">
  <time datetime="2016-04-01T16:00:00.000Z" itemprop="datePublished">2016-04-02</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/js/">js</a>►<a class="article-category-link" href="/categories/js/进阶/">进阶</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/04/02/20160402/">js实现图片切图</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>刚到的这创业公司还真是忙啊，web前端就我一个，最近时间忙一个微信上的saas系统，都快一个月时间没空写博客了。项目快忙完了，也顺便总结下自己遇到的几个问题，这里说得是canvas实现切图</p>
<p>首先想到的是js如何操作图片数据呢，毕竟js没有读写函数，但查了下资料，html5有file api，可见还是要多去了解html5新技术的应用</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">&lt;html&gt;</div><div class="line">&lt;head&gt;</div><div class="line">&lt;/head&gt;</div><div class="line">&lt;body&gt;</div><div class="line">   	&lt;input <span class="built_in">type</span>=<span class="string">"file"</span> value=<span class="string">""</span> id=<span class="string">"petImg-input"</span> accept=<span class="string">"image/*"</span> style=<span class="string">"display:none;"</span>/&gt;</div><div class="line">   	&lt;div id=<span class="string">"image-cropper"</span> style=<span class="string">"display:none; z-index:10; position:absolute; top:0; bottom:0; left:0; right:0; background-color:black;"</span>&gt;</div><div class="line">       &lt;div id=<span class="string">"image-area"</span> style=<span class="string">" position:absolute; top:10px; left: 50%; -webkit-transform:translateX(-50%); "</span>&gt;</div><div class="line">           &lt;img id=<span class="string">"corp-img"</span> style=<span class="string">"max-width:650px; max-height:700px; display:block;"</span>&gt;</div><div class="line">           &lt;div id=<span class="string">"corp-div"</span> style=<span class="string">"visibility:hidden; border:1px solid white; width:200px; height:200px; position:absolute; top:0; left:0; background-color: rgba(0, 0, 0, 0.2);"</span>&gt;</div><div class="line">               &lt;i id=<span class="string">"resize-point"</span> style=<span class="string">"display:block; width:30px; height:30px; border:1px solid white; border-radius:15px; position:absolute; right:-15px; bottom:-15px"</span>&gt;&lt;/i&gt;</div><div class="line">           &lt;/div&gt;</div><div class="line">       &lt;/div&gt;</div><div class="line">       &lt;canvas id=<span class="string">"crop-canvas"</span> width=<span class="string">"200"</span> height=<span class="string">"200"</span> style=<span class="string">"position:absolute; display:none;"</span>&gt;&lt;/canvas&gt;</div><div class="line">    &lt;/div&gt;</div><div class="line">    &lt;div id=<span class="string">"cropper-btns"</span> style=<span class="string">"position:absolute; z-index:12; bottom:30px; width:100%; height:80px; display:none;"</span>&gt;</div><div class="line">        &lt;span id=<span class="string">"cropper-sure"</span> style=<span class="string">"display: block;width: 150px;height: 80px;line-height: 80px;text-align: center; font-size: 32px;color: white;float: left;"</span>&gt;确定&lt;/span&gt;</div><div class="line">        &lt;span id=<span class="string">"cropper-cancel"</span>  style=<span class="string">"display: block;width: 150px;height: 80px;line-height: 80px;text-align: center; font-size: 32px;color: white;float: right;"</span>&gt;取消&lt;/span&gt;</div><div class="line">    &lt;/div&gt;</div><div class="line">   	&lt;script <span class="built_in">type</span>=<span class="string">"text/javascript"</span>&gt;</div><div class="line">   		var imgInput = document.querySelector(<span class="string">'#petImg-input'</span>);</div><div class="line">   		var cropImg = document.querySelector(<span class="string">'#corp-img'</span>);</div><div class="line"></div><div class="line">   		imgInput.addEventListener(<span class="string">'change'</span>, <span class="keyword">function</span>(file)&#123;</div><div class="line">			var reader = new FileReader();</div><div class="line">			reader.readAsDataURL(file);</div><div class="line">			reader.onload = <span class="function"><span class="title">function</span></span>()&#123;</div><div class="line">				//展示用图片</div><div class="line">				cropImg.src = reader.result;</div><div class="line">				//裁剪逻辑......</div><div class="line">			&#125;</div><div class="line">   		&#125;, <span class="literal">false</span>);</div><div class="line">   	&lt;/script&gt;</div><div class="line">&lt;/body&gt;</div><div class="line">&lt;/html&gt;</div></pre></td></tr></table></figure>
<p>FileReader对象允许访问Blob中的字符或字节，可以把它视为是BlobBuilder对应的一个对象。FileReader共有readAsText(), readAsArrayBuffer(), readAsDataURL(),readAsBinaryString()几个读取方法</p>
<p>但input type=file这种方式选取和读取本地文件在移动端却兼容性很差，很多手机上调不起本地图库。所以代替用微信jssdk解决图像选取这部分的问题。裁剪仍然用之前的逻辑。<br>微信图像接口主要有<br>wx.chooseImage({<br>    count: 1, // 默认9<br>    sizeType: [‘original’, ‘compressed’], // 可以指定是原图还是压缩图，默认二者都有<br>    sourceType: [‘album’, ‘camera’], // 可以指定来源是相册还是相机，默认二者都有<br>    success: function (res) {<br>        var localIds = res.localIds; // 返回选定照片的本地ID列表，localId可以作为img标签的src属性显示图片<br>    }<br>});<br>返回的localIds只是一段普通的字符串，并不能借此获取图片源信息，也就不能裁剪，所以还得用<br>wx.uploadImage({<br>    localId: ‘’, // 需要上传的图片的本地ID，由chooseImage接口获得<br>    isShowProgressTips: 1, // 默认为1，显示进度提示<br>    success: function (res) {<br>        var serverId = res.serverId; // 返回图片的服务器端ID<br>    }<br>});<br>将图片上传到微信服务器。但上传的图片有效期是三天，所以还需要用自己的服务器将图片存储下来<br>http请求方式: GET<br><a href="http://file.api.weixin.qq.com/cgi-bin/media/get?access_token=ACCESS_TOKEN&amp;media_id=MEDIA_ID" target="_blank" rel="external">http://file.api.weixin.qq.com/cgi-bin/media/get?access_token=ACCESS_TOKEN&amp;media_id=MEDIA_ID</a><br>调用微信多媒体下载接口就可以了。</p>
<p>整个流程出来了。先使用chooseImage之后在回调中调用uploadImage。之后请求后台自己的接口拉取微信图片服务器中的图片，并且返回base64字符串就行<br><strong style="color:red;">注：这里有个坑！！！起初为了减少数据量传输，本来只打算返回cdn上的图片url就行，想通过canvas的getImageData获取图片base64信息，后来调这个方法总是报错，查了下，是有跨域的限制，原来canvas也有跨域的限制，学习了，果然浏览器对于安全的限制无处不在</strong><br>有了base64信息，接下来就是裁剪了。裁剪方法也很简单：<br>1.将base64字符串赋值给corpimg.src作为展示；<br>2.使用oCropDiv作为裁剪框，加上拖动和拉伸改变大小的效果；<br>3.点击确定裁剪的时候，根据oCropDiv的大小和位置坐标，将图片的一部分drawImage到canvas上，再通过getImageData获取裁剪的图片的base64字符串，并且调用后台接口上传<br>完整代码如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div></pre></td><td class="code"><pre><div class="line">            var maxWidth = 650, maxHeight=700, transformRatio=1;</div><div class="line">            var cropImg = $(&apos;#corp-img&apos;);</div><div class="line">            var cropCanvas = $(&apos;#crop-canvas&apos;);</div><div class="line">            var cropDiv = $(&apos;#corp-div&apos;);</div><div class="line">            var resizePoint = $(&apos;#resize-point&apos;);</div><div class="line">            var imageCropper = $(&apos;#image-cropper&apos;);</div><div class="line">            var imageArea = $(&apos;#image-area&apos;);</div><div class="line">            $(&apos;.petInfoInput-page .pet-Img&apos;).on(&apos;click&apos;, function(ev)&#123;</div><div class="line">                wx.chooseImage(&#123;</div><div class="line">                    count: 1, // 默认9</div><div class="line">                    sizeType: [&apos;original&apos;, &apos;compressed&apos;], // 可以指定是原图还是压缩图，默认二者都有</div><div class="line">                    sourceType: [&apos;album&apos;, &apos;camera&apos;], // 可以指定来源是相册还是相机，默认二者都有</div><div class="line">                    success: function (res) &#123;</div><div class="line">                        var localIds = res.localIds; //返回选定照片的本地ID列表，localId可以作为img标签的src属性显示图片</div><div class="line">                        //显示裁剪浮层</div><div class="line">                        imageCropper.css(&apos;display&apos;,&apos;block&apos;);</div><div class="line">                        //显示loading</div><div class="line">                        util.loading();</div><div class="line"></div><div class="line">                        wx.uploadImage(&#123;</div><div class="line">                            localId: localIds[0], // 需要上传的图片的本地ID，由chooseImage接口获得</div><div class="line">                            isShowProgressTips: 0, // 默认为1，显示进度提示</div><div class="line">                            success: function (res) &#123;</div><div class="line">                                var serverId = res.serverId; // 返回图片的服务器端ID</div><div class="line">                                util.ajaxData(&apos;/json/SAAS_H5_GetImageToWx&apos;, &#123;type:2, mediaId:serverId&#125;).done(function(data)&#123;    //1是个人，2是宠物</div><div class="line">                                    var corpimg = document.getElementById(&apos;corp-img&apos;);</div><div class="line">                                    corpimg.src = &apos;data:image/jpg;base64,&apos; + data.body[&quot;img&quot;].trim();</div><div class="line">                                    alert(corpimg.src);</div><div class="line">                                    corpimg.onload = function()&#123;</div><div class="line">                                        util.loading(true);</div><div class="line"></div><div class="line">                                        var imgNw = cropImg[0].naturalWidth;</div><div class="line">                                        var imgNh = cropImg[0].naturalHeight;</div><div class="line"></div><div class="line">                                        if(imgNh&gt;maxHeight || imgNw&gt;maxWidth)&#123;  //图片被压缩了</div><div class="line">                                            if(imgNw&gt;imgNh)&#123;</div><div class="line">                                                transformRatio = imgNw / maxWidth;</div><div class="line">                                                cropDiv.css(&#123;&apos;width&apos;:imgNh/transformRatio, &apos;height&apos;:imgNh/transformRatio&#125;);</div><div class="line">                                            &#125; else &#123;        //img压缩高度宽度不会被改变，需要自己调整</div><div class="line">                                                transformRatio = imgNh / maxHeight;</div><div class="line">                                                cropImg.css(&apos;width&apos;, imgNw/transformRatio);</div><div class="line">                                                cropDiv.css(&#123;&apos;width&apos;:imgNw/transformRatio, &apos;height&apos;:imgNw/transformRatio&#125;);</div><div class="line">                                            &#125;</div><div class="line">                                        &#125; else &#123;                             //需要拉伸图片</div><div class="line">                                            if(imgNw&gt;imgNh)&#123;</div><div class="line">                                                transformRatio = imgNw/maxWidth;</div><div class="line">                                                cropImg.css(&#123;</div><div class="line">                                                    &apos;width&apos;: maxWidth,</div><div class="line">                                                    &apos;height&apos;: imgNh/transformRatio</div><div class="line">                                                &#125;);</div><div class="line">                                                cropDiv.css(&#123;&apos;width&apos;:maxHeight, &apos;height&apos;:maxHeight&#125;);</div><div class="line">                                            &#125; else &#123;</div><div class="line">                                                transformRatio = imgNh/maxHeight;</div><div class="line">                                                cropImg.css(&#123;</div><div class="line">                                                    &apos;width&apos;: maxWidth/transformRatio,</div><div class="line">                                                    &apos;height&apos;: maxHeight</div><div class="line">                                                &#125;);</div><div class="line">                                                cropDiv.css(&#123;&apos;width&apos;:maxHeight, &apos;height&apos;:maxHeight&#125;);</div><div class="line">                                            &#125;</div><div class="line">                                        &#125;</div><div class="line">                                    &#125;;</div><div class="line">                                &#125;).fail(function()&#123;</div><div class="line">                                    util.toster(&apos;图片上传失败&apos;);</div><div class="line">                                &#125;);</div><div class="line">                            &#125;</div><div class="line">                        &#125;);</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">                ev.stopImmediatePropagation();</div><div class="line">                ev.preventDefault();</div><div class="line">            &#125;);</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">            var oImageArea = document.getElementById(&apos;image-area&apos;);</div><div class="line">            oImageArea.addEventListener(&apos;click&apos;, function(e)&#123;</div><div class="line">                var deltax = e.pageX - (360-imageArea.width()/2) - cropDiv.width()/2;</div><div class="line">                var deltay = e.pageY - cropDiv.height()/2;</div><div class="line">                cropDiv.css(&#123;</div><div class="line">                    &apos;left&apos;: deltax,</div><div class="line">                    &apos;top&apos;: deltay</div><div class="line">                &#125;);</div><div class="line">                e.stopImmediatePropagation();</div><div class="line">                e.preventDefault();</div><div class="line">            &#125;);</div><div class="line"></div><div class="line">            var sx,sy,nowleft,nowtop, oCropDiv=document.getElementById(&apos;corp-div&apos;);</div><div class="line">            oCropDiv.addEventListener(&apos;touchstart&apos;, function(e)&#123;</div><div class="line">                sx = e.changedTouches[0].pageX;</div><div class="line">                sy = e.changedTouches[0].pageY;</div><div class="line">                nowleft = parseFloat($(this).css(&apos;left&apos;).slice(0,-2));</div><div class="line">                nowtop = parseFloat($(this).css(&apos;top&apos;).slice(0,-2));</div><div class="line">            &#125;);</div><div class="line">            oCropDiv.addEventListener(&apos;touchmove&apos;, function(e)&#123;</div><div class="line">                var deltax = e.changedTouches[0].pageX - sx;</div><div class="line">                var deltay = e.changedTouches[0].pageY - sy;</div><div class="line">                // console.log(deltax + &apos; &apos; +  deltay);</div><div class="line">                $(this).css(&#123;</div><div class="line">                    &apos;left&apos;: nowleft + deltax,</div><div class="line">                    &apos;top&apos;: nowtop + deltay</div><div class="line">                &#125;);</div><div class="line">            &#125;);</div><div class="line">            oCropDiv.addEventListener(&apos;touchend&apos;, function(e)&#123;</div><div class="line">                sx = e.changedTouches[0].pageX;</div><div class="line">                sy = e.changedTouches[0].pageY;</div><div class="line">                //检测边界问题</div><div class="line">                self.checkBound(cropDiv, imageArea, 1);</div><div class="line">            &#125;);</div><div class="line"></div><div class="line">            var px,py,nowwidth,nowheight, oResizePoint=document.getElementById(&apos;resize-point&apos;);</div><div class="line">            oResizePoint.addEventListener(&apos;touchstart&apos;, function(e)&#123;</div><div class="line">                px = e.changedTouches[0].pageX;</div><div class="line">                py = e.changedTouches[0].pageY;</div><div class="line">                nowwidth = $(cropDiv).width();</div><div class="line">                nowheight = $(cropDiv).height();</div><div class="line">                e.stopImmediatePropagation();</div><div class="line">                e.preventDefault();</div><div class="line">            &#125;);</div><div class="line">            oResizePoint.addEventListener(&apos;touchmove&apos;, function(e)&#123;</div><div class="line">                var deltax = e.changedTouches[0].pageX - px;</div><div class="line">                var deltay = e.changedTouches[0].pageY - py;</div><div class="line">                $(cropDiv).css(&#123;</div><div class="line">                    &apos;width&apos;: nowwidth + deltax,</div><div class="line">                    &apos;height&apos;: nowheight + deltay</div><div class="line">                &#125;);</div><div class="line">                e.stopImmediatePropagation();</div><div class="line">                e.preventDefault();</div><div class="line">            &#125;);</div><div class="line">            oResizePoint.addEventListener(&apos;touchend&apos;, function(e)&#123;</div><div class="line">                px = e.changedTouches[0].pageX;</div><div class="line">                py = e.changedTouches[0].pageY;</div><div class="line">                //检测边界问题</div><div class="line">                self.checkBound(cropDiv, imageArea, 2);</div><div class="line">                e.stopImmediatePropagation();</div><div class="line">                e.preventDefault();</div><div class="line">            &#125;);</div><div class="line"></div><div class="line">//            var canvas = document.getElementById(&apos;crop-canvas&apos;);</div><div class="line">//            var ctx = canvas.getContext(&apos;2d&apos;);</div><div class="line">            $(&apos;#cropper-sure&apos;).on(&apos;click&apos;, function(e)&#123;</div><div class="line">                util.loading(false);</div><div class="line">                //需要乘上devicePixelRatio，canvas坐标使用的是物理像素  * devicePixelRatio</div><div class="line">                var x = transformRatio  * parseFloat($(cropDiv).css(&apos;left&apos;).slice(0,-2));</div><div class="line">                var y = transformRatio  * parseFloat($(cropDiv).css(&apos;top&apos;).slice(0,-2));</div><div class="line">                var wid = transformRatio  * $(cropDiv).width();</div><div class="line">                var hei = transformRatio  * $(cropDiv).height();</div><div class="line">//                cropCanvas.attr(&#123;&quot;width&quot;:wid, &quot;height&quot;:hei&#125;);</div><div class="line">                var cropCan = document.getElementById(&quot;crop-canvas&quot;);</div><div class="line">                var cropImage = document.getElementById(&quot;corp-img&quot;);</div><div class="line">                cropImage.crossOrigin = &quot;Anonymous&quot;;</div><div class="line">                cropCan.width = wid;</div><div class="line">                cropCan.height = hei;</div><div class="line">                var ctx = cropCan.getContext(&apos;2d&apos;);</div><div class="line">                ctx.drawImage(cropImage, x, y, wid, hei, 0, 0, wid, hei);</div><div class="line">                var data = cropCan.toDataURL();</div><div class="line">                alert(&quot;imgdata&quot; + data);</div><div class="line">                $.ajax(&#123;</div><div class="line">                    type: &apos;post&apos;,</div><div class="line">                    url: &apos;/imageupload&apos;,</div><div class="line">                    data:&#123;type:&apos;petimg&apos;, base64:data&#125;,</div><div class="line">                    dataType: &apos;json&apos;,</div><div class="line">                    success: function(res)&#123;</div><div class="line">                        if(res &amp;&amp; res.code == 0)&#123;</div><div class="line">                            util.toster(&apos;保存成功&apos;);</div><div class="line">                            $(&apos;.petImg-show&apos;).attr(&apos;src&apos;, data);        //设置显示</div><div class="line">                            $(&apos;#image-cropper&apos;).css(&apos;display&apos;, &apos;none&apos;);</div><div class="line"></div><div class="line">                            $(&apos;.petImg-show&apos;).attr(&apos;data-id&apos;, res.imageId);</div><div class="line">                            self.checkChange(1);</div><div class="line">                        &#125; else &#123;</div><div class="line">                            util.toster(&apos;保存失败&apos;);</div><div class="line">                        &#125;</div><div class="line">                    &#125;,</div><div class="line">                    error: function()&#123;</div><div class="line">                        util.toster(&apos;保存失败&apos;);</div><div class="line">                    &#125;,</div><div class="line">                    complete: function()&#123;</div><div class="line">                        util.loading(true);</div><div class="line">                    &#125;</div><div class="line">                &#125;)</div><div class="line">            &#125;);</div><div class="line"></div><div class="line">            $(&apos;#cropper-cancel&apos;).on(&apos;click&apos;, function()&#123;</div><div class="line">                setTimeout(function()&#123;</div><div class="line">                    $(&apos;#image-cropper&apos;).css(&apos;display&apos;, &apos;none&apos;);</div><div class="line">                &#125;, 500);</div><div class="line">            &#125;);</div></pre></td></tr></table></figure></p>
<p>其中还考虑了两个问题：<br>1.图像压缩的问题，限定最大宽maxWidth和高maxHeight，图片等比例压缩，计算出缩小或者拉伸的比例transformRatio。在canvas drawImage的时候要将cropdiv的坐标和高度乘上相应比例<br>2.边界超出处理，如果拉伸大小或者拖动超出边界，都直接回正</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/04/02/20160402/" data-id="ciu72xg98000qecdl6jn31uyz" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/canvas/">canvas</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/切图/">切图</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-20160215" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/02/15/20160215/" class="article-date">
  <time datetime="2016-02-14T16:00:00.000Z" itemprop="datePublished">2016-02-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/基础/">基础</a>►<a class="article-category-link" href="/categories/基础/css/">css</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/02/15/20160215/">offsetHeight,clientHeight和scrollHeight的区别</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>我们在写页面的时候经常会遇到判断是否滚动也页底的情况，比如在我的上一篇博客中的瀑布流插件的实现中就需要滑动到页底加载下一页的功能。这是大家会不会很头晕，clientTop，offsetTop，scrollTop这些怎么使用？</p>
<p>先google之，拿到两张图<br><img src="http://i.stack.imgur.com/zWca7.png"><br><img src="http://pic002.cnblogs.com/images/2011/85285/2011102915280329.jpg"><br>大概有一定了解</p>
<p>自己写个demo检验一下<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line">&lt;!doctype html&gt;</div><div class="line">&lt;html&gt;</div><div class="line">&lt;head&gt;</div><div class="line">	&lt;meta charset=<span class="string">"utf-8"</span>&gt;</div><div class="line">	&lt;style&gt;</div><div class="line">		<span class="comment">#container&#123;</span></div><div class="line">			height:200px; </div><div class="line">			width:200px; 		</div><div class="line">			border:5px solid blue;</div><div class="line">			padding:10px;</div><div class="line">			margin:10px;</div><div class="line">		&#125;</div><div class="line">		<span class="comment">#content&#123;</span></div><div class="line">			height:100%;</div><div class="line">			padding:8px;</div><div class="line">			border:4px solid red;</div><div class="line">			overflow:auto;</div><div class="line">		&#125;</div><div class="line">	&lt;/style&gt;</div><div class="line">&lt;/head&gt;</div><div class="line">&lt;body&gt;</div><div class="line">	&lt;div id=<span class="string">"container"</span>&gt;</div><div class="line">		&lt;div id=<span class="string">"content"</span>&gt;</div><div class="line">			&lt;div id=<span class="string">"text"</span>&gt;</div><div class="line">			测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试文本测试</div><div class="line">			&lt;/div&gt;</div><div class="line">		&lt;/div&gt;</div><div class="line">	&lt;/div&gt;</div><div class="line"></div><div class="line">	&lt;script&gt;</div><div class="line">		var text = document.querySelector(<span class="string">'#text'</span>);</div><div class="line">		console.log(text.offsetHeight);		//chrome下540</div><div class="line">		console.log(text.offsetWidth);		//chrome下159</div><div class="line"></div><div class="line">		var content = document.querySelector(<span class="string">'#content'</span>);</div><div class="line"></div><div class="line">		console.log(content.offsetHeight);	//chrome下224(100%=&gt;200px; 200+8+8+4+4)</div><div class="line">		console.log(content.offsetWidth);	//chrome下200(container中设置width为200,实际就是contentbox为200，这里自动占满了父级宽度，也是200)</div><div class="line"></div><div class="line">		console.log(content.clientHeight);	//chrome下216(200+8+8);</div><div class="line">		console.log(content.clientWidth);	//chrome下175(clientWidth和clientHeight不包括margin，border和滚动条宽度，包括padding宽度，这里如果没有滚动条就应该是200-4-4)</div><div class="line">		console.log(content.clientTop);		//chrome下4(content的border-top宽度)</div><div class="line">		console.log(content.clientLeft);	//chrome下4(content的border-left宽度)</div><div class="line"></div><div class="line">		console.log(content.scrollHeight);	//chrome下556(540+8+8),可见scrollHeight是内部元素的高度+padding的高度</div><div class="line">		console.log(content.scrollWidth);	//chrome下175(没有横向滚动条)</div><div class="line">		console.log(content.scrollTop);		//chrome下0-340</div><div class="line">	&lt;script&gt;</div><div class="line">&lt;/body&gt;</div><div class="line">&lt;/html&gt;</div></pre></td></tr></table></figure></p>
<p>有如下结论:</p>
<ol>
<li>注意content的scrollTop在变化，而text的scrollTop一直为0.    可想而知。content.clientHeight + content.scrollTop == content.scrollHeight到达底部(216 + 340 = 556);<br>可以发现这也是为什么scrollHeight和clientHeight都包含padding高度的原因，因为这样才能相互抵消。计算正确。</li>
<li>引用stackoverflow的一段话<br> clientHeight:<br> Returns the height of the visible area for an object, in pixels. The value contains the height with the padding, but it does not include the scrollBar, border, and the margin.<br> offsetHeight:<br> Returns the height of the visible area for an object, in pixels. The value contains the height with the padding, scrollBar, and the border, but does not include the margin.<br> So, offsetHeight includes scrollbar and border, clientHeight doesn’t.<br>大意就是：<span style="color:red;">offsetHeight包括scrollbar和border的高度，clientHeight则不包括两者； 它们都不包括margin的高度；</span></li>
</ol>
<p>结论大致与上面的两个图一致，浏览器兼容性未测试，后续遇到实际问题总结</p>
<p>效果图如下：<br><img src="http://i13.tietuku.com/396ca7456fe1fa83.png"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/02/15/20160215/" data-id="ciu72xg8r000hecdlmtbf5ie3" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/clientHeight/">clientHeight</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/clientLeft/">clientLeft</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/clientTop/">clientTop</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/offsetHeight/">offsetHeight</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/offsetLeft/">offsetLeft</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/offsetTop/">offsetTop</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/scrollHeight/">scrollHeight</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/scrollLeft/">scrollLeft</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/scrollTop/">scrollTop</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-20160214" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/02/14/20160214/" class="article-date">
  <time datetime="2016-02-13T16:00:00.000Z" itemprop="datePublished">2016-02-14</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/进阶/">进阶</a>►<a class="article-category-link" href="/categories/进阶/js/">js</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/02/14/20160214/">瀑布流布局插件的实现</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>最近看taobaoued的一篇博客关于<a href="http://ued.taobao.org/blog/2011/09/waterfall/" target="_blank" rel="external">瀑布流布局</a>,之前也看过<a href="http://www.l99.com/media_index.action" target="_blank" rel="external">同学公司的网站</a>用的这种布局，很新颖但不知道是什么名字，为提升实践能力，我就打算写一个瀑布流插件，弄了一天，现在放在<a href="https://github.com/uniquezhuo/WaterFallPlugin" target="_blank" rel="external">github waterfallplugin</a>上了。<br> Pinterest最早开始使用这种布局，后来国内的蘑菇街之类的网站开始跟风。这种布局明显适合那种大量图片显示的网站</p>
<h1 id="实现方式"><a href="#实现方式" class="headerlink" title="实现方式"></a>实现方式</h1><h2 id="一-多列浮动"><a href="#一-多列浮动" class="headerlink" title="一.多列浮动"></a>一.多列浮动</h2><p> 使用这种方式的网站有：<br> 蘑菇街，我同事的公司网站</p>
<p> 这种方式最容易想到，让几个div float在一个container中，每次加载出新内容时按计算结果向不同div中添加新的模块<br> <img src="http://img02.taobaocdn.com/tps/i2/T1zXGoXdVpXXXXXXXX-600-452.png"></p>
<p>优点：</p>
<ol>
<li>简单易实现</li>
<li>不用明确知道数据块高度，当数据块中有图片时，就不需要指定图片高度。（这一点很重要）<br>缺点：</li>
<li>列数固定，当浏览器窗口变化时，只能固定n列，出现滚动条</li>
</ol>
<h2 id="二-css3多栏布局"><a href="#二-css3多栏布局" class="headerlink" title="二.css3多栏布局"></a>二.css3多栏布局</h2><p>可查询column-count了解不多叙述。</p>
<p>优点:</p>
<ol>
<li>简单不用写代码<br>缺点：</li>
<li>css3兼容性问题</li>
</ol>
<h2 id="三-绝对定位"><a href="#三-绝对定位" class="headerlink" title="三.绝对定位"></a>三.绝对定位</h2><p>这种方式很高端，有难度，我写的插件也是采用的这种方式。使用这种方式的有：Pinterest， KISSY<br>使用我的WaterFall需要一句初始化代码即可<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">new WaterFall(&#123;</div><div class="line">          container: <span class="string">"#main-container"</span>,   //父容器</div><div class="line">          minColumn: 2,    //resize window时保留的最小列数</div><div class="line">          colWidth: 208,   //每列宽度，当前列数就去 max(container.width/(colWidth+colGap), minColumn)</div><div class="line">          colGap: 10,     //单元格列间距</div><div class="line">          rowGap: 10,     //单元格行坚决</div><div class="line">          load: <span class="keyword">function</span>(successCallBack)&#123;    //每次加载固定数据的函数，success为调整位置的函数</div><div class="line">              $.ajax(&#123;</div><div class="line">                  url: <span class="string">'items.json'</span>,</div><div class="line">                  data: &#123;&#125;,</div><div class="line">                  <span class="built_in">type</span>: <span class="string">'get'</span>,</div><div class="line">                  dataType: <span class="string">'json'</span>,</div><div class="line">                  success: <span class="keyword">function</span>(result)&#123;</div><div class="line">                      <span class="keyword">if</span>(result.code == 0)</div><div class="line">                          successCallBack(result.data, <span class="string">'#watertmpl'</span>);</div><div class="line">                  &#125;</div><div class="line">              &#125;);</div><div class="line">          &#125;</div><div class="line">      &#125;)</div></pre></td></tr></table></figure></p>
<p>从这里也大概可以看出代码的核心：</p>
<h3 id="1-获取列数-用container宽度除以设置的（列宽-列间隙）与设置的最小列数进行比较取最大；-这样保证了可以在window-resize时自动变化列数，同时避免过窄保证有基本的列数"><a href="#1-获取列数-用container宽度除以设置的（列宽-列间隙）与设置的最小列数进行比较取最大；-这样保证了可以在window-resize时自动变化列数，同时避免过窄保证有基本的列数" class="headerlink" title="1. 获取列数,用container宽度除以设置的（列宽+列间隙）与设置的最小列数进行比较取最大； 这样保证了可以在window resize时自动变化列数，同时避免过窄保证有基本的列数"></a>1. 获取列数,用container宽度除以设置的（列宽+列间隙）与设置的最小列数进行比较取最大； 这样保证了可以在window resize时自动变化列数，同时避免过窄保证有基本的列数</h3><h3 id="2-保存每一列的高度，记录最高高度列和最低高度列；在最低高度列中插入新的元素（设置position：absolute-left：index-colWidth-colGap-top-colsHeight-index-）-然后更新整个高度数组，并将容器高度设置为最高高度列的高度；"><a href="#2-保存每一列的高度，记录最高高度列和最低高度列；在最低高度列中插入新的元素（设置position：absolute-left：index-colWidth-colGap-top-colsHeight-index-）-然后更新整个高度数组，并将容器高度设置为最高高度列的高度；" class="headerlink" title="2. 保存每一列的高度，记录最高高度列和最低高度列；在最低高度列中插入新的元素（设置position：absolute; left：index*(colWidth+colGap); top: colsHeight[index]）; 然后更新整个高度数组，并将容器高度设置为最高高度列的高度；"></a>2. 保存每一列的高度，记录最高高度列和最低高度列；在最低高度列中插入新的元素（设置position：absolute; left：index*(colWidth+colGap); top: colsHeight[index]）; 然后更新整个高度数组，并将容器高度设置为最高高度列的高度；</h3><p>有以下几点值得思考:</p>
<h4 id="1-插入元素没有使用拼接字符串，而是采用doT模板引擎；这样是为了可扩展性，因为不知道在每个item内部dom结构，这个需要用户自己来填写；-限定定了容器id-”main-container”，单个item-class-”waterfall-item”"><a href="#1-插入元素没有使用拼接字符串，而是采用doT模板引擎；这样是为了可扩展性，因为不知道在每个item内部dom结构，这个需要用户自己来填写；-限定定了容器id-”main-container”，单个item-class-”waterfall-item”" class="headerlink" title="(1). 插入元素没有使用拼接字符串，而是采用doT模板引擎；这样是为了可扩展性，因为不知道在每个item内部dom结构，这个需要用户自己来填写；    限定定了容器id=”main-container”，单个item class=”waterfall-item”"></a>(1). 插入元素没有使用拼接字符串，而是采用doT模板引擎；这样是为了可扩展性，因为不知道在每个item内部dom结构，这个需要用户自己来填写；    限定定了容器id=”main-container”，单个item class=”waterfall-item”</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&lt;script id=<span class="string">"watertmpl"</span> <span class="built_in">type</span>=<span class="string">"text/x-dot-template"</span>&gt;</div><div class="line">       &lt;div class=<span class="string">"waterfall-item"</span>&gt;</div><div class="line">           &lt;img src=<span class="string">"&#123;&#123;= it.imgUrl&#125;&#125;"</span>/&gt;</div><div class="line">           &lt;p&gt;&#123;&#123;= it.briefIntro&#125;&#125;&lt;/p&gt;</div><div class="line">       &lt;/div&gt;</div><div class="line">   &lt;/script&gt;</div><div class="line">   &lt;div id=<span class="string">"main-container"</span>&gt;</div><div class="line">   &lt;/div&gt;</div></pre></td></tr></table></figure>
<h4 id="2-使用模板引擎之后在元素填充到dom之前，需要修改其style定义left和top值将元素插入到相应的列。因为采用了分批加载，每次获得的都是一组数组，所以要对数组数据进行分批处理。"><a href="#2-使用模板引擎之后在元素填充到dom之前，需要修改其style定义left和top值将元素插入到相应的列。因为采用了分批加载，每次获得的都是一组数组，所以要对数组数据进行分批处理。" class="headerlink" title="(2). 使用模板引擎之后在元素填充到dom之前，需要修改其style定义left和top值将元素插入到相应的列。因为采用了分批加载，每次获得的都是一组数组，所以要对数组数据进行分批处理。"></a>(2). 使用模板引擎之后在元素填充到dom之前，需要修改其style定义left和top值将元素插入到相应的列。因为采用了分批加载，每次获得的都是一组数组，所以要对数组数据进行分批处理。</h4><p>这里就出现了一个问题：<br><b style="color:red;">只有在每个元素插入到dom中之后才能获取它实际的高度，进而更新每个列的高度，进而进行下一个元素的插入计算，但如果item中含有图片，则在图片没有加载完之前获取的offsetHeight是不准确的，怎么办???</b><br>解决方法有两个：<br>    一.服务器端返回item中图片的高度。<br>    二.服务器端不支持，客户端在加载一张图片结束之后进行下一个元素的插入。<br>实际效果可想而知，明显第一个方法体验更好，性能更好。<br>但是我的插件这里采用的第二种方法，为了更加独立的完成这个效果：<br>代码如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">var loadingTag = (<span class="function"><span class="title">function</span></span>()&#123;              //串行渲染标识</div><div class="line">       var isLoading = <span class="literal">false</span>;</div><div class="line">       <span class="built_in">return</span>  <span class="keyword">function</span>(il)&#123;</div><div class="line">           <span class="keyword">if</span>(il != undefined)&#123;</div><div class="line">               isLoading = il;</div><div class="line">           &#125;</div><div class="line">           <span class="built_in">return</span> isLoading;</div><div class="line">       &#125;;</div><div class="line">   &#125;)();</div><div class="line"></div><div class="line">/**</div><div class="line">    * 每次加载一页数据之后，添加到dom中的函数。</div><div class="line">    * 此方法不能并行被调用，即一组数据还没有彻底填充完，另一组数据不能开始填充。这也是由图片高度未知导致的</div><div class="line">    * @param arr</div><div class="line">    * @param tmplId</div><div class="line">    */</div><div class="line">   <span class="keyword">function</span> addItems(arr, tmplSelector)&#123;</div><div class="line">       <span class="keyword">if</span>(!isArray(arr))</div><div class="line">           <span class="built_in">return</span>;</div><div class="line">       var waterTmpl = <span class="keyword">do</span>T.template(document.querySelector(tmplSelector).innerText);</div><div class="line">       addBundleItems(arr, 0, waterTmpl);</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="keyword">function</span> addBundleItems(arr, i, waterTmpl)&#123;</div><div class="line">       <span class="keyword">if</span>(i &gt;= arr.length)&#123;</div><div class="line">           loadingTag(<span class="literal">false</span>);</div><div class="line">           <span class="built_in">return</span>;</div><div class="line">       &#125;</div><div class="line">       var newItemText = waterTmpl(arr[i]);</div><div class="line">       var posItemText = calculatePosition(newItemText);</div><div class="line">       container.innerHTML += posItemText;</div><div class="line">       var imgs = document.querySelectorAll(<span class="string">'.waterfall-item img'</span>);</div><div class="line">       imgs[imgs.length-1].onload = <span class="function"><span class="title">function</span></span>()&#123;</div><div class="line">           updateHeight(this.offsetHeight + 30);    //在服务器没有返回图片高度的情况下。之后自己计算高度，等到图片加载完成之后才能确切高度；进行下一个item插入</div><div class="line">           i++;</div><div class="line">           addBundleItems(arr, i, waterTmpl);</div><div class="line">       &#125;</div><div class="line">   &#125;;</div></pre></td></tr></table></figure>
<p>由于存在onload事件，所以一定会用到递归调用。另外这个方法是不能并行被调用的，即必须在一批数组全部填充到dom中之后才能开始填充下一批数据。这也是由于图片加载完成之前高度未知决定的。所以这里使用了一个标记位。isLoading放到闭包中，避免被误修改。</p>
<h4 id="3-calculatePosition函数用于向doT渲染出来的html字符串中插入left和top属性值。之后将修改的字符串返回填充到dom中"><a href="#3-calculatePosition函数用于向doT渲染出来的html字符串中插入left和top属性值。之后将修改的字符串返回填充到dom中" class="headerlink" title="(3). calculatePosition函数用于向doT渲染出来的html字符串中插入left和top属性值。之后将修改的字符串返回填充到dom中"></a>(3). calculatePosition函数用于向doT渲染出来的html字符串中插入left和top属性值。之后将修改的字符串返回填充到dom中</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line">    *将html字符串中加入left和top值</div><div class="line">    * @param newItemText</div><div class="line">    */</div><div class="line">   <span class="keyword">function</span> calculatePosition(newItemText)&#123;</div><div class="line">       var leftStyle = /[^&lt;]*(style\s*=\s*<span class="string">").*waterfall-item[^&gt;]*/ig;</span></div><div class="line">       var rightStyle = /[^&lt;]*waterfall-item.*(style\s*=\s*")[^&gt;]*/ig;</div><div class="line">       var leftResult = leftStyle.exec(newItemText);           //匹配结果：[<span class="string">" div class="</span>waterfall-item<span class="string">" style  =  "</span><span class="string">" "</span>, <span class="string">"style  =  "</span><span class="string">"]</span></div><div class="line">       var rightResult = rightStyle.exec(newItemText);         //匹配结果：[" div class=<span class="string">"waterfall-item"</span> style  =  <span class="string">""</span> <span class="string">", "</span>style  =  <span class="string">""</span>]</div><div class="line">       var leftPos = minIndex * (configs.colWidth + configs.colGap);</div><div class="line">       var topPos = colsHeight[minIndex] + configs.rowGap;</div><div class="line"></div><div class="line">       <span class="keyword">if</span>(!!leftResult &amp;&amp; leftResult.length != 0)&#123;             //style在class左侧</div><div class="line"></div><div class="line">           newItemText = newItemText.replace(leftResult[1].toString(), leftResult[1].toString() + <span class="string">"left:"</span> + leftPos + <span class="string">"px; top:"</span> + topPos + <span class="string">"px; width:"</span> + configs.colWidth + <span class="string">"px;"</span>);</div><div class="line"></div><div class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span>(!!rightResult &amp;&amp; rightResult.length != 0)&#123;    //style在class右侧</div><div class="line"></div><div class="line">           newItemText = newItemText.replace(rightResult[1].toString(), rightResult[1].toString() + <span class="string">"left:"</span> + leftPos + <span class="string">"px; top:"</span> + topPos + <span class="string">"px; width:"</span> + configs.colWidth + <span class="string">"px;"</span>);</div><div class="line"></div><div class="line">       &#125; <span class="keyword">else</span> &#123;                                                //没有style</div><div class="line"></div><div class="line">           var temp = newItemText.match(/[^&lt;]*waterfall-item[^&gt;]*/i)[0];</div><div class="line">           newItemText = newItemText.replace(temp.toString(), temp.toString() + <span class="string">'style = "top:'</span> + topPos + <span class="string">'px; left:'</span> + leftPos + <span class="string">'px; width:'</span> + configs.colWidth + <span class="string">'px;"'</span>);</div><div class="line"></div><div class="line">       &#125;</div><div class="line">       <span class="built_in">return</span> newItemText;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>分为</p>
<ol>
<li>class=”waterfall-item” style=””</li>
<li>style=”” class=”waterfall-item”</li>
<li>class=”waterfall-item”<br>三种情况进行正则匹配，之后修改style属性值添加left和top属性</li>
</ol>
<h4 id="4-updateHeight方法用于在填充dom之后，同步每一列的高度数据。提供给下一次的calculatePosition方法执行调用"><a href="#4-updateHeight方法用于在填充dom之后，同步每一列的高度数据。提供给下一次的calculatePosition方法执行调用" class="headerlink" title="(4). updateHeight方法用于在填充dom之后，同步每一列的高度数据。提供给下一次的calculatePosition方法执行调用"></a>(4). updateHeight方法用于在填充dom之后，同步每一列的高度数据。提供给下一次的calculatePosition方法执行调用</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line">    * 更新列高度数组，和最小高度列的下标</div><div class="line">    * @param newItemHeight</div><div class="line">    */</div><div class="line">   <span class="keyword">function</span> updateHeight(newItemHeight)&#123;</div><div class="line">       newItemHeight = newItemHeight || 0;</div><div class="line">       colsHeight[minIndex] += newItemHeight;</div><div class="line">       <span class="keyword">for</span>(var i <span class="keyword">in</span> colsHeight)&#123;</div><div class="line">           colsHeight = colsHeight;   //没有初始化的进行初始化</div><div class="line">           <span class="keyword">if</span>(colsHeight[i] &lt; colsHeight[minIndex])&#123;</div><div class="line">               minIndex = i;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">if</span>(colsHeight[i] &gt; colsHeight[maxIndex])&#123;</div><div class="line">               maxIndex = i;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       container.style.height = colsHeight[maxIndex] + <span class="string">"px"</span>;      //更改容器高度为所有列中最大</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<h3 id="3-设置window-onresize-动态改变列数"><a href="#3-设置window-onresize-动态改变列数" class="headerlink" title="3. 设置window.onresize,动态改变列数"></a>3. 设置window.onresize,动态改变列数</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line">    * 窗口变化时，动态改变已有元素排列，只对已有元素</div><div class="line">    */</div><div class="line">   <span class="keyword">function</span> <span class="function"><span class="title">reflow</span></span>()&#123;</div><div class="line">       colNum = Math.max(parseInt(container.offsetWidth/(configs.colWidth+configs.colGap)), configs.minColumn);    //列数</div><div class="line">       colsHeight.length = 0;</div><div class="line">       minIndex = 0;</div><div class="line">       maxIndex = 0;</div><div class="line">       //初始化高度数组都为0</div><div class="line">       <span class="keyword">for</span>(var i=0; i&lt;colNum; i++)&#123;</div><div class="line">           colsHeight[i] = 0;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       var items = document.querySelectorAll(<span class="string">'.waterfall-item'</span>);</div><div class="line">       Array.prototype.forEach.call(items, <span class="keyword">function</span>(item, i)&#123;</div><div class="line">           var leftPos = minIndex * (configs.colWidth + configs.colGap);</div><div class="line">           var topPos = colsHeight[minIndex] + configs.rowGap;</div><div class="line"></div><div class="line">           item.style.left = leftPos + <span class="string">"px"</span>;</div><div class="line">           item.style.top = topPos + <span class="string">"px"</span>;</div><div class="line">           updateHeight(item.offsetHeight);</div><div class="line">       &#125;);</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   var timer;</div><div class="line">   window.onresize = <span class="function"><span class="title">function</span></span>()&#123;</div><div class="line">       clearTimeout(timer);</div><div class="line">       timer = <span class="built_in">set</span>Timeout(<span class="function"><span class="title">function</span></span>()&#123;</div><div class="line">           reflow();</div><div class="line">       &#125;, 300);</div><div class="line">   &#125;;</div></pre></td></tr></table></figure>
<p>resize时使用setTimeout优化性能；对已有元素重排</p>
<h3 id="4-设置window-onscroll来控制下一页加载时机"><a href="#4-设置window-onscroll来控制下一页加载时机" class="headerlink" title="4. 设置window.onscroll来控制下一页加载时机"></a>4. 设置window.onscroll来控制下一页加载时机</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line">    * 滚动条是html.clientHeight &lt; html.offsetHeight   所以是由于html过长导致的滚动条出现</div><div class="line">    * @param e</div><div class="line">    */</div><div class="line">   window.onscroll = <span class="keyword">function</span>(e)&#123;</div><div class="line">       var t = document.documentElement.scrollTop || document.body.scrollTop;</div><div class="line">       <span class="keyword">if</span>(!loadingTag() &amp;&amp; t + document.documentElement.clientHeight &gt; container.offsetHeight - configs.loadDistance)&#123;</div><div class="line">           loadingTag(<span class="literal">true</span>);</div><div class="line">           configs.load(addItems);</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>普通html页面由于过长产生的滚动条是由于html元素太长在window中显示出的滚动条； </p>
<h3 id="5-设置首屏加载。注意临界条件的判断"><a href="#5-设置首屏加载。注意临界条件的判断" class="headerlink" title="5. 设置首屏加载。注意临界条件的判断"></a>5. 设置首屏加载。注意临界条件的判断</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line">   * 加载第一屏</div><div class="line">   */</div><div class="line">  var firstPageInterval;</div><div class="line">  firstPageInterval = <span class="built_in">set</span>Interval(<span class="function"><span class="title">function</span></span>()&#123;</div><div class="line">      <span class="keyword">if</span>(!loadingTag() &amp;&amp; container.offsetHeight &lt; document.documentElement.clientHeight) &#123;</div><div class="line">          loadingTag(<span class="literal">true</span>);</div><div class="line">          configs.load(addItems);</div><div class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span>(container.offsetHeight &gt; document.documentElement.clientHeight)&#123;</div><div class="line">          clearInterval(firstPageInterval);</div><div class="line">      &#125;</div><div class="line">  &#125;, 200);</div></pre></td></tr></table></figure>
<p>以下是最终效果<br><img src="http://i11.tietuku.com/819e18f3fbe4ec08.png"><br><img src="http://i11.tietuku.com/4bd7ecf0cb342c7c.png"><br><img src="http://i11.tietuku.com/d2f0e2752f098c43.png"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/02/14/20160214/" data-id="ciu72xg8g000cecdlb7hlg78e" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/瀑布流/">瀑布流</a></li></ul>

    </footer>
  </div>
  
</article>


  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/3/">Next &raquo;</a>
    </nav>
  
</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/js/">js</a><span class="category-list-count">4</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/js/单页应用中的按需加载/">单页应用中的按需加载</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/js/算法/">算法</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/js/算法/排序算法/">排序算法</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/js/网络/">网络</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/js/网络/爬虫/">爬虫</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/js/进阶/">进阶</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/基础/">基础</a><span class="category-list-count">4</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/基础/css/">css</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/基础/js/">js</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/进阶/">进阶</a><span class="category-list-count">5</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/进阶/css/">css</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/进阶/js/">js</a><span class="category-list-count">4</span></li></ul></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/3d动画/">3d动画</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/angular/">angular</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/canvas/">canvas</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/clientHeight/">clientHeight</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/clientLeft/">clientLeft</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/clientTop/">clientTop</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/js/">js</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/offsetHeight/">offsetHeight</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/offsetLeft/">offsetLeft</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/offsetTop/">offsetTop</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/scrollHeight/">scrollHeight</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/scrollLeft/">scrollLeft</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/scrollTop/">scrollTop</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/spa/">spa</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/严格模式/">严格模式</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/切图/">切图</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/动画/">动画</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/瀑布流/">瀑布流</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/点击/">点击</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/盒子模型/">盒子模型</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/移动/">移动</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/算法/">算法</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/路由/">路由</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/3d动画/" style="font-size: 10px;">3d动画</a> <a href="/tags/angular/" style="font-size: 10px;">angular</a> <a href="/tags/canvas/" style="font-size: 10px;">canvas</a> <a href="/tags/clientHeight/" style="font-size: 10px;">clientHeight</a> <a href="/tags/clientLeft/" style="font-size: 10px;">clientLeft</a> <a href="/tags/clientTop/" style="font-size: 10px;">clientTop</a> <a href="/tags/js/" style="font-size: 20px;">js</a> <a href="/tags/offsetHeight/" style="font-size: 10px;">offsetHeight</a> <a href="/tags/offsetLeft/" style="font-size: 10px;">offsetLeft</a> <a href="/tags/offsetTop/" style="font-size: 10px;">offsetTop</a> <a href="/tags/scrollHeight/" style="font-size: 10px;">scrollHeight</a> <a href="/tags/scrollLeft/" style="font-size: 10px;">scrollLeft</a> <a href="/tags/scrollTop/" style="font-size: 10px;">scrollTop</a> <a href="/tags/spa/" style="font-size: 10px;">spa</a> <a href="/tags/严格模式/" style="font-size: 10px;">严格模式</a> <a href="/tags/切图/" style="font-size: 10px;">切图</a> <a href="/tags/动画/" style="font-size: 10px;">动画</a> <a href="/tags/瀑布流/" style="font-size: 10px;">瀑布流</a> <a href="/tags/点击/" style="font-size: 10px;">点击</a> <a href="/tags/盒子模型/" style="font-size: 10px;">盒子模型</a> <a href="/tags/移动/" style="font-size: 10px;">移动</a> <a href="/tags/算法/" style="font-size: 15px;">算法</a> <a href="/tags/路由/" style="font-size: 10px;">路由</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">October 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">May 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">February 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">January 2016</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">December 2015</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">November 2015</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2016/10/12/20161012/">node实现爬虫抓取淘宝商品图文详情</a>
          </li>
        
          <li>
            <a href="/2016/07/07/20160707/">几种基本排序算法的理解</a>
          </li>
        
          <li>
            <a href="/2016/05/30/20160530/">单页应用中的按需加载</a>
          </li>
        
          <li>
            <a href="/2016/04/02/20160402/">js实现图片切图</a>
          </li>
        
          <li>
            <a href="/2016/02/15/20160215/">offsetHeight,clientHeight和scrollHeight的区别</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 卓凌云<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>